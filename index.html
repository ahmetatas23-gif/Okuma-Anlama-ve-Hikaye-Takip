<!DOCTYPE html>
<html lang="tr">
  <head>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Okuma Anlama Test Sistemi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Supabase JavaScript SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Supabase Configuration -->
    <script src="supabase-config.js"></script>
    <style>
      @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
      body {
        font-family: 'Inter', sans-serif;
      }
      .fade-in {
        animation: fadeIn 0.3s ease-in;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .success-animation {
        animation: successPulse 0.6s ease-out;
      }
      @keyframes successPulse {
        0% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.05);
        }
        100% {
          transform: scale(1);
        }
      }
      @keyframes shake {
        0%,
        100% {
          transform: translateX(0);
        }
        25% {
          transform: translateX(-5px);
        }
        75% {
          transform: translateX(5px);
        }
      }
      .progress-bar {
        transition: width 0.3s ease;
      }
      .question-card {
        transition: all 0.3s ease;
      }
      .question-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
      }
    </style>
  </head>
  <body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <!-- Navigation -->
    <nav class="bg-white shadow-lg border-b-4 border-blue-500">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between h-16">
          <div class="flex items-center">
            <div class="flex-shrink-0">
              <h1 class="text-2xl font-bold text-blue-600">
                ğŸ“š Dijital Okuma Anlama ve Hikaye Takip Platformu
              </h1>
            </div>
          </div>
        </div>
      </div>
    </nav>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
      <!-- User Selection Screen -->
      <div id="userSelection" class="fade-in">
        <div class="text-center mb-12">
          <h2 class="text-4xl font-bold text-gray-800 mb-4">HoÅŸ Geldiniz!</h2>
          <p class="text-xl text-gray-600">LÃ¼tfen kullanÄ±cÄ± tipinizi seÃ§in</p>
        </div>

        <div class="grid md:grid-cols-2 gap-8 max-w-4xl mx-auto">
          <div
            class="bg-white rounded-xl shadow-lg p-8 text-center hover:shadow-xl transition-shadow cursor-pointer"
            onclick="showTeacherPanel()"
          >
            <div class="text-6xl mb-4">ğŸ‘¨â€ğŸ«</div>
            <h3 class="text-2xl font-bold text-gray-800 mb-2">Ã–ÄŸretmen</h3>
            <p class="text-gray-600">
              Metin ekle, test oluÅŸtur, Ã¶ÄŸrenci performansÄ±nÄ± takip et
            </p>
          </div>

          <div
            class="bg-white rounded-xl shadow-lg p-8 text-center hover:shadow-xl transition-shadow cursor-pointer"
            onclick="showStudentPanel()"
          >
            <div class="text-6xl mb-4">ğŸ‘¨â€ğŸ“ğŸ‘©â€ğŸ“</div>
            <h3 class="text-2xl font-bold text-gray-800 mb-2">Ã–ÄŸrenci</h3>
            <p class="text-gray-600">
              Atanan testleri Ã§Ã¶z, performansÄ±nÄ± gÃ¶rÃ¼ntÃ¼le
            </p>
          </div>
        </div>
      </div>

      <!-- Teacher Panel -->
      <div id="teacherPanel" class="hidden">
        <div class="flex justify-between items-center mb-8">
          <div>
            <h2 class="text-3xl font-bold text-gray-800">ğŸ‘¨â€ğŸ« Ã–ÄŸretmen Paneli</h2>
            <p class="text-sm text-gray-600 mt-1">
              HoÅŸ geldiniz,
              <span class="font-medium text-blue-600">Ahmet ATAS</span>
            </p>
          </div>
          <div class="flex gap-3">
            <button
              onclick="showSupabaseConfig()"
              class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg font-medium transition-colors"
            >
              ğŸ”§ Supabase AyarlarÄ±
            </button>
            <button
              onclick="showDataManagement()"
              class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg font-medium transition-colors"
            >
              ğŸ’¾ Veri YÃ¶netimi
            </button>
            <button
              onclick="teacherLogout()"
              class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg font-medium transition-colors"
            >
              ğŸšª GÃ¼venli Ã‡Ä±kÄ±ÅŸ
            </button>
            <button
              onclick="showUserSelection()"
              class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg"
            >
              Geri DÃ¶n
            </button>
          </div>
        </div>

        <!-- Teacher Navigation -->
        <div class="bg-white rounded-lg shadow-md mb-6">
          <div class="flex border-b">
            <button
              onclick="showTextInput()"
              class="teacher-tab px-6 py-3 font-medium text-blue-600 border-b-2 border-blue-600"
            >
              Metin & Test OluÅŸtur
            </button>
            <button
              onclick="showStudentManagement()"
              class="teacher-tab px-6 py-3 font-medium text-gray-500 hover:text-blue-600"
            >
              Ã–ÄŸrenci YÃ¶netimi
            </button>
            <button
              onclick="showResults()"
              class="teacher-tab px-6 py-3 font-medium text-gray-500 hover:text-blue-600"
            >
              SonuÃ§lar
            </button>
          </div>
        </div>

        <!-- Text Input Module -->
        <div id="textInputModule" class="bg-white rounded-lg shadow-md p-6">
          <h3 class="text-xl font-bold mb-4">ğŸ“ Metin GiriÅŸ ve Test Ãœretimi</h3>

          <div class="mb-6">
            <label class="block text-sm font-medium text-gray-700 mb-2"
              >Metin BaÅŸlÄ±ÄŸÄ±</label
            >
            <input
              type="text"
              id="textTitle"
              class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              placeholder="Test baÅŸlÄ±ÄŸÄ±nÄ± girin..."
            />
          </div>

          <div class="mb-6">
            <label class="block text-sm font-medium text-gray-700 mb-2"
              >Metin Ä°Ã§eriÄŸi</label
            >
            <textarea
              id="textContent"
              rows="8"
              class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              placeholder="Metni buraya yapÄ±ÅŸtÄ±rÄ±n veya yazÄ±n..."
            ></textarea>
          </div>

          <div class="mb-6">
            <label class="block text-sm font-medium text-gray-700 mb-2"
              >ğŸ“– Metin GÃ¶rÃ¼ntÃ¼leme AyarlarÄ±</label
            >
            <div class="bg-blue-50 p-4 rounded-lg space-y-3">
              <div class="text-sm text-blue-800 font-medium mb-3">
                Ã–ÄŸrenci teste baÅŸladÄ±ÄŸÄ±nda metin nasÄ±l gÃ¶sterilsin?
              </div>

              <label class="flex items-start gap-3 cursor-pointer">
                <input
                  type="radio"
                  name="textDisplay"
                  value="withQuestions"
                  checked
                  class="mt-1"
                  onchange="updateTextDisplayInfo()"
                />
                <div>
                  <div class="font-medium text-gray-800">
                    ğŸ“„ Her Soruyla Birlikte Metni GÃ¶ster
                  </div>
                  <div class="text-sm text-gray-600">
                    Klasik mod - Her soru sayfasÄ±nda metin gÃ¶rÃ¼nÃ¼r (VarsayÄ±lan)
                  </div>
                </div>
              </label>

              <label class="flex items-start gap-3 cursor-pointer">
                <input
                  type="radio"
                  name="textDisplay"
                  value="firstPageOnly"
                  class="mt-1"
                  onchange="updateTextDisplayInfo()"
                />
                <div>
                  <div class="font-medium text-gray-800">
                    ğŸ“‹ Sadece Ä°lk Sayfada Metni GÃ¶ster
                  </div>
                  <div class="text-sm text-gray-600">
                    Ã–ÄŸrenci Ã¶nce metni okur, sonra sorulara geÃ§er
                  </div>
                </div>
              </label>

              <label class="flex items-start gap-3 cursor-pointer">
                <input
                  type="radio"
                  name="textDisplay"
                  value="noText"
                  class="mt-1"
                  onchange="updateTextDisplayInfo()"
                />
                <div>
                  <div class="font-medium text-gray-800">
                    ğŸš« Metni HiÃ§ GÃ¶sterme, DoÄŸrudan Sorulara GeÃ§
                  </div>
                  <div class="text-sm text-gray-600">
                    Metin hiÃ§ gÃ¶sterilmez - Sadece sorular gÃ¶rÃ¼nÃ¼r
                  </div>
                </div>
              </label>

              <div
                id="textDisplayInfo"
                class="mt-3 p-3 bg-white rounded border-l-4 border-blue-500"
              >
                <div class="text-sm text-gray-700">
                  <strong>ğŸ“„ SeÃ§ili Mod:</strong> Her soruyla birlikte metin
                  gÃ¶sterilecek. Bu klasik okuma-anlama test formatÄ±dÄ±r.
                </div>
              </div>
            </div>
          </div>

          <div class="flex gap-4 mb-6">
            <button
              onclick="generateTest()"
              class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-lg font-medium"
            >
              ğŸ¤– Otomatik Test OluÅŸtur
            </button>
            <button
              onclick="showImportOptions()"
              class="bg-green-500 hover:bg-green-600 text-white px-6 py-3 rounded-lg font-medium"
            >
              ğŸ“ Ä°Ã§e Aktar
            </button>
            <button
              onclick="exportTest()"
              class="bg-purple-500 hover:bg-purple-600 text-white px-6 py-3 rounded-lg font-medium"
            >
              ğŸ’¾ DÄ±ÅŸa Aktar
            </button>
          </div>

          <!-- Generated Test Preview -->
          <div id="testPreview" class="hidden">
            <h4 class="text-lg font-bold mb-4">
              ğŸ“‹ OluÅŸturulan Test Ã–nizlemesi
            </h4>
            <div id="previewContent" class="space-y-4"></div>
            <div class="mt-6 flex gap-4">
              <button
                onclick="saveTest()"
                class="bg-green-500 hover:bg-green-600 text-white px-6 py-3 rounded-lg font-medium"
              >
                âœ… Testi Kaydet
              </button>
              <button
                onclick="editTest()"
                class="bg-yellow-500 hover:bg-yellow-600 text-white px-6 py-3 rounded-lg font-medium"
              >
                âœï¸ DÃ¼zenle
              </button>
            </div>
          </div>
        </div>

        <!-- Student Management -->
        <div
          id="studentManagement"
          class="hidden bg-white rounded-lg shadow-md p-6"
        >
          <h3 class="text-xl font-bold mb-4">ğŸ‘¥ Ã–ÄŸrenci YÃ¶netimi</h3>

          <div class="grid lg:grid-cols-3 gap-6">
            <!-- Student List -->
            <div class="lg:col-span-2">
              <div class="flex justify-between items-center mb-3">
                <h4 class="font-bold">KayÄ±tlÄ± Ã–ÄŸrenciler</h4>
                <div class="flex gap-2">
                  <button
                    onclick="showBulkImport()"
                    class="bg-purple-500 hover:bg-purple-600 text-white px-3 py-1 rounded text-sm"
                  >
                    ğŸ“¤ Toplu Ekle
                  </button>
                  <button
                    onclick="exportStudents()"
                    class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded text-sm"
                  >
                    ğŸ“„ DÄ±ÅŸa Aktar
                  </button>
                </div>
              </div>
              <div
                id="studentList"
                class="space-y-2 max-h-80 overflow-y-auto border rounded-lg p-3"
              >
                <!-- Students will be populated here -->
              </div>

              <!-- Individual Student Add Form -->
              <div class="mt-4 p-4 bg-gray-50 rounded-lg">
                <h5 class="font-bold mb-3">ğŸ‘¤ Yeni Ã–ÄŸrenci Ekle</h5>
                <div class="grid md:grid-cols-2 gap-3">
                  <input
                    type="text"
                    id="newStudentName"
                    placeholder="Ad"
                    class="p-2 border rounded-lg"
                  />
                  <input
                    type="text"
                    id="newStudentSurname"
                    placeholder="Soyad"
                    class="p-2 border rounded-lg"
                  />
                  <input
                    type="text"
                    id="newStudentTC"
                    placeholder="TC Kimlik No (11 haneli)"
                    maxlength="11"
                    class="p-2 border rounded-lg"
                  />
                  <input
                    type="text"
                    id="newStudentNumber"
                    placeholder="Ã–ÄŸrenci No"
                    class="p-2 border rounded-lg"
                  />
                </div>
                <button
                  onclick="addStudent()"
                  class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg w-full mt-3"
                >
                  â• Ã–ÄŸrenci Ekle
                </button>
              </div>
            </div>

            <!-- Test Assignment -->
            <div>
              <h4 class="font-bold mb-3">ğŸ“‹ Test Atama</h4>
              <div class="space-y-3">
                <select id="testSelect" class="w-full p-2 border rounded-lg">
                  <option value="">Test seÃ§in...</option>
                </select>
                <select id="studentSelect" class="w-full p-2 border rounded-lg">
                  <option value="">Ã–ÄŸrenci seÃ§in...</option>
                </select>
                <button
                  onclick="assignTest()"
                  class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg w-full"
                >
                  ğŸ¯ Test Ata
                </button>
              </div>

              <!-- Quick Stats -->
              <div class="mt-6 p-3 bg-blue-50 rounded-lg">
                <h5 class="font-bold text-blue-800 mb-2">ğŸ“Š Ä°statistikler</h5>
                <div class="text-sm text-blue-700">
                  <div>Toplam Ã–ÄŸrenci: <span id="totalStudents">0</span></div>
                  <div>Toplam Test: <span id="totalTests">0</span></div>
                  <div>Aktif Atama: <span id="activeAssignments">0</span></div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Results Panel -->
        <div id="resultsPanel" class="hidden bg-white rounded-lg shadow-md p-6">
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-bold">ğŸ“Š Test SonuÃ§larÄ±</h3>
            <div class="flex gap-3 items-center">
              <select
                id="studentFilter"
                onchange="filterResultsByStudent()"
                class="p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              >
                <option value="">TÃ¼m Ã–ÄŸrenciler (Son 10)</option>
              </select>
              <button
                onclick="refreshResults()"
                class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg font-medium transition-colors"
              >
                ğŸ”„ Paneli Yenile
              </button>
            </div>
          </div>
          <div id="resultsContent">
            <!-- Results will be populated here -->
          </div>
        </div>
      </div>

      <!-- Student Panel -->
      <div id="studentPanel" class="hidden">
        <div class="flex justify-between items-center mb-8">
          <h2 class="text-3xl font-bold text-gray-800">ğŸ‘¨â€ğŸ“ğŸ‘©â€ğŸ“ Ã–ÄŸrenci Paneli</h2>
          <div class="flex gap-3">
            <button
              onclick="goToMyPage()"
              class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg"
            >
              ğŸ‘¤ Sayfam
            </button>
            <button
              onclick="showUserSelection()"
              class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg"
            >
              Ana Sayfaya DÃ¶n
            </button>
          </div>
        </div>

        <!-- Student Login -->
        <div
          id="studentLogin"
          class="bg-white rounded-lg shadow-md p-6 max-w-md mx-auto"
        >
          <h3 class="text-xl font-bold mb-4 text-center">
            ğŸ‘¨â€ğŸ“ğŸ‘©â€ğŸ“ Ã–ÄŸrenci GiriÅŸi
          </h3>
          <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-2"
              >TC Kimlik NumarasÄ±</label
            >
            <input
              type="text"
              id="studentTCInput"
              placeholder="TC Kimlik numaranÄ±zÄ± girin"
              maxlength="11"
              class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500"
            />
          </div>
          <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-2"
              >Ã–ÄŸrenci NumarasÄ±</label
            >
            <input
              type="text"
              id="studentNumberInput"
              placeholder="Ã–ÄŸrenci numaranÄ±zÄ± girin"
              class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500"
            />
          </div>
          <button
            onclick="studentLogin()"
            class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-lg w-full font-medium"
          >
            ğŸ” GiriÅŸ Yap
          </button>
          <div class="mt-4 p-3 bg-blue-50 rounded-lg text-sm text-blue-700">
            <strong>ğŸ’¡ Bilgi:</strong> TC kimlik numaranÄ±z kullanÄ±cÄ± adÄ±nÄ±z,
            Ã¶ÄŸrenci numaranÄ±z ise ÅŸifrenizdir.
          </div>
        </div>

        <!-- Student Dashboard -->
        <div id="studentDashboard" class="hidden">
          <!-- Student Profile Card -->
          <div
            class="bg-gradient-to-r from-blue-500 to-purple-600 rounded-lg shadow-md p-6 mb-6 text-white"
          >
            <div class="flex justify-between items-start mb-4">
              <div>
                <h3 class="text-2xl font-bold">
                  HoÅŸ geldin, <span id="currentStudentName"></span>! ğŸ‰
                </h3>
                <div id="studentStats" class="mt-2 text-blue-100">
                  <!-- Student stats will appear here -->
                </div>
              </div>
              <div class="flex gap-3">
                <button
                  onclick="refreshStudentPanel()"
                  class="bg-white bg-opacity-20 hover:bg-opacity-30 text-white px-4 py-2 rounded-lg font-medium transition-colors"
                >
                  ğŸ”„ Paneli Yenile
                </button>
                <button
                  onclick="studentLogout()"
                  class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg font-medium transition-colors"
                >
                  ğŸšª Ã‡Ä±kÄ±ÅŸ Yap
                </button>
              </div>
            </div>

            <!-- Badges Display -->
            <div id="studentBadges" class="mb-4">
              <!-- Badges will appear here -->
            </div>
          </div>

          <!-- Tests Section -->
          <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h4 class="text-lg font-bold mb-4">ğŸ“‹ Testlerim</h4>
            <div id="assignedTests" class="space-y-4">
              <!-- Assigned tests will appear here -->
            </div>
          </div>
        </div>

        <!-- Text First Page (for firstPageOnly mode) -->
        <div id="textFirstPage" class="hidden">
          <div class="bg-white rounded-lg shadow-md p-6">
            <div class="text-center mb-6">
              <h3 id="textFirstPageTitle" class="text-2xl font-bold mb-2"></h3>
              <div class="bg-blue-50 p-3 rounded-lg">
                <div
                  class="flex items-center justify-center gap-2 text-blue-800"
                >
                  <span class="text-lg">ğŸ“‹</span>
                  <span class="font-medium"
                    >Ã–nce metni okuyun, sonra sorulara geÃ§in</span
                  >
                </div>
              </div>
            </div>

            <!-- Text Content with Font Controls -->
            <div class="bg-gray-50 rounded-lg mb-6 max-h-96 overflow-y-auto">
              <div class="flex justify-between items-center p-4 pb-2">
                <h4 class="font-bold text-gray-700">ğŸ“– Okuma Metni</h4>
                <!-- Font Size Controls for Text -->
                <div
                  class="flex items-center gap-2 bg-white rounded-lg px-3 py-2 shadow-sm"
                >
                  <span class="text-sm text-gray-600">Metin Boyutu:</span>
                  <button
                    onclick="decreaseTextFontSize()"
                    class="bg-red-500 hover:bg-red-600 text-white w-8 h-8 rounded-full flex items-center justify-center font-bold text-lg transition-colors"
                    title="Metin boyutunu kÃ¼Ã§Ã¼lt"
                  >
                    -
                  </button>
                  <span
                    id="textFirstPageFontSizeDisplay"
                    class="text-sm font-medium text-gray-700 min-w-[3rem] text-center"
                    >16px</span
                  >
                  <button
                    onclick="increaseTextFontSize()"
                    class="bg-green-500 hover:bg-green-600 text-white w-8 h-8 rounded-full flex items-center justify-center font-bold text-lg transition-colors"
                    title="Metin boyutunu bÃ¼yÃ¼t"
                  >
                    +
                  </button>
                  <button
                    onclick="resetTextFontSize()"
                    class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-xs transition-colors"
                    title="VarsayÄ±lan boyuta sÄ±fÄ±rla"
                  >
                    SÄ±fÄ±rla
                  </button>
                </div>
              </div>
              <div
                id="textFirstPageContent"
                class="p-6 pt-2 text-lg leading-relaxed"
                style="font-size: 16px; line-height: 1.6"
              >
                <!-- Text content will be displayed here -->
              </div>
            </div>

            <!-- Reading Instructions -->
            <div
              class="bg-yellow-50 p-4 rounded-lg mb-6 border-l-4 border-yellow-400"
            >
              <div class="flex items-start gap-2">
                <span class="text-yellow-600 text-lg">ğŸ’¡</span>
                <div class="text-yellow-800">
                  <div class="font-medium mb-1">Okuma TalimatlarÄ±:</div>
                  <ul class="text-sm space-y-1">
                    <li>â€¢ Metni dikkatli bir ÅŸekilde okuyun</li>
                    <li>â€¢ Ã–nemli detaylarÄ± not alabilirsiniz</li>
                    <li>
                      â€¢ HazÄ±r olduÄŸunuzda "Sorulara GeÃ§" butonuna tÄ±klayÄ±n
                    </li>
                    <li>
                      â€¢ Sorular baÅŸladÄ±ktan sonra metni tekrar gÃ¶remeyeceksiniz
                    </li>
                  </ul>
                </div>
              </div>
            </div>

            <!-- Navigation -->
            <div class="text-center">
              <button
                onclick="proceedToQuestions()"
                class="bg-green-500 hover:bg-green-600 text-white px-8 py-3 rounded-lg font-medium text-lg"
              >
                ğŸ“ Sorulara GeÃ§
              </button>
            </div>
          </div>
        </div>

        <!-- Test Taking Interface -->
        <div id="testInterface" class="hidden">
          <div class="bg-white rounded-lg shadow-md p-6">
            <div class="flex justify-between items-center mb-6">
              <h3 id="testTitle" class="text-2xl font-bold"></h3>
              <div class="flex items-center gap-4">
                <!-- Question Timer -->
                <div
                  id="questionTimerDisplay"
                  class="flex items-center gap-2 bg-red-50 border-2 border-red-200 rounded-lg px-4 py-2"
                >
                  <span class="text-red-600 text-lg">â°</span>
                  <div class="text-center">
                    <div class="text-xs text-red-600 font-medium">
                      Kalan SÃ¼re
                    </div>
                    <div id="timerText" class="text-lg font-bold text-red-700">
                      2:00
                    </div>
                  </div>
                </div>
                <!-- Font Size Controls -->
                <div
                  class="flex items-center gap-2 bg-gray-100 rounded-lg px-3 py-2"
                >
                  <span class="text-sm text-gray-600">YazÄ± Boyutu:</span>
                  <button
                    onclick="decreaseFontSize()"
                    class="bg-red-500 hover:bg-red-600 text-white w-8 h-8 rounded-full flex items-center justify-center font-bold text-lg transition-colors"
                    title="YazÄ± boyutunu kÃ¼Ã§Ã¼lt"
                  >
                    -
                  </button>
                  <span
                    id="fontSizeDisplay"
                    class="text-sm font-medium text-gray-700 min-w-[3rem] text-center"
                    >16px</span
                  >
                  <button
                    onclick="increaseFontSize()"
                    class="bg-green-500 hover:bg-green-600 text-white w-8 h-8 rounded-full flex items-center justify-center font-bold text-lg transition-colors"
                    title="YazÄ± boyutunu bÃ¼yÃ¼t"
                  >
                    +
                  </button>
                  <button
                    onclick="resetFontSize()"
                    class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-xs transition-colors"
                    title="VarsayÄ±lan boyuta sÄ±fÄ±rla"
                  >
                    SÄ±fÄ±rla
                  </button>
                </div>
                <div class="text-sm text-gray-600">
                  Soru <span id="currentQuestion">1</span> /
                  <span id="totalQuestions">20</span>
                </div>
              </div>
            </div>

            <!-- Progress Bar -->
            <div class="w-full bg-gray-200 rounded-full h-2 mb-6">
              <div
                id="progressBar"
                class="bg-blue-600 h-2 rounded-full progress-bar"
                style="width: 5%"
              ></div>
            </div>

            <!-- Text Display -->
            <div
              id="textDisplay"
              class="bg-gray-50 p-4 rounded-lg mb-6 max-h-64 overflow-y-auto"
            >
              <div class="flex justify-between items-center mb-3">
                <h4 class="font-bold text-gray-700">ğŸ“– Okuma Metni</h4>
                <!-- Font Size Controls for Text -->
                <div
                  class="flex items-center gap-2 bg-white rounded-lg px-3 py-2 shadow-sm"
                >
                  <span class="text-sm text-gray-600">Metin Boyutu:</span>
                  <button
                    onclick="decreaseTextFontSize()"
                    class="bg-red-500 hover:bg-red-600 text-white w-8 h-8 rounded-full flex items-center justify-center font-bold text-lg transition-colors"
                    title="Metin boyutunu kÃ¼Ã§Ã¼lt"
                  >
                    -
                  </button>
                  <span
                    id="textFontSizeDisplay"
                    class="text-sm font-medium text-gray-700 min-w-[3rem] text-center"
                    >16px</span
                  >
                  <button
                    onclick="increaseTextFontSize()"
                    class="bg-green-500 hover:bg-green-600 text-white w-8 h-8 rounded-full flex items-center justify-center font-bold text-lg transition-colors"
                    title="Metin boyutunu bÃ¼yÃ¼t"
                  >
                    +
                  </button>
                  <button
                    onclick="resetTextFontSize()"
                    class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-xs transition-colors"
                    title="VarsayÄ±lan boyuta sÄ±fÄ±rla"
                  >
                    SÄ±fÄ±rla
                  </button>
                </div>
              </div>
              <div id="textContent" style="font-size: 16px; line-height: 1.6">
                <!-- Text content will be displayed here -->
              </div>
            </div>

            <!-- Question Display -->
            <div
              id="questionDisplay"
              class="question-card bg-white border-2 border-gray-200 rounded-lg p-6"
            >
              <!-- Current question will be displayed here -->
            </div>

            <!-- Navigation -->
            <div class="flex justify-end mt-6">
              <div class="flex gap-3">
                <button
                  id="nextBtn"
                  onclick="nextQuestion()"
                  class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-lg font-medium"
                >
                  Sonraki â†’
                </button>
                <button
                  id="submitBtn"
                  onclick="submitTest()"
                  class="hidden bg-green-500 hover:bg-green-600 text-white px-6 py-3 rounded-lg font-medium"
                >
                  âœ… Testi Bitir
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Test Results -->
        <div id="testResults" class="hidden bg-white rounded-lg shadow-md p-6">
          <div class="text-center">
            <div id="resultIcon" class="text-6xl mb-4"></div>
            <h3 id="resultTitle" class="text-2xl font-bold mb-4"></h3>
            <div id="resultDetails" class="space-y-4 mb-6"></div>
            <button
              onclick="backToStudentDashboard()"
              class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-lg font-medium"
            >
              Ana Sayfaya DÃ¶n
            </button>
          </div>
        </div>
      </div>

      <!-- Teacher Login Modal -->
      <div
        id="teacherLoginModal"
        class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
      >
        <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
          <div class="text-center mb-6">
            <div class="text-4xl mb-2">ğŸ”</div>
            <h3 class="text-xl font-bold text-gray-800">Ã–ÄŸretmen GiriÅŸi</h3>
            <p class="text-sm text-gray-600 mt-2">
              GÃ¼venli eriÅŸim iÃ§in kimlik doÄŸrulamasÄ± gereklidir
            </p>
          </div>

          <div
            id="loginError"
            class="hidden bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg mb-4"
          >
            <div class="flex items-center">
              <span class="text-red-500 mr-2">âš ï¸</span>
              <span id="loginErrorMessage"></span>
            </div>
          </div>

          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2"
                >ğŸ‘¤ KullanÄ±cÄ± AdÄ±</label
              >
              <input
                type="text"
                id="teacherUsername"
                placeholder="KullanÄ±cÄ± adÄ±nÄ±zÄ± girin"
                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              />
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2"
                >ğŸ”‘ Åifre</label
              >
              <input
                type="password"
                id="teacherPassword"
                placeholder="Åifrenizi girin"
                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              />
            </div>
          </div>

          <div class="mt-6 space-y-3">
            <button
              onclick="teacherLogin()"
              class="w-full bg-blue-500 hover:bg-blue-600 text-white px-4 py-3 rounded-lg font-medium transition-colors"
            >
              ğŸšª GiriÅŸ Yap
            </button>
            <button
              onclick="hideTeacherLogin()"
              class="w-full bg-gray-500 hover:bg-gray-600 text-white px-4 py-3 rounded-lg font-medium transition-colors"
            >
              âŒ Ä°ptal
            </button>
          </div>

          <div class="mt-4 p-3 bg-blue-50 rounded-lg text-sm">
            <div class="flex items-center text-blue-700">
              <span class="mr-2">ğŸ›¡ï¸</span>
              <span
                ><strong>GÃ¼venlik:</strong> Maksimum 3 hatalÄ± giriÅŸ hakkÄ±nÄ±z
                vardÄ±r.</span
              >
            </div>
            <div class="mt-1 text-blue-600">
              <span
                >Kalan deneme hakkÄ±: <span id="remainingAttempts">3</span></span
              >
            </div>
          </div>
        </div>
      </div>

      <!-- Data Management Modal -->
      <div
        id="dataManagementModal"
        class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
      >
        <div
          class="bg-white rounded-lg p-6 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto"
        >
          <div class="text-center mb-6">
            <div class="text-4xl mb-2">ğŸ’¾</div>
            <h3 class="text-xl font-bold text-gray-800">Veri YÃ¶netimi</h3>
            <p class="text-sm text-gray-600 mt-2">
              Sistem verilerinizi yÃ¶netin, yedekleyin ve geri yÃ¼kleyin
            </p>
          </div>

          <div class="space-y-4">
            <!-- Current Data Status -->
            <div class="bg-blue-50 p-4 rounded-lg">
              <h4 class="font-bold text-blue-800 mb-2">
                ğŸ“Š Mevcut Veri Durumu
              </h4>
              <div class="grid grid-cols-2 gap-4 text-sm text-blue-700">
                <div>
                  ğŸ‘¥ Ã–ÄŸrenci SayÄ±sÄ±:
                  <span id="dataStatusStudents" class="font-bold">0</span>
                </div>
                <div>
                  ğŸ“ Test SayÄ±sÄ±:
                  <span id="dataStatusTests" class="font-bold">0</span>
                </div>
                <div>
                  ğŸ“Š SonuÃ§ SayÄ±sÄ±:
                  <span id="dataStatusResults" class="font-bold">0</span>
                </div>
                <div>
                  ğŸ† Profil SayÄ±sÄ±:
                  <span id="dataStatusProfiles" class="font-bold">0</span>
                </div>
              </div>
              <div class="mt-2 text-xs text-blue-600">
                Son kaydetme: <span id="lastSaveTime">Bilinmiyor</span>
              </div>
            </div>

            <!-- Export Options -->
            <div class="bg-green-50 p-4 rounded-lg">
              <h4 class="font-bold text-green-800 mb-3">
                ğŸ“¤ Veri DÄ±ÅŸa Aktarma
              </h4>
              <button
                onclick="exportAllData()"
                class="w-full bg-green-500 hover:bg-green-600 text-white px-4 py-3 rounded-lg font-medium mb-2"
              >
                ğŸ’¾ TÃ¼m Verileri Yedekle (JSON)
              </button>
              <p class="text-xs text-green-700">
                TÃ¼m Ã¶ÄŸrenci, test ve sonuÃ§ verilerinizi JSON dosyasÄ± olarak
                indirin
              </p>
            </div>

            <!-- Import Options -->
            <div class="bg-yellow-50 p-4 rounded-lg">
              <h4 class="font-bold text-yellow-800 mb-3">
                ğŸ“¥ Veri Ä°Ã§e Aktarma
              </h4>
              <input
                type="file"
                id="dataImportFile"
                accept=".json"
                class="hidden"
                onchange="importAllData(event)"
              />
              <button
                onclick="document.getElementById('dataImportFile').click()"
                class="w-full bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-3 rounded-lg font-medium mb-2"
              >
                ğŸ“ Yedek DosyasÄ± YÃ¼kle
              </button>
              <p class="text-xs text-yellow-700">
                Daha Ã¶nce dÄ±ÅŸa aktardÄ±ÄŸÄ±nÄ±z JSON yedek dosyasÄ±nÄ± geri yÃ¼kleyin
              </p>
            </div>

            <!-- Manual Save -->
            <div class="bg-blue-50 p-4 rounded-lg">
              <h4 class="font-bold text-blue-800 mb-3">ğŸ’¾ Manuel Kaydetme</h4>
              <button
                onclick="manualSave()"
                class="w-full bg-blue-500 hover:bg-blue-600 text-white px-4 py-3 rounded-lg font-medium mb-2"
              >
                ğŸ’¾ Åimdi Kaydet
              </button>
              <p class="text-xs text-blue-700">
                Mevcut verileri hemen tarayÄ±cÄ± hafÄ±zasÄ±na kaydedin
              </p>
            </div>

            <!-- Clear Data -->
            <div class="bg-red-50 p-4 rounded-lg">
              <h4 class="font-bold text-red-800 mb-3">ğŸ—‘ï¸ Tehlikeli Ä°ÅŸlemler</h4>
              <button
                onclick="clearAllData()"
                class="w-full bg-red-500 hover:bg-red-600 text-white px-4 py-3 rounded-lg font-medium mb-2"
              >
                ğŸ—‘ï¸ TÃ¼m Verileri Sil
              </button>
              <p class="text-xs text-red-700">
                âš ï¸ Bu iÅŸlem geri alÄ±namaz! TÃ¼m veriler kalÄ±cÄ± olarak
                silinecektir.
              </p>
            </div>

            <!-- Auto-save Info -->
            <div class="bg-gray-50 p-4 rounded-lg">
              <h4 class="font-bold text-gray-800 mb-2">ğŸ”„ Otomatik Kaydetme</h4>
              <div class="text-sm text-gray-700">
                <p>âœ… Sistem her 30 saniyede bir otomatik kaydetme yapar</p>
                <p>âœ… Sayfa kapatÄ±lÄ±rken veriler otomatik kaydedilir</p>
                <p>âœ… Her Ã¶nemli iÅŸlemden sonra veriler kaydedilir</p>
              </div>
            </div>
          </div>

          <div class="flex gap-3 mt-6">
            <button
              onclick="hideDataManagement()"
              class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg flex-1"
            >
              Kapat
            </button>
          </div>
        </div>
      </div>

      <!-- General Login Modal -->
      <div
        id="loginModal"
        class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
      >
        <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
          <h3 class="text-xl font-bold mb-4">GiriÅŸ Yap</h3>
          <input
            type="text"
            id="username"
            placeholder="KullanÄ±cÄ± adÄ±"
            class="w-full p-3 border rounded-lg mb-3"
          />
          <input
            type="password"
            id="password"
            placeholder="Åifre"
            class="w-full p-3 border rounded-lg mb-4"
          />
          <div class="flex gap-3">
            <button
              onclick="login()"
              class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg flex-1"
            >
              GiriÅŸ
            </button>
            <button
              onclick="hideLogin()"
              class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg"
            >
              Ä°ptal
            </button>
          </div>
        </div>
      </div>

      <!-- Supabase Configuration Modal -->
      <div
        id="supabaseConfigModal"
        class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
      >
        <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
          <div class="text-center mb-6">
            <div class="text-4xl mb-2">ğŸ”§</div>
            <h3 class="text-xl font-bold text-gray-800">Supabase KonfigÃ¼rasyonu</h3>
            <p class="text-sm text-gray-600 mt-2">
              VeritabanÄ± baÄŸlantÄ±sÄ± iÃ§in Supabase bilgilerinizi girin
            </p>
          </div>

          <div
            id="supabaseError"
            class="hidden bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg mb-4"
          >
            <div class="flex items-center">
              <span class="text-red-500 mr-2">âš ï¸</span>
              <span id="supabaseErrorMessage"></span>
            </div>
          </div>

          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2"
                >ğŸ”— Supabase URL</label
              >
              <input
                type="url"
                id="supabaseUrl"
                placeholder="https://your-project.supabase.co"
                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              />
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2"
                >ğŸ”‘ Anon Key</label
              >
              <input
                type="password"
                id="supabaseAnonKey"
                placeholder="Supabase Anon Key"
                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              />
            </div>
          </div>

          <div class="mt-6 space-y-3">
            <button
              onclick="testSupabaseConnection()"
              class="w-full bg-blue-500 hover:bg-blue-600 text-white px-4 py-3 rounded-lg font-medium transition-colors"
            >
              ğŸ” BaÄŸlantÄ±yÄ± Test Et
            </button>
            <button
              onclick="saveSupabaseConfig()"
              class="w-full bg-green-500 hover:bg-green-600 text-white px-4 py-3 rounded-lg font-medium transition-colors"
            >
              ğŸ’¾ Kaydet ve Devam Et
            </button>
            <button
              onclick="hideSupabaseConfig()"
              class="w-full bg-gray-500 hover:bg-gray-600 text-white px-4 py-3 rounded-lg font-medium transition-colors"
            >
              âŒ Ä°ptal
            </button>
          </div>

          <div class="mt-4 p-3 bg-blue-50 rounded-lg text-sm">
            <div class="flex items-center text-blue-700">
              <span class="mr-2">ğŸ’¡</span>
              <span
                ><strong>Bilgi:</strong> Supabase bilgilerinizi Supabase Dashboard'dan alabilirsiniz.</span
              >
            </div>
            <div class="mt-2 text-blue-600 text-xs">
              <p>1. Supabase projenize gidin</p>
              <p>2. Settings > API menÃ¼sÃ¼nden URL ve Anon Key'i kopyalayÄ±n</p>
              <p>3. VeritabanÄ± tablolarÄ±nÄ±n oluÅŸturulduÄŸundan emin olun</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Global variables
      let currentUser = null;
      let currentTest = null;
      let currentQuestionIndex = 0;
      let studentAnswers = {};
      let testStartTime = null;
      let currentFontSize = 16; // Default font size in pixels
      let questionFontSizes = {}; // Store font size for each question
      let currentTextFontSize = 16; // Default text font size in pixels
      let questionTimer = null; // Timer for current question
      let questionTimeLeft = 120; // 120 seconds per question
      let questionStartTime = null; // Track when question started
      
      // Supabase configuration
      let isSupabaseConfigured = false;
      let useSupabase = false; // Flag to determine whether to use Supabase or localStorage
      
      // Teacher session management
      let teacherSessionToken = null;
      
      let students = [
        {
          name: 'Ahmet YÄ±lmaz',
          studentNumber: '2024001',
          tcNumber: '12345678901',
        },
        {
          name: 'AyÅŸe Kaya',
          studentNumber: '2024002',
          tcNumber: '12345678902',
        },
        {
          name: 'Mehmet Demir',
          studentNumber: '2024003',
          tcNumber: '12345678903',
        },
        {
          name: 'Fatma Åahin',
          studentNumber: '2024004',
          tcNumber: '12345678904',
        },
        {
          name: 'Ali Ã–zkan',
          studentNumber: '2024005',
          tcNumber: '12345678905',
        },
      ];
      let tests = [];
      let testResults = {};
      let studentProfiles = {};

      let isTeacherLoggedIn = false;
      let loginAttempts = 0;
      const maxLoginAttempts = 3;

      // Gamification constants
      const POINTS = {
        MULTIPLE_CHOICE: 6,
        FILL_BLANK: 5,
        TRUE_FALSE: 3,
      };

      const BADGES = {
        FIRST_TEST: {
          id: 'first_test',
          name: 'BaÅŸlangÄ±Ã§ Rozeti',
          icon: 'ğŸ¥‰',
          description: 'Ä°lk testini Ã§Ã¶zdÃ¼n!',
        },
        SPEED_READER: {
          id: 'speed_reader',
          name: 'HÄ±zlÄ± Okur Rozeti',
          icon: 'ğŸ¥ˆ',
          description: '20 testi 25 dakika iÃ§inde bitirdin!',
        },
        COMPREHENSION_MASTER: {
          id: 'comprehension_master',
          name: 'Anlama UstasÄ± Rozeti',
          icon: 'ğŸ¥‡',
          description: '%80 Ã¼stÃ¼ baÅŸarÄ±yla 10 test bitirdin!',
        },
        PERSEVERANCE: {
          id: 'perseverance',
          name: 'Azim Rozeti',
          icon: 'ğŸŒŸ',
          description: 'BaÅŸaramadÄ±ÄŸÄ±n testi tekrar edip baÅŸardÄ±n!',
        },
        READING_ADVENTURE: {
          id: 'reading_adventure',
          name: 'Okuma SerÃ¼veni Rozeti',
          icon: 'ğŸ“š',
          description: '20 farklÄ± test Ã§Ã¶zdÃ¼n!',
        },
        READING_WORM: {
          id: 'reading_worm',
          name: 'Okuma Kurdu Rozeti',
          icon: 'ğŸ±â€ğŸ‘“',
          description: '50 farklÄ± test Ã§Ã¶zdÃ¼n!',
        },
      };

      // Teacher credentials (in a real system, these would be securely stored)
      const teacherCredentials = {
        username: 'Ahmet ATAS',
        password: '23',
      };

      // Sample test data
      const sampleText = `Bir zamanlar kÃ¼Ã§Ã¼k bir kÃ¶yde yaÅŸayan genÃ§ bir Ã§iftÃ§i vardÄ±. Bu Ã§iftÃ§i her gÃ¼n tarlasÄ±nda Ã§alÄ±ÅŸÄ±r, sebzelerini Ã¶zenle yetiÅŸtirirdi. KÃ¶ylÃ¼ler onun ne kadar Ã§alÄ±ÅŸkan olduÄŸunu bilir ve ona saygÄ± duyarlardÄ±. Ã‡iftÃ§i, hasat zamanÄ± geldiÄŸinde Ã¼rÃ¼nlerini pazara gÃ¶tÃ¼rÃ¼r ve satardÄ±. KazandÄ±ÄŸÄ± parayla ailesinin ihtiyaÃ§larÄ±nÄ± karÅŸÄ±lar, kalan parayÄ± da gelecek iÃ§in biriktirirdi. YÄ±llar geÃ§tikÃ§e Ã§iftÃ§i daha da baÅŸarÄ±lÄ± oldu ve kÃ¶yÃ¼n en zengin insanlarÄ±ndan biri haline geldi.`;

      // Data persistence functions
      function saveDataToStorage() {
        try {
          const data = {
            students: students,
            tests: tests,
            testResults: testResults,
            studentProfiles: studentProfiles,
            lastSaved: Date.now(),
          };
          localStorage.setItem('okumaAnlamaTestSistemi', JSON.stringify(data));
          console.log('Veriler kaydedildi:', new Date().toLocaleString());
        } catch (error) {
          console.error('Veri kaydetme hatasÄ±:', error);
        }
      }

      function loadDataFromStorage() {
        try {
          const savedData = localStorage.getItem('okumaAnlamaTestSistemi');
          if (savedData) {
            const data = JSON.parse(savedData);

            // Load saved data
            if (data.students && Array.isArray(data.students)) {
              students = data.students;
            }
            if (data.tests && Array.isArray(data.tests)) {
              tests = data.tests;
            }
            if (data.testResults && typeof data.testResults === 'object') {
              testResults = data.testResults;
            }
            if (
              data.studentProfiles &&
              typeof data.studentProfiles === 'object'
            ) {
              studentProfiles = data.studentProfiles;
            }

            console.log(
              'Veriler yÃ¼klendi:',
              new Date(data.lastSaved).toLocaleString()
            );
            return true;
          }
        } catch (error) {
          console.error('Veri yÃ¼kleme hatasÄ±:', error);
        }
        return false;
      }

      function clearAllData() {
        if (
          confirm(
            'âš ï¸ TÃœM VERÄ°LERÄ° SÄ°LMEK Ä°STEDÄ°ÄÄ°NÄ°ZDEN EMÄ°N MÄ°SÄ°NÄ°Z?\n\nBu iÅŸlem:\nâ€¢ TÃ¼m Ã¶ÄŸrenci bilgilerini\nâ€¢ TÃ¼m testleri\nâ€¢ TÃ¼m sonuÃ§larÄ±\nâ€¢ TÃ¼m profilleri\n\nKalÄ±cÄ± olarak silecektir ve GERÄ° ALINAMAZ!'
          )
        ) {
          localStorage.removeItem('okumaAnlamaTestSistemi');

          // Reset all data
          students.length = 0;
          tests.length = 0;
          Object.keys(testResults).forEach((key) => delete testResults[key]);
          Object.keys(studentProfiles).forEach(
            (key) => delete studentProfiles[key]
          );

          // Reinitialize with sample data
          generateSampleTest();
          initializeStudentProfiles();

          // Update displays
          populateStudentList();
          populateStudentSelects();
          populateTestSelect();
          updateStats();

          alert(
            'âœ… TÃ¼m veriler silindi ve sistem sÄ±fÄ±rlandÄ±!\n\nÃ–rnek veriler yeniden yÃ¼klendi.'
          );
        }
      }

      function exportAllData() {
        const data = {
          students: students,
          tests: tests,
          testResults: testResults,
          studentProfiles: studentProfiles,
          exportDate: new Date().toISOString(),
          version: '1.0',
        };

        const dataStr = JSON.stringify(data, null, 2);
        const dataBlob = new Blob([dataStr], { type: 'application/json' });

        const link = document.createElement('a');
        link.href = URL.createObjectURL(dataBlob);
        link.download = `okuma_anlama_sistem_yedeÄŸi_${
          new Date().toISOString().split('T')[0]
        }.json`;
        link.click();

        alert(
          'ğŸ“„ TÃ¼m sistem verileri JSON formatÄ±nda dÄ±ÅŸa aktarÄ±ldÄ±!\n\nBu dosyayÄ± gÃ¼venli bir yerde saklayÄ±n.'
        );
      }

      function importAllData(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function (e) {
          try {
            const data = JSON.parse(e.target.result);

            // Validate data structure
            if (
              !data.students ||
              !data.tests ||
              !data.testResults ||
              !data.studentProfiles
            ) {
              throw new Error('GeÃ§ersiz yedek dosyasÄ± formatÄ±!');
            }

            if (
              confirm(
                'âš ï¸ MEVCUT VERÄ°LER ÃœZERÄ°NE YAZILACAK!\n\nBu iÅŸlem mevcut tÃ¼m verileri silip yedek dosyasÄ±ndaki verileri yÃ¼kleyecektir.\n\nDevam etmek istediÄŸinizden emin misiniz?'
              )
            ) {
              // Load data
              students = data.students || [];
              tests = data.tests || [];
              testResults = data.testResults || {};
              studentProfiles = data.studentProfiles || {};

              // Save to localStorage
              saveDataToStorage();

              // Update displays
              populateStudentList();
              populateStudentSelects();
              populateTestSelect();
              updateStats();

              let message = 'âœ… Veriler baÅŸarÄ±yla iÃ§e aktarÄ±ldÄ±!\n\n';
              message += `ğŸ“Š Ä°statistikler:\n`;
              message += `â€¢ ${students.length} Ã¶ÄŸrenci\n`;
              message += `â€¢ ${tests.length} test\n`;
              message += `â€¢ ${
                Object.keys(testResults).length
              } Ã¶ÄŸrencinin sonuÃ§larÄ±\n`;
              message += `â€¢ ${
                Object.keys(studentProfiles).length
              } Ã¶ÄŸrenci profili\n`;

              if (data.exportDate) {
                message += `\nğŸ“… Yedek tarihi: ${new Date(
                  data.exportDate
                ).toLocaleString('tr-TR')}`;
              }

              alert(message);
            }
          } catch (error) {
            alert('Yedek dosyasÄ± okuma hatasÄ±: ' + error.message);
          }
        };

        reader.readAsText(file);
      }

      // Auto-save function
      function autoSave() {
        if (useSupabase) {
          // Supabase auto-saves data automatically
          console.log('Supabase otomatik kaydetme aktif');
        } else {
          saveDataToStorage();
        }
      }

      // Teacher session management functions
      function saveTeacherSession(username, sessionToken = null) {
        const sessionData = {
          username: username,
          loginTime: Date.now(),
          sessionToken: sessionToken,
          isLoggedIn: true
        };
        
        localStorage.setItem('teacherSession', JSON.stringify(sessionData));
        teacherSessionToken = sessionToken;
        isTeacherLoggedIn = true;
      }

      function loadTeacherSession() {
        try {
          const sessionData = localStorage.getItem('teacherSession');
          if (sessionData) {
            const session = JSON.parse(sessionData);
            
            // Check if session is still valid (24 hours)
            const sessionAge = Date.now() - session.loginTime;
            const maxAge = 24 * 60 * 60 * 1000; // 24 hours
            
            if (sessionAge < maxAge && session.isLoggedIn) {
              teacherSessionToken = session.sessionToken;
              isTeacherLoggedIn = true;
              return session;
            } else {
              // Session expired
              clearTeacherSession();
            }
          }
        } catch (error) {
          console.error('Ã–ÄŸretmen oturum yÃ¼kleme hatasÄ±:', error);
          clearTeacherSession();
        }
        return null;
      }

      function clearTeacherSession() {
        localStorage.removeItem('teacherSession');
        teacherSessionToken = null;
        isTeacherLoggedIn = false;
      }

      async function validateTeacherSession() {
        if (useSupabase && isSupabaseConfigured && teacherSessionToken) {
          try {
            const sessionData = await SupabaseHelper.teachers.validateSession(teacherSessionToken);
            if (sessionData) {
              isTeacherLoggedIn = true;
              return true;
            }
          } catch (error) {
            console.error('Supabase oturum doÄŸrulama hatasÄ±:', error);
            clearTeacherSession();
          }
        }
        return false;
      }

      // Supabase Configuration Functions
      function showSupabaseConfig() {
        document.getElementById('supabaseConfigModal').classList.remove('hidden');
        
        // Load saved config if exists
        const savedConfig = localStorage.getItem('supabaseConfig');
        if (savedConfig) {
          const config = JSON.parse(savedConfig);
          document.getElementById('supabaseUrl').value = config.url || '';
          document.getElementById('supabaseAnonKey').value = config.anonKey || '';
        }
      }

      function hideSupabaseConfig() {
        document.getElementById('supabaseConfigModal').classList.add('hidden');
        hideSupabaseError();
      }

      function showSupabaseError(message) {
        const errorDiv = document.getElementById('supabaseError');
        const errorMessage = document.getElementById('supabaseErrorMessage');
        errorMessage.textContent = message;
        errorDiv.classList.remove('hidden');
      }

      function hideSupabaseError() {
        document.getElementById('supabaseError').classList.add('hidden');
      }

      async function testSupabaseConnection() {
        const url = document.getElementById('supabaseUrl').value.trim();
        const anonKey = document.getElementById('supabaseAnonKey').value.trim();

        if (!url || !anonKey) {
          showSupabaseError('LÃ¼tfen URL ve Anon Key alanlarÄ±nÄ± doldurun!');
          return;
        }

        try {
          hideSupabaseError();
          
          // Initialize Supabase client
          const success = initializeSupabase(url, anonKey);
          if (!success) {
            showSupabaseError('Supabase client baÅŸlatÄ±lamadÄ±!');
            return;
          }

          // Test connection
          await checkSupabaseConnection();
          
          alert('âœ… Supabase baÄŸlantÄ±sÄ± baÅŸarÄ±lÄ±!\n\nVeritabanÄ± tablolarÄ±na eriÅŸim saÄŸlandÄ±.');
          
        } catch (error) {
          console.error('Supabase baÄŸlantÄ± hatasÄ±:', error);
          showSupabaseError('BaÄŸlantÄ± hatasÄ±: ' + error.message);
        }
      }

      async function saveSupabaseConfig() {
        const url = document.getElementById('supabaseUrl').value.trim();
        const anonKey = document.getElementById('supabaseAnonKey').value.trim();

        if (!url || !anonKey) {
          showSupabaseError('LÃ¼tfen URL ve Anon Key alanlarÄ±nÄ± doldurun!');
          return;
        }

        try {
          hideSupabaseError();
          
          // Test connection first
          const success = initializeSupabase(url, anonKey);
          if (!success) {
            showSupabaseError('Supabase client baÅŸlatÄ±lamadÄ±!');
            return;
          }

          await checkSupabaseConnection();
          
          // Save configuration
          const config = { url, anonKey };
          localStorage.setItem('supabaseConfig', JSON.stringify(config));
          
          // Set flags
          isSupabaseConfigured = true;
          useSupabase = true;
          
          hideSupabaseConfig();
          
          alert('âœ… Supabase konfigÃ¼rasyonu kaydedildi!\n\nArtÄ±k veriler Supabase veritabanÄ±nda saklanacak.');
          
          // Migrate existing data if any
          await migrateLocalDataToSupabase();
          
        } catch (error) {
          console.error('Supabase konfigÃ¼rasyon hatasÄ±:', error);
          showSupabaseError('KonfigÃ¼rasyon hatasÄ±: ' + error.message);
        }
      }

      async function loadSupabaseConfig() {
        const savedConfig = localStorage.getItem('supabaseConfig');
        if (savedConfig) {
          try {
            const config = JSON.parse(savedConfig);
            const success = initializeSupabase(config.url, config.anonKey);
            if (success) {
              await checkSupabaseConnection();
              isSupabaseConfigured = true;
              useSupabase = true;
              console.log('âœ… Supabase konfigÃ¼rasyonu yÃ¼klendi');
              return true;
            }
          } catch (error) {
            console.error('Supabase konfigÃ¼rasyon yÃ¼kleme hatasÄ±:', error);
          }
        }
        return false;
      }

      async function migrateLocalDataToSupabase() {
        if (!useSupabase || !isSupabaseConfigured) return;
        
        try {
          console.log('LocalStorage verilerini Supabase\'e taÅŸÄ±ma baÅŸlÄ±yor...');
          
          // Migrate students
          for (const student of students) {
            try {
              await SupabaseHelper.students.create({
                name: student.name,
                student_number: student.studentNumber,
                tc_number: student.tcNumber
              });
            } catch (error) {
              // Ignore duplicate errors
              if (!error.message.includes('duplicate')) {
                console.error('Ã–ÄŸrenci taÅŸÄ±ma hatasÄ±:', error);
              }
            }
          }
          
          // Migrate tests
          for (const test of tests) {
            try {
              await SupabaseHelper.tests.create({
                id: test.id,
                title: test.title,
                text: test.text,
                text_display_mode: test.textDisplayMode || 'withQuestions',
                questions: test.questions
              });
            } catch (error) {
              if (!error.message.includes('duplicate')) {
                console.error('Test taÅŸÄ±ma hatasÄ±:', error);
              }
            }
          }
          
          console.log('âœ… Veri taÅŸÄ±ma tamamlandÄ±');
          
        } catch (error) {
          console.error('Veri taÅŸÄ±ma hatasÄ±:', error);
        }
      }

      // Initialize the application
      async function init() {
        // First try to load Supabase configuration
        const supabaseLoaded = await loadSupabaseConfig();
        
        // Check for existing teacher session
        const teacherSession = loadTeacherSession();
        if (teacherSession) {
          console.log('ğŸ‘¨â€ğŸ« Ã–ÄŸretmen oturumu bulundu:', teacherSession.username);
          
          // Validate session if using Supabase
          if (useSupabase && isSupabaseConfigured) {
            const isValid = await validateTeacherSession();
            if (!isValid) {
              console.log('âŒ Supabase oturum geÃ§ersiz, temizleniyor');
              clearTeacherSession();
            }
          }
        }
        
        if (supabaseLoaded) {
          console.log('ğŸ”— Supabase baÄŸlantÄ±sÄ± aktif');
          // Load data from Supabase if configured
          try {
            await loadDataFromSupabase();
          } catch (error) {
            console.error('Supabase veri yÃ¼kleme hatasÄ±:', error);
            // Fallback to localStorage
            loadDataFromStorage();
          }
        } else {
          // Try to load saved data from localStorage
          const dataLoaded = loadDataFromStorage();
          
          if (!dataLoaded) {
            // If no saved data, generate sample data
            generateSampleTest();
            initializeStudentProfiles();
          }
        }

        // Show appropriate panel based on session
        if (isTeacherLoggedIn) {
          console.log('ğŸ”“ Ã–ÄŸretmen oturumu aktif, panele yÃ¶nlendiriliyor');
          showTeacherPanel();
        } else {
          showUserSelection();
        }
        
        populateStudentSelects();

        // Set up auto-save every 30 seconds
        setInterval(autoSave, 30000);

        // Save data when page is about to unload
        window.addEventListener('beforeunload', () => {
          if (useSupabase) {
            // Supabase handles this automatically
            console.log('Supabase otomatik kaydetme');
          } else {
            saveDataToStorage();
          }
        });

        // Show data status
        if (supabaseLoaded) {
          console.log('ğŸ”— Supabase verileri yÃ¼klendi!');
          setTimeout(() => {
            const notification = document.createElement('div');
            notification.className =
              'fixed top-4 right-4 bg-blue-500 text-white px-4 py-2 rounded-lg shadow-lg z-50';
            notification.innerHTML = 'ğŸ”— Supabase baÄŸlantÄ±sÄ± aktif!';
            document.body.appendChild(notification);

            setTimeout(() => {
              if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
              }
            }, 3000);
          }, 1000);
        } else {
          console.log('ğŸ’¾ LocalStorage kullanÄ±lÄ±yor');
          setTimeout(() => {
            if (students.length > 0 || tests.length > 0) {
              const notification = document.createElement('div');
              notification.className =
                'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50';
              notification.innerHTML = 'ğŸ’¾ KaydedilmiÅŸ verileriniz yÃ¼klendi!';
              document.body.appendChild(notification);

              setTimeout(() => {
                if (notification.parentNode) {
                  notification.parentNode.removeChild(notification);
                }
              }, 3000);
            }
          }, 1000);
        }

        // Show session status if teacher is logged in
        if (isTeacherLoggedIn && teacherSession) {
          setTimeout(() => {
            const notification = document.createElement('div');
            notification.className =
              'fixed top-4 left-4 bg-purple-500 text-white px-4 py-2 rounded-lg shadow-lg z-50';
            notification.innerHTML = `ğŸ‘¨â€ğŸ« HoÅŸ geldiniz, ${teacherSession.username}!`;
            document.body.appendChild(notification);

            setTimeout(() => {
              if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
              }
            }, 4000);
          }, 1500);
        }
      }

      // Load data from Supabase
      async function loadDataFromSupabase() {
        if (!useSupabase || !isSupabaseConfigured) return false;
        
        try {
          // Load students
          const supabaseStudents = await SupabaseHelper.students.getAll();
          students.length = 0; // Clear existing
          students.push(...supabaseStudents.map(s => ({
            name: s.name,
            studentNumber: s.student_number,
            tcNumber: s.tc_number,
            id: s.id
          })));
          
          // Load tests
          const supabaseTests = await SupabaseHelper.tests.getAll();
          tests.length = 0; // Clear existing
          tests.push(...supabaseTests.map(t => ({
            id: t.id,
            title: t.title,
            text: t.text,
            textDisplayMode: t.text_display_mode,
            questions: t.questions
          })));
          
          // Load test results
          const supabaseResults = await SupabaseHelper.testResults.getAll();
          Object.keys(testResults).forEach(key => delete testResults[key]); // Clear existing
          
          supabaseResults.forEach(result => {
            const studentName = result.students.name;
            if (!testResults[studentName]) {
              testResults[studentName] = [];
            }
            testResults[studentName].push({
              testId: result.test_id,
              testTitle: result.tests.title,
              assigned: result.assigned,
              completed: result.completed,
              score: result.score,
              answers: result.answers,
              stars: result.stars,
              points: result.points
            });
          });
          
          console.log('âœ… Supabase veriler yÃ¼klendi');
          return true;
          
        } catch (error) {
          console.error('Supabase veri yÃ¼kleme hatasÄ±:', error);
          throw error;
        }
      }

      // Gamification functions
      function initializeStudentProfiles() {
        students.forEach((student) => {
          if (!studentProfiles[student.name]) {
            studentProfiles[student.name] = {
              totalPoints: 0,
              badges: [],
              testsCompleted: 0,
              testsWithHighScore: 0, // 80%+ tests
              fastCompletions: 0, // under 25 minutes
              retakeSuccesses: 0,
              averageStars: 0,
              totalStars: 0,
            };
          }
        });
      }

      function calculateDetailedScore(answers, questions) {
        let multipleCorrect = 0,
          multipleTotal = 0;
        let fillBlankCorrect = 0,
          fillBlankTotal = 0;
        let trueFalseCorrect = 0,
          trueFalseTotal = 0;
        let totalPoints = 0;

        questions.forEach((question, index) => {
          const userAnswer = answers[index];
          let isCorrect = false;

          if (question.type === 'multiple') {
            multipleTotal++;
            if (userAnswer === question.correct) {
              multipleCorrect++;
              isCorrect = true;
            }
            if (isCorrect) totalPoints += POINTS.MULTIPLE_CHOICE;
          } else if (question.type === 'fillblank') {
            fillBlankTotal++;
            if (userAnswer === question.correct) {
              fillBlankCorrect++;
              isCorrect = true;
            }
            if (isCorrect) totalPoints += POINTS.FILL_BLANK;
          } else if (question.type === 'truefalse') {
            trueFalseTotal++;
            if (userAnswer === question.correct) {
              trueFalseCorrect++;
              isCorrect = true;
            }
            if (isCorrect) totalPoints += POINTS.TRUE_FALSE;
          }
        });

        return {
          multiple: { correct: multipleCorrect, total: multipleTotal },
          fillblank: { correct: fillBlankCorrect, total: fillBlankTotal },
          truefalse: { correct: trueFalseCorrect, total: trueFalseTotal },
          totalPoints: totalPoints,
          percentage: Math.round((totalPoints / 100) * 100),
        };
      }

      function getStarsForScore(percentage) {
        if (percentage >= 90) return 5;
        if (percentage >= 80) return 4;
        if (percentage >= 70) return 3;
        return 0;
      }

      function getStarsDisplay(stars) {
        const starEmoji = 'â­';
        return starEmoji.repeat(stars);
      }

      function checkAndAwardBadges(studentName, testResult, testDuration) {
        // Ensure profile exists
        if (!studentProfiles[studentName]) {
          studentProfiles[studentName] = {
            totalPoints: 0,
            badges: [],
            testsCompleted: 0,
            testsWithHighScore: 0,
            fastCompletions: 0,
            retakeSuccesses: 0,
            averageStars: 0,
            totalStars: 0,
          };
        }

        const profile = studentProfiles[studentName];
        const newBadges = [];

        // First Test Badge
        if (
          profile.testsCompleted === 1 &&
          !profile.badges.includes(BADGES.FIRST_TEST.id)
        ) {
          profile.badges.push(BADGES.FIRST_TEST.id);
          newBadges.push(BADGES.FIRST_TEST);
        }

        // Speed Reader Badge (20 tests under 25 minutes)
        if (testDuration <= 25 * 60 * 1000) {
          // 25 minutes in milliseconds
          profile.fastCompletions++;
          if (
            profile.fastCompletions >= 20 &&
            !profile.badges.includes(BADGES.SPEED_READER.id)
          ) {
            profile.badges.push(BADGES.SPEED_READER.id);
            newBadges.push(BADGES.SPEED_READER);
          }
        }

        // Comprehension Master Badge (10 tests with 80%+)
        if (testResult.percentage >= 80) {
          profile.testsWithHighScore++;
          if (
            profile.testsWithHighScore >= 10 &&
            !profile.badges.includes(BADGES.COMPREHENSION_MASTER.id)
          ) {
            profile.badges.push(BADGES.COMPREHENSION_MASTER.id);
            newBadges.push(BADGES.COMPREHENSION_MASTER);
          }
        }

        // Reading Adventure Badge (20 different tests)
        if (
          profile.testsCompleted >= 20 &&
          !profile.badges.includes(BADGES.READING_ADVENTURE.id)
        ) {
          profile.badges.push(BADGES.READING_ADVENTURE.id);
          newBadges.push(BADGES.READING_ADVENTURE);
        }

        // Reading Worm Badge (50 different tests)
        if (
          profile.testsCompleted >= 50 &&
          !profile.badges.includes(BADGES.READING_WORM.id)
        ) {
          profile.badges.push(BADGES.READING_WORM.id);
          newBadges.push(BADGES.READING_WORM);
        }

        return newBadges;
      }

      function updateStudentProfile(
        studentName,
        testResult,
        testDuration,
        isRetake = false
      ) {
        // Ensure profile exists
        if (!studentProfiles[studentName]) {
          studentProfiles[studentName] = {
            totalPoints: 0,
            badges: [],
            testsCompleted: 0,
            testsWithHighScore: 0,
            fastCompletions: 0,
            retakeSuccesses: 0,
            averageStars: 0,
            totalStars: 0,
          };
        }

        const profile = studentProfiles[studentName];

        // Update basic stats
        if (!isRetake) {
          profile.testsCompleted++;
        }
        profile.totalPoints += testResult.totalPoints;

        const stars = getStarsForScore(testResult.percentage);
        profile.totalStars += stars;
        profile.averageStars =
          profile.testsCompleted > 0
            ? profile.totalStars / profile.testsCompleted
            : 0;

        // Check for Perseverance Badge (retake success)
        if (
          isRetake &&
          testResult.percentage >= 70 &&
          !profile.badges.includes(BADGES.PERSEVERANCE.id)
        ) {
          profile.badges.push(BADGES.PERSEVERANCE.id);
          profile.retakeSuccesses++;
          return [BADGES.PERSEVERANCE];
        }

        return checkAndAwardBadges(studentName, testResult, testDuration);
      }

      // Navigation functions
      function showUserSelection() {
        hideAllSections();
        document.getElementById('userSelection').classList.remove('hidden');
      }

      function showTeacherPanel() {
        if (!isTeacherLoggedIn) {
          showTeacherLogin();
          return;
        }
        hideAllSections();
        document.getElementById('teacherPanel').classList.remove('hidden');
        showTextInput();
      }

      function showStudentPanel() {
        hideAllSections();
        document.getElementById('studentPanel').classList.remove('hidden');
        populateStudentLogin();
      }

      function hideAllSections() {
        const sections = ['userSelection', 'teacherPanel', 'studentPanel'];
        sections.forEach((section) => {
          document.getElementById(section).classList.add('hidden');
        });
      }

      // Teacher panel functions
      function showTextInput() {
        hideTeacherSections();
        document.getElementById('textInputModule').classList.remove('hidden');
        updateTeacherTabs('showTextInput()');
      }

      function showStudentManagement() {
        hideTeacherSections();
        document.getElementById('studentManagement').classList.remove('hidden');
        updateTeacherTabs('showStudentManagement()');
        populateStudentList();
        populateTestSelect();
      }

      function showResults() {
        hideTeacherSections();
        document.getElementById('resultsPanel').classList.remove('hidden');
        updateTeacherTabs('showResults()');
        populateStudentFilter();
        displayResults();
      }

      function populateStudentFilter() {
        const select = document.getElementById('studentFilter');
        const studentsWithResults = Object.keys(testResults);

        // Clear existing options except the first one
        select.innerHTML = '<option value="">TÃ¼m Ã–ÄŸrenciler (Son 10)</option>';

        // Add students who have test results
        studentsWithResults.forEach((studentName) => {
          const option = document.createElement('option');
          option.value = studentName;
          option.textContent = studentName;
          select.appendChild(option);
        });
      }

      function filterResultsByStudent() {
        displayResults();
      }

      function hideTeacherSections() {
        const sections = [
          'textInputModule',
          'studentManagement',
          'resultsPanel',
        ];
        sections.forEach((section) => {
          document.getElementById(section).classList.add('hidden');
        });
      }

      function updateTeacherTabs(activeFunction) {
        const tabs = document.querySelectorAll('.teacher-tab');
        tabs.forEach((tab) => {
          if (tab.onclick.toString().includes(activeFunction.split('(')[0])) {
            tab.classList.add('text-blue-600', 'border-b-2', 'border-blue-600');
            tab.classList.remove('text-gray-500');
          } else {
            tab.classList.remove(
              'text-blue-600',
              'border-b-2',
              'border-blue-600'
            );
            tab.classList.add('text-gray-500');
          }
        });
      }

      // Text display mode functions
      function updateTextDisplayInfo() {
        const selectedMode = document.querySelector(
          'input[name="textDisplay"]:checked'
        ).value;
        const infoDiv = document.getElementById('textDisplayInfo');

        let infoText = '';
        let iconColor = 'border-blue-500';

        switch (selectedMode) {
          case 'withQuestions':
            infoText =
              '<strong>ğŸ“„ SeÃ§ili Mod:</strong> Her soruyla birlikte metin gÃ¶sterilecek. Bu klasik okuma-anlama test formatÄ±dÄ±r.';
            iconColor = 'border-blue-500';
            break;
          case 'firstPageOnly':
            infoText =
              '<strong>ğŸ“‹ SeÃ§ili Mod:</strong> Ã–ÄŸrenci Ã¶nce metni okuyacak, sonra sorulara geÃ§ecek. Metin sadece baÅŸlangÄ±Ã§ta gÃ¶rÃ¼nÃ¼r.';
            iconColor = 'border-green-500';
            break;
          case 'noText':
            infoText =
              '<strong>ğŸš« SeÃ§ili Mod:</strong> Metin hiÃ§ gÃ¶sterilmeyecek. Ã–ÄŸrenci doÄŸrudan sorularla karÅŸÄ±laÅŸacak. Bu mod genel bilgi testleri iÃ§in uygundur.';
            iconColor = 'border-orange-500';
            break;
        }

        infoDiv.className = `mt-3 p-3 bg-white rounded border-l-4 ${iconColor}`;
        infoDiv.innerHTML = `<div class="text-sm text-gray-700">${infoText}</div>`;
      }

      // Test generation functions
      function generateTest() {
        const title = document.getElementById('textTitle').value;
        const content = document.getElementById('textContent').value;

        if (!title || !content) {
          alert('LÃ¼tfen baÅŸlÄ±k ve metin iÃ§eriÄŸini girin!');
          return;
        }

        // Get selected text display mode
        const textDisplayMode = document.querySelector(
          'input[name="textDisplay"]:checked'
        ).value;

        // Generate sample questions based on text
        const test = {
          id: Date.now(),
          title: title,
          text: content,
          textDisplayMode: textDisplayMode, // Add display mode to test
          questions: generateSampleQuestions(content),
        };

        displayTestPreview(test);
      }

      function generateSampleQuestions(text) {
        // Advanced text analysis for better question generation
        const questions = [];

        // Analyze the text to extract key information
        const sentences = text
          .split(/[.!?]+/)
          .filter((s) => s.trim().length > 10);
        const words = text
          .toLowerCase()
          .split(/\s+/)
          .filter((w) => w.length > 3);
        const paragraphs = text
          .split(/\n\s*\n/)
          .filter((p) => p.trim().length > 0);

        // Extract key entities and concepts
        const entities = extractEntities(text);
        const keyWords = extractKeyWords(text);
        const actions = extractActions(text);
        const locations = extractLocations(text);
        const timeReferences = extractTimeReferences(text);

        // Generate multiple choice questions (10) based on text content
        const multipleChoiceQuestions = [];

        // 1. Character-based questions
        if (entities.people.length > 0) {
          const mainCharacter = entities.people[0];
          multipleChoiceQuestions.push({
            type: 'multiple',
            question: `${mainCharacter} hakkÄ±nda metinde verilen bilgilerden hangisi doÄŸrudur?`,
            options: generateCharacterOptions(text, mainCharacter),
            correct: 0,
          });
        }

        // 2. Location-based questions
        if (locations.length > 0) {
          const mainLocation = locations[0];
          multipleChoiceQuestions.push({
            type: 'multiple',
            question: `Metne gÃ¶re ${mainLocation} ile ilgili aÅŸaÄŸÄ±dakilerden hangisi sÃ¶ylenebilir?`,
            options: generateLocationOptions(text, mainLocation),
            correct: 0,
          });
        }

        // 3. Action/Event-based questions
        if (actions.length > 0) {
          const mainAction = actions[0];
          multipleChoiceQuestions.push({
            type: 'multiple',
            question: `Metinde bahsedilen "${mainAction}" eylemi ile ilgili hangisi doÄŸrudur?`,
            options: generateActionOptions(text, mainAction),
            correct: 0,
          });
        }

        // 4. Cause-effect questions
        const causeEffect = findCauseEffect(text);
        if (causeEffect.length > 0) {
          multipleChoiceQuestions.push({
            type: 'multiple',
            question: `Metne gÃ¶re aÅŸaÄŸÄ±daki neden-sonuÃ§ iliÅŸkilerinden hangisi doÄŸrudur?`,
            options: generateCauseEffectOptions(causeEffect),
            correct: 0,
          });
        }

        // 5. Sequence questions
        const events = extractEvents(text);
        if (events.length >= 2) {
          multipleChoiceQuestions.push({
            type: 'multiple',
            question: `Metinde anlatÄ±lan olaylarÄ±n doÄŸru sÄ±rasÄ± hangisidir?`,
            options: generateSequenceOptions(events),
            correct: 0,
          });
        }

        // 6. Detail questions from different parts of text
        const details = extractImportantDetails(text);
        details.slice(0, 3).forEach((detail) => {
          if (multipleChoiceQuestions.length < 10) {
            multipleChoiceQuestions.push({
              type: 'multiple',
              question: detail.question,
              options: detail.options,
              correct: detail.correct,
            });
          }
        });

        // 7. Inference questions
        const inferences = generateInferenceQuestions(text);
        inferences.slice(0, 2).forEach((inference) => {
          if (multipleChoiceQuestions.length < 10) {
            multipleChoiceQuestions.push(inference);
          }
        });

        // Fill remaining slots with content-based questions
        while (multipleChoiceQuestions.length < 10) {
          const remainingQuestions = generateContentBasedQuestions(
            text,
            sentences,
            keyWords
          );
          const questionToAdd =
            remainingQuestions[
              multipleChoiceQuestions.length % remainingQuestions.length
            ];
          multipleChoiceQuestions.push(questionToAdd);
        }

        questions.push(...multipleChoiceQuestions);

        // Generate fill in the blank questions (5) based on text
        const fillBlankQuestions = [];

        // Extract sentences for fill-in-the-blank questions
        const importantSentences = sentences.slice(0, 3);

        importantSentences.forEach((sentence, index) => {
          if (fillBlankQuestions.length < 5) {
            const words = sentence
              .trim()
              .split(' ')
              .filter((w) => w.length > 3);
            if (words.length > 3) {
              // Pick a word to blank out (usually a noun or important word)
              const wordToBlank = words[Math.floor(words.length / 2)];
              const questionText = sentence.replace(wordToBlank, '_____');

              // Create word bank with correct answer and distractors
              const wordBank = [wordToBlank];

              // Add some generic distractors
              const distractors = [
                'zaman',
                'yer',
                'kiÅŸi',
                'ÅŸey',
                'durum',
                'hal',
                'iÅŸ',
                'gÃ¼n',
              ];
              while (wordBank.length < 5) {
                const distractor =
                  distractors[Math.floor(Math.random() * distractors.length)];
                if (!wordBank.includes(distractor)) {
                  wordBank.push(distractor);
                }
              }

              fillBlankQuestions.push({
                type: 'fillblank',
                question: questionText,
                wordBank: wordBank,
                correct: wordToBlank,
              });
            }
          }
        });

        // Add generic fill-in-the-blank questions if needed
        while (fillBlankQuestions.length < 5) {
          const genericQuestions = [
            {
              question: 'Bu hikaye _____ geÃ§mektedir.',
              wordBank: ['geÃ§miÅŸte', 'gelecekte', 'ÅŸimdi', 'dÃ¼ÅŸte', 'hayalde'],
              correct: 'geÃ§miÅŸte',
            },
            {
              question: 'Ana karakter _____ bir kiÅŸidir.',
              wordBank: ['Ã§alÄ±ÅŸkan', 'tembel', 'kÃ¶tÃ¼', 'Ã¼zgÃ¼n', 'kÄ±zgÄ±n'],
              correct: 'Ã§alÄ±ÅŸkan',
            },
            {
              question: 'Hikayenin _____ mutlu bir sonla biter.',
              wordBank: ['sonunda', 'baÅŸÄ±nda', 'ortasÄ±nda', 'hiÃ§bir', 'bazen'],
              correct: 'sonunda',
            },
          ];

          const randomQuestion =
            genericQuestions[
              fillBlankQuestions.length % genericQuestions.length
            ];
          fillBlankQuestions.push({
            type: 'fillblank',
            question: randomQuestion.question,
            wordBank: randomQuestion.wordBank,
            correct: randomQuestion.correct,
          });
        }

        questions.push(...fillBlankQuestions);

        // Generate True/False questions (5) based on text analysis
        const trueFalseQuestions = [];

        // Analyze text for true/false questions
        if (text.toLowerCase().includes('baÅŸarÄ±')) {
          trueFalseQuestions.push({
            type: 'truefalse',
            question: 'Metinde baÅŸarÄ± konusu iÅŸlenmektedir.',
            correct: true,
          });
        }

        if (text.toLowerCase().includes('Ã§alÄ±ÅŸ')) {
          trueFalseQuestions.push({
            type: 'truefalse',
            question: 'Metinde Ã§alÄ±ÅŸkanlÄ±k vurgulanmaktadÄ±r.',
            correct: true,
          });
        }

        // Add generic true/false questions
        const genericTrueFalse = [
          {
            question: 'Bu metin bir hikaye tÃ¼rÃ¼ndedir.',
            correct: true,
          },
          {
            question: 'Metinde olumsuz bir sonuÃ§ anlatÄ±lmaktadÄ±r.',
            correct: false,
          },
          {
            question: 'Bu metin Ã¶ÄŸretici bir iÃ§eriÄŸe sahiptir.',
            correct: true,
          },
          {
            question: 'Metinde sadece hayal Ã¼rÃ¼nÃ¼ olaylar anlatÄ±lmaktadÄ±r.',
            correct: false,
          },
          {
            question: 'Bu hikayeden bir ders Ã§Ä±karÄ±labilir.',
            correct: true,
          },
        ];

        // Fill remaining true/false questions
        while (trueFalseQuestions.length < 5) {
          const randomTF =
            genericTrueFalse[
              trueFalseQuestions.length % genericTrueFalse.length
            ];
          trueFalseQuestions.push({
            type: 'truefalse',
            question: randomTF.question,
            correct: randomTF.correct,
          });
        }

        questions.push(...trueFalseQuestions);

        return questions;
      }

      // Advanced text analysis functions for better question generation
      function extractEntities(text) {
        const entities = {
          people: [],
          places: [],
          things: [],
        };

        // Common Turkish names and titles
        const namePatterns = [
          /\b([A-ZÃ‡ÄIÃ–ÅÃœ][a-zÃ§ÄŸÄ±Ã¶ÅŸÃ¼]+)\s+([A-ZÃ‡ÄIÃ–ÅÃœ][a-zÃ§ÄŸÄ±Ã¶ÅŸÃ¼]+)\b/g, // Full names
          /\b(Ã§iftÃ§i|Ã¶ÄŸretmen|doktor|mÃ¼hendis|iÅŸÃ§i|memur|Ã¶ÄŸrenci|anne|baba|kardeÅŸ|arkadaÅŸ)\b/gi, // Professions/relations
          /\b([A-ZÃ‡ÄIÃ–ÅÃœ][a-zÃ§ÄŸÄ±Ã¶ÅŸÃ¼]+)(?=\s+(?:adlÄ±|isimli|denen))/g, // Names before descriptors
        ];

        namePatterns.forEach((pattern) => {
          let match;
          while ((match = pattern.exec(text)) !== null) {
            if (match[1] && match[2]) {
              entities.people.push(match[1] + ' ' + match[2]);
            } else if (match[1]) {
              entities.people.push(match[1]);
            }
          }
        });

        return entities;
      }

      function extractKeyWords(text) {
        const words = text.toLowerCase().split(/\s+/);
        const stopWords = [
          'bir',
          'bu',
          'ÅŸu',
          've',
          'ile',
          'iÃ§in',
          'gibi',
          'kadar',
          'sonra',
          'Ã¶nce',
          'Ã§ok',
          'az',
          'her',
          'hiÃ§',
          'de',
          'da',
          'ki',
          'mi',
          'mu',
          'mÄ±',
          'mÃ¼',
        ];

        const wordCount = {};
        words.forEach((word) => {
          word = word.replace(/[^\wÃ§ÄŸÄ±Ã¶ÅŸÃ¼Ã‡ÄIÃ–ÅÃœ]/g, '');
          if (word.length > 3 && !stopWords.includes(word)) {
            wordCount[word] = (wordCount[word] || 0) + 1;
          }
        });

        return Object.entries(wordCount)
          .sort((a, b) => b[1] - a[1])
          .slice(0, 10)
          .map(([word]) => word);
      }

      function extractActions(text) {
        const actionPatterns = [
          /\b(\w+(?:mak|mek|ma|me))\b/g, // Infinitive verbs
          /\b(\w+(?:yor|Ä±yor|iyor|uyor|Ã¼yor))\b/g, // Present continuous
          /\b(\w+(?:dÄ±|di|du|dÃ¼|tÄ±|ti|tu|tÃ¼))\b/g, // Past tense
          /\b(\w+(?:acak|ecek|acaÄŸ|eceÄŸ))\b/g, // Future tense
        ];

        const actions = new Set();
        actionPatterns.forEach((pattern) => {
          let match;
          while ((match = pattern.exec(text)) !== null) {
            if (match[1].length > 3) {
              actions.add(match[1]);
            }
          }
        });

        return Array.from(actions).slice(0, 5);
      }

      function extractLocations(text) {
        const locationPatterns = [
          /\b(kÃ¶y|ÅŸehir|kasaba|mahalle|ev|okul|hastane|park|bahÃ§e|tarla|orman|daÄŸ|deniz|gÃ¶l)\b/gi,
          /\b([A-ZÃ‡ÄIÃ–ÅÃœ][a-zÃ§ÄŸÄ±Ã¶ÅŸÃ¼]+)(?=\s+(?:kÃ¶yÃ¼|ÅŸehri|kasabasÄ±))/g,
        ];

        const locations = new Set();
        locationPatterns.forEach((pattern) => {
          let match;
          while ((match = pattern.exec(text)) !== null) {
            locations.add(match[1] || match[0]);
          }
        });

        return Array.from(locations).slice(0, 3);
      }

      function extractTimeReferences(text) {
        const timePatterns = [
          /\b(sabah|Ã¶ÄŸle|akÅŸam|gece|gÃ¼ndÃ¼z)\b/gi,
          /\b(bugÃ¼n|dÃ¼n|yarÄ±n|geÃ§en|gelecek)\b/gi,
          /\b(yÄ±l|ay|hafta|gÃ¼n|saat|dakika)\b/gi,
          /\b(Ã¶nce|sonra|sÄ±rasÄ±nda|esnasÄ±nda)\b/gi,
        ];

        const times = new Set();
        timePatterns.forEach((pattern) => {
          let match;
          while ((match = pattern.exec(text)) !== null) {
            times.add(match[0]);
          }
        });

        return Array.from(times).slice(0, 3);
      }

      function generateCharacterOptions(text, character) {
        const sentences = text
          .split(/[.!?]+/)
          .filter((s) => s.toLowerCase().includes(character.toLowerCase()));

        if (sentences.length > 0) {
          const correctInfo = extractCharacterInfo(sentences[0], character);
          return [
            correctInfo,
            generateWrongCharacterInfo(character, 1),
            generateWrongCharacterInfo(character, 2),
          ];
        }

        return [
          `${character} Ã§alÄ±ÅŸkan bir kiÅŸidir`,
          `${character} tembel bir kiÅŸidir`,
          `${character} zengin bir kiÅŸidir`,
        ];
      }

      function extractCharacterInfo(sentence, character) {
        // Extract meaningful information about the character from the sentence
        const lowerSentence = sentence.toLowerCase();
        const lowerCharacter = character.toLowerCase();

        if (lowerSentence.includes('Ã§alÄ±ÅŸ'))
          return `${character} Ã§alÄ±ÅŸkan bir kiÅŸidir`;
        if (lowerSentence.includes('baÅŸarÄ±'))
          return `${character} baÅŸarÄ±lÄ± bir kiÅŸidir`;
        if (lowerSentence.includes('iyi'))
          return `${character} iyi bir kiÅŸidir`;
        if (lowerSentence.includes('genÃ§'))
          return `${character} genÃ§ bir kiÅŸidir`;
        if (lowerSentence.includes('yaÅŸlÄ±'))
          return `${character} yaÅŸlÄ± bir kiÅŸidir`;

        return `${character} metinde Ã¶nemli bir karakterdir`;
      }

      function generateWrongCharacterInfo(character, variant) {
        const wrongOptions = [
          [`${character} tembel bir kiÅŸidir`, `${character} kÃ¶tÃ¼ bir kiÅŸidir`],
          [
            `${character} baÅŸarÄ±sÄ±z bir kiÅŸidir`,
            `${character} zengin bir kiÅŸidir`,
          ],
        ];

        return wrongOptions[variant - 1]
          ? wrongOptions[variant - 1][0]
          : `${character} farklÄ± bir kiÅŸidir`;
      }

      function generateLocationOptions(text, location) {
        const sentences = text
          .split(/[.!?]+/)
          .filter((s) => s.toLowerCase().includes(location.toLowerCase()));

        if (sentences.length > 0) {
          const correctInfo = extractLocationInfo(sentences[0], location);
          return [
            correctInfo,
            `${location} bÃ¼yÃ¼k bir yerdir`,
            `${location} modern bir yerdir`,
          ];
        }

        return [
          `${location} metinde geÃ§en bir yerdir`,
          `${location} bÃ¼yÃ¼k bir yerdir`,
          `${location} uzak bir yerdir`,
        ];
      }

      function extractLocationInfo(sentence, location) {
        const lowerSentence = sentence.toLowerCase();

        if (lowerSentence.includes('kÃ¼Ã§Ã¼k'))
          return `${location} kÃ¼Ã§Ã¼k bir yerdir`;
        if (lowerSentence.includes('bÃ¼yÃ¼k'))
          return `${location} bÃ¼yÃ¼k bir yerdir`;
        if (lowerSentence.includes('gÃ¼zel'))
          return `${location} gÃ¼zel bir yerdir`;
        if (lowerSentence.includes('uzak'))
          return `${location} uzak bir yerdir`;
        if (lowerSentence.includes('yakÄ±n'))
          return `${location} yakÄ±n bir yerdir`;

        return `${location} metinde bahsedilen bir yerdir`;
      }

      function generateActionOptions(text, action) {
        return [
          `Bu eylem metinde olumlu bir ÅŸekilde anlatÄ±lmÄ±ÅŸtÄ±r`,
          `Bu eylem metinde olumsuz bir ÅŸekilde anlatÄ±lmÄ±ÅŸtÄ±r`,
          `Bu eylem metinde hiÃ§ bahsedilmemiÅŸtir`,
        ];
      }

      function findCauseEffect(text) {
        const causeEffectPatterns = [
          /(.+?)\s+(?:bu yÃ¼zden|bundan dolayÄ±|bu nedenle|Ã§Ã¼nkÃ¼)\s+(.+)/gi,
          /(.+?)\s+(?:sonucunda|sonucu|neticesinde)\s+(.+)/gi,
        ];

        const relationships = [];
        causeEffectPatterns.forEach((pattern) => {
          let match;
          while ((match = pattern.exec(text)) !== null) {
            relationships.push({
              cause: match[1].trim(),
              effect: match[2].trim(),
            });
          }
        });

        return relationships;
      }

      function generateCauseEffectOptions(causeEffects) {
        if (causeEffects.length > 0) {
          const correct = causeEffects[0];
          return [
            `${correct.cause} â†’ ${correct.effect}`,
            `${correct.effect} â†’ ${correct.cause}`,
            `Bu metinde neden-sonuÃ§ iliÅŸkisi yoktur`,
          ];
        }

        return [
          'Ã‡alÄ±ÅŸkanlÄ±k baÅŸarÄ±yÄ± getirir',
          'Tembellik baÅŸarÄ±yÄ± getirir',
          'Åans baÅŸarÄ±yÄ± getirir',
        ];
      }

      function extractEvents(text) {
        const sentences = text
          .split(/[.!?]+/)
          .filter((s) => s.trim().length > 10);
        const events = [];

        sentences.forEach((sentence, index) => {
          if (
            sentence.includes('Ã¶nce') ||
            sentence.includes('sonra') ||
            sentence.includes('daha sonra')
          ) {
            events.push({
              order: index,
              text: sentence.trim(),
              summary: sentence.trim().substring(0, 50) + '...',
            });
          }
        });

        if (events.length === 0) {
          // Extract first few meaningful sentences as events
          sentences.slice(0, 3).forEach((sentence, index) => {
            events.push({
              order: index,
              text: sentence.trim(),
              summary: sentence.trim().substring(0, 50) + '...',
            });
          });
        }

        return events;
      }

      function generateSequenceOptions(events) {
        if (events.length >= 2) {
          const correctSequence = events.map((e) => e.summary).join(' â†’ ');
          const wrongSequence1 = [events[1], events[0], ...events.slice(2)]
            .map((e) => e.summary)
            .join(' â†’ ');
          const wrongSequence2 = events
            .reverse()
            .map((e) => e.summary)
            .join(' â†’ ');

          return [correctSequence, wrongSequence1, wrongSequence2];
        }

        return [
          'DoÄŸru sÄ±ralama metinde verilmiÅŸtir',
          'Olaylar karÄ±ÅŸÄ±k sÄ±rayla anlatÄ±lmÄ±ÅŸtÄ±r',
          'SÄ±ralama Ã¶nemli deÄŸildir',
        ];
      }

      function extractImportantDetails(text) {
        const sentences = text
          .split(/[.!?]+/)
          .filter((s) => s.trim().length > 10);
        const details = [];

        sentences.forEach((sentence) => {
          // Look for specific details with numbers, names, places
          if (
            /\d+/.test(sentence) ||
            /[A-ZÃ‡ÄIÃ–ÅÃœ][a-zÃ§ÄŸÄ±Ã¶ÅŸÃ¼]+/.test(sentence)
          ) {
            const question = generateDetailQuestion(sentence);
            if (question) {
              details.push(question);
            }
          }
        });

        return details.slice(0, 3);
      }

      function generateDetailQuestion(sentence) {
        const words = sentence.split(' ');

        // Find important words to ask about
        for (let i = 0; i < words.length; i++) {
          const word = words[i];
          if (word.length > 4 && /^[A-ZÃ‡ÄIÃ–ÅÃœa-zÃ§ÄŸÄ±Ã¶ÅŸÃ¼]+$/.test(word)) {
            const questionSentence = sentence.replace(word, '______');

            return {
              question: `"${questionSentence}" cÃ¼mlesindeki boÅŸluÄŸa hangi kelime gelmelidir?`,
              options: [
                word,
                generateSimilarWord(word, 1),
                generateSimilarWord(word, 2),
              ],
              correct: 0,
            };
          }
        }

        return null;
      }

      function generateSimilarWord(word, variant) {
        const alternatives = {
          1: ['farklÄ±', 'baÅŸka', 'diÄŸer', 'Ã¶bÃ¼r', 'Ã¶teki'],
          2: ['yeni', 'eski', 'bÃ¼yÃ¼k', 'kÃ¼Ã§Ã¼k', 'gÃ¼zel'],
        };

        return alternatives[variant][
          Math.floor(Math.random() * alternatives[variant].length)
        ];
      }

      function generateInferenceQuestions(text) {
        const inferences = [];

        // Analyze text for implicit meanings
        if (
          text.toLowerCase().includes('Ã§alÄ±ÅŸ') &&
          text.toLowerCase().includes('baÅŸarÄ±')
        ) {
          inferences.push({
            type: 'multiple',
            question: 'Bu metinden Ã§Ä±karÄ±labilecek ana ders nedir?',
            options: [
              'Ã‡alÄ±ÅŸmak baÅŸarÄ±yÄ± getirir',
              'Åans her ÅŸeyden Ã¶nemlidir',
              'Para mutluluÄŸun anahtarÄ±dÄ±r',
            ],
            correct: 0,
          });
        }

        if (
          text.toLowerCase().includes('zaman') ||
          text.toLowerCase().includes('yÄ±l')
        ) {
          inferences.push({
            type: 'multiple',
            question: 'Metne gÃ¶re zaman kavramÄ± nasÄ±l ele alÄ±nmÄ±ÅŸtÄ±r?',
            options: [
              'Zaman sabÄ±rla deÄŸerlendirilmelidir',
              'Zaman hiÃ§ Ã¶nemli deÄŸildir',
              'Zaman sadece kayÄ±ptÄ±r',
            ],
            correct: 0,
          });
        }

        return inferences;
      }

      function generateContentBasedQuestions(text, sentences, keyWords) {
        const questions = [];

        // Generate questions based on key words
        keyWords.slice(0, 3).forEach((keyword) => {
          const sentenceWithKeyword = sentences.find((s) =>
            s.toLowerCase().includes(keyword)
          );
          if (sentenceWithKeyword) {
            questions.push({
              type: 'multiple',
              question: `"${keyword}" kelimesi metinde hangi baÄŸlamda kullanÄ±lmÄ±ÅŸtÄ±r?`,
              options: [
                extractContextForWord(sentenceWithKeyword, keyword),
                'FarklÄ± bir anlamda kullanÄ±lmÄ±ÅŸtÄ±r',
                'Metinde geÃ§memektedir',
              ],
              correct: 0,
            });
          }
        });

        // Generate comprehension questions
        questions.push({
          type: 'multiple',
          question: 'Bu metnin ana fikri nedir?',
          options: [
            generateMainIdea(text),
            'Metinde ana fikir belirsizdir',
            'Metin sadece bilgi vermektedir',
          ],
          correct: 0,
        });

        return questions;
      }

      function extractContextForWord(sentence, keyword) {
        if (sentence.toLowerCase().includes('Ã§alÄ±ÅŸ'))
          return 'Ã‡alÄ±ÅŸkanlÄ±k baÄŸlamÄ±nda';
        if (sentence.toLowerCase().includes('baÅŸarÄ±'))
          return 'BaÅŸarÄ± baÄŸlamÄ±nda';
        if (sentence.toLowerCase().includes('zaman')) return 'Zaman baÄŸlamÄ±nda';
        if (sentence.toLowerCase().includes('para')) return 'Ekonomik baÄŸlamda';

        return 'Olumlu bir baÄŸlamda';
      }

      function generateMainIdea(text) {
        if (
          text.toLowerCase().includes('Ã§alÄ±ÅŸ') &&
          text.toLowerCase().includes('baÅŸarÄ±')
        ) {
          return 'Ã‡alÄ±ÅŸkanlÄ±ÄŸÄ±n baÅŸarÄ±ya gÃ¶tÃ¼rdÃ¼ÄŸÃ¼';
        }
        if (text.toLowerCase().includes('arkadaÅŸ')) {
          return 'ArkadaÅŸlÄ±ÄŸÄ±n Ã¶nemini anlatan';
        }
        if (text.toLowerCase().includes('doÄŸa')) {
          return 'DoÄŸanÄ±n gÃ¼zelliklerini anlatan';
        }

        return 'Hayattan dersler Ã§Ä±karÄ±labileceÄŸini gÃ¶steren';
      }

      function displayTestPreview(test) {
        const preview = document.getElementById('testPreview');
        const content = document.getElementById('previewContent');

        // Display mode info
        let displayModeInfo = '';
        let displayModeColor = 'bg-blue-50';
        let displayModeIcon = 'ğŸ“„';

        switch (test.textDisplayMode) {
          case 'withQuestions':
            displayModeInfo = 'Her soruyla birlikte metin gÃ¶sterilecek';
            displayModeColor = 'bg-blue-50';
            displayModeIcon = 'ğŸ“„';
            break;
          case 'firstPageOnly':
            displayModeInfo = 'Sadece ilk sayfada metin gÃ¶sterilecek';
            displayModeColor = 'bg-green-50';
            displayModeIcon = 'ğŸ“‹';
            break;
          case 'noText':
            displayModeInfo = 'Metin hiÃ§ gÃ¶sterilmeyecek - DoÄŸrudan sorular';
            displayModeColor = 'bg-orange-50';
            displayModeIcon = 'ğŸš«';
            break;
        }

        let html = `<div class="bg-blue-50 p-4 rounded-lg mb-4">
                <h5 class="font-bold">ğŸ“– ${test.title}</h5>
                <p class="text-sm text-gray-600 mt-2">${test.text.substring(
                  0,
                  200
                )}...</p>
            </div>`;

        html += `<div class="${displayModeColor} p-3 rounded-lg mb-4 border-l-4 border-current">
                <div class="flex items-center gap-2">
                    <span class="text-lg">${displayModeIcon}</span>
                    <strong>GÃ¶rÃ¼ntÃ¼leme Modu:</strong> ${displayModeInfo}
                </div>
            </div>`;

        html += '<div class="grid gap-4">';

        // Group questions by type
        const multipleChoice = test.questions.filter(
          (q) => q.type === 'multiple'
        );
        const fillBlank = test.questions.filter((q) => q.type === 'fillblank');
        const trueFalse = test.questions.filter((q) => q.type === 'truefalse');

        html += `<div class="bg-green-50 p-3 rounded">
                <strong>âœ… Ã‡oktan SeÃ§meli:</strong> ${multipleChoice.length} soru
            </div>`;
        html += `<div class="bg-yellow-50 p-3 rounded">
                <strong>ğŸ“ BoÅŸluk Doldurma:</strong> ${fillBlank.length} soru
            </div>`;
        html += `<div class="bg-purple-50 p-3 rounded">
                <strong>â“ DoÄŸru/YanlÄ±ÅŸ:</strong> ${trueFalse.length} soru
            </div>`;

        html += '</div>';
        content.innerHTML = html;
        preview.classList.remove('hidden');

        currentTest = test;
      }

      async function saveTest() {
        if (currentTest) {
          try {
            if (useSupabase && isSupabaseConfigured) {
              // Save to Supabase
              const supabaseTest = await SupabaseHelper.tests.create({
                title: currentTest.title,
                text: currentTest.text,
                text_display_mode: currentTest.textDisplayMode || 'withQuestions',
                questions: currentTest.questions
              });
              
              // Add ID to local test object
              currentTest.id = supabaseTest.id;
              
            } else {
              // Auto-save data to localStorage
              saveDataToStorage();
            }

            // Add to local array
            tests.push(currentTest);

            alert('Test baÅŸarÄ±yla kaydedildi! âœ…');
            document.getElementById('testPreview').classList.add('hidden');
            document.getElementById('textTitle').value = '';
            document.getElementById('textContent').value = '';
            currentTest = null;

            // Update displays
            populateTestSelect();
            updateStats();
            
          } catch (error) {
            console.error('Test kaydetme hatasÄ±:', error);
            alert('Test kaydedilirken bir hata oluÅŸtu: ' + error.message);
          }
        }
      }

      // Student management functions
      function populateStudentList() {
        const list = document.getElementById('studentList');
        if (students.length === 0) {
          list.innerHTML =
            '<div class="text-gray-500 text-center py-4">HenÃ¼z Ã¶ÄŸrenci eklenmemiÅŸ</div>';
          return;
        }

        list.innerHTML = students
          .map(
            (student, index) =>
              `<div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg border">
                    <div class="flex-1">
                        <div class="font-medium text-gray-900">${student.name}</div>
                        <div class="text-sm text-gray-600">
                            <span class="mr-4">ğŸ‘¤ ${student.studentNumber}</span>
                            <span>ğŸ†” ${student.tcNumber}</span>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="editStudent(${index})" class="text-blue-500 hover:text-blue-700 p-1" title="Ã–ÄŸrenciyi DÃ¼zenle">
                            âœï¸
                        </button>
                        <button onclick="removeStudent(${index})" class="text-red-500 hover:text-red-700 p-1" title="Ã–ÄŸrenciyi Sil">
                            ğŸ—‘ï¸
                        </button>
                    </div>
                </div>`
          )
          .join('');

        updateStats();
      }

      function populateTestSelect() {
        const select = document.getElementById('testSelect');
        select.innerHTML =
          '<option value="">Test seÃ§in...</option>' +
          tests
            .map((test) => `<option value="${test.id}">${test.title}</option>`)
            .join('');
      }

      function populateStudentSelects() {
        const select = document.getElementById('studentSelect');
        if (select) {
          select.innerHTML =
            '<option value="">Ã–ÄŸrenci seÃ§in...</option>' +
            students
              .map(
                (student, index) =>
                  `<option value="${index}">${student.name}</option>`
              )
              .join('');
        }
      }

      async function addStudent() {
        const name = document.getElementById('newStudentName').value.trim();
        const surname = document
          .getElementById('newStudentSurname')
          .value.trim();
        const tcNumber = document.getElementById('newStudentTC').value.trim();
        const studentNumber = document
          .getElementById('newStudentNumber')
          .value.trim();

        // Validation
        if (!name || !surname || !tcNumber || !studentNumber) {
          alert('LÃ¼tfen tÃ¼m alanlarÄ± doldurun!');
          return;
        }

        if (tcNumber.length !== 11 || !/^\d+$/.test(tcNumber)) {
          alert('TC kimlik numarasÄ± 11 haneli olmalÄ±dÄ±r!');
          return;
        }

        // Check for duplicates
        const existingTC = students.find((s) => s.tcNumber === tcNumber);
        const existingStudentNumber = students.find(
          (s) => s.studentNumber === studentNumber
        );

        if (existingTC) {
          alert('Bu TC kimlik numarasÄ± zaten kayÄ±tlÄ±!');
          return;
        }

        if (existingStudentNumber) {
          alert('Bu Ã¶ÄŸrenci numarasÄ± zaten kayÄ±tlÄ±!');
          return;
        }

        const fullName = `${name} ${surname}`;
        const newStudent = {
          name: fullName,
          studentNumber: studentNumber,
          tcNumber: tcNumber,
        };

        try {
          if (useSupabase && isSupabaseConfigured) {
            // Save to Supabase
            const supabaseStudent = await SupabaseHelper.students.create({
              name: fullName,
              student_number: studentNumber,
              tc_number: tcNumber
            });
            
            // Add ID to local student object
            newStudent.id = supabaseStudent.id;
            
            // Initialize student profile in Supabase
            await SupabaseHelper.studentProfiles.create({
              student_id: supabaseStudent.id,
              total_points: 0,
              badges: [],
              tests_completed: 0,
              tests_with_high_score: 0,
              fast_completions: 0,
              retake_successes: 0,
              average_stars: 0,
              total_stars: 0
            });
            
          } else {
            // Initialize student profile for localStorage
            if (!studentProfiles[fullName]) {
              studentProfiles[fullName] = {
                totalPoints: 0,
                badges: [],
                testsCompleted: 0,
                testsWithHighScore: 0,
                fastCompletions: 0,
                retakeSuccesses: 0,
                averageStars: 0,
                totalStars: 0,
              };
            }
            
            // Auto-save data to localStorage
            saveDataToStorage();
          }

          // Add to local array
          students.push(newStudent);

          // Clear form
          document.getElementById('newStudentName').value = '';
          document.getElementById('newStudentSurname').value = '';
          document.getElementById('newStudentTC').value = '';
          document.getElementById('newStudentNumber').value = '';

          populateStudentList();
          populateStudentSelects();
          alert(`${fullName} baÅŸarÄ±yla eklendi! âœ…`);
          
        } catch (error) {
          console.error('Ã–ÄŸrenci ekleme hatasÄ±:', error);
          alert('Ã–ÄŸrenci eklenirken bir hata oluÅŸtu: ' + error.message);
        }
      }

      function editStudent(index) {
        const student = students[index];

        // Create edit modal
        const editModal = document.createElement('div');
        editModal.className =
          'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
        editModal.innerHTML = `
                <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
                    <h3 class="text-xl font-bold mb-4">âœï¸ Ã–ÄŸrenci Bilgilerini DÃ¼zenle</h3>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Ad Soyad</label>
                            <input type="text" id="editStudentName" value="${student.name}" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Ã–ÄŸrenci NumarasÄ±</label>
                            <input type="text" id="editStudentNumber" value="${student.studentNumber}" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">TC Kimlik NumarasÄ±</label>
                            <input type="text" id="editStudentTC" value="${student.tcNumber}" maxlength="11" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                        
                        <div class="bg-yellow-50 p-3 rounded-lg text-sm text-yellow-800">
                            <strong>âš ï¸ UyarÄ±:</strong> TC kimlik numarasÄ± veya Ã¶ÄŸrenci numarasÄ± deÄŸiÅŸtirilirse, Ã¶ÄŸrencinin giriÅŸ bilgileri de deÄŸiÅŸecektir.
                        </div>
                    </div>
                    
                    <div class="flex gap-3 mt-6">
                        <button onclick="saveStudentEdit(${index})" class="bg-green-500 hover:bg-green-600 text-white px-6 py-3 rounded-lg font-medium flex-1">
                            âœ… Kaydet
                        </button>
                        <button onclick="closeEditStudentModal()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-lg font-medium flex-1">
                            âŒ Ä°ptal
                        </button>
                    </div>
                </div>
            `;

        document.body.appendChild(editModal);
        window.currentEditStudentModal = editModal;

        // Focus on name field
        setTimeout(() => {
          document.getElementById('editStudentName').focus();
        }, 100);
      }

      function saveStudentEdit(index) {
        const name = document.getElementById('editStudentName').value.trim();
        const studentNumber = document
          .getElementById('editStudentNumber')
          .value.trim();
        const tcNumber = document.getElementById('editStudentTC').value.trim();

        // Validation
        if (!name || !studentNumber || !tcNumber) {
          alert('LÃ¼tfen tÃ¼m alanlarÄ± doldurun!');
          return;
        }

        if (tcNumber.length !== 11 || !/^\d+$/.test(tcNumber)) {
          alert('TC kimlik numarasÄ± 11 haneli olmalÄ±dÄ±r!');
          return;
        }

        const oldStudent = students[index];

        // Check for duplicates (excluding current student)
        const existingTC = students.find(
          (s, i) => i !== index && s.tcNumber === tcNumber
        );
        const existingStudentNumber = students.find(
          (s, i) => i !== index && s.studentNumber === studentNumber
        );

        if (existingTC) {
          alert(
            'Bu TC kimlik numarasÄ± baÅŸka bir Ã¶ÄŸrenci tarafÄ±ndan kullanÄ±lÄ±yor!'
          );
          return;
        }

        if (existingStudentNumber) {
          alert(
            'Bu Ã¶ÄŸrenci numarasÄ± baÅŸka bir Ã¶ÄŸrenci tarafÄ±ndan kullanÄ±lÄ±yor!'
          );
          return;
        }

        // Update student information
        const updatedStudent = {
          name: name,
          studentNumber: studentNumber,
          tcNumber: tcNumber,
        };

        // If name changed, update test results
        if (oldStudent.name !== name) {
          if (testResults[oldStudent.name]) {
            testResults[name] = testResults[oldStudent.name];
            delete testResults[oldStudent.name];
          }

          // Update student profiles
          if (studentProfiles[oldStudent.name]) {
            studentProfiles[name] = studentProfiles[oldStudent.name];
            delete studentProfiles[oldStudent.name];
          }
        }

        students[index] = updatedStudent;

        populateStudentList();
        populateStudentSelects();
        closeEditStudentModal();

        // Show success message with changes
        let changes = [];
        if (oldStudent.name !== name)
          changes.push(`Ad: "${oldStudent.name}" â†’ "${name}"`);
        if (oldStudent.studentNumber !== studentNumber)
          changes.push(
            `Ã–ÄŸrenci No: "${oldStudent.studentNumber}" â†’ "${studentNumber}"`
          );
        if (oldStudent.tcNumber !== tcNumber)
          changes.push(`TC: "${oldStudent.tcNumber}" â†’ "${tcNumber}"`);

        let message = 'âœ… Ã–ÄŸrenci bilgileri baÅŸarÄ±yla gÃ¼ncellendi!\n\n';
        if (changes.length > 0) {
          message += 'ğŸ“ YapÄ±lan deÄŸiÅŸiklikler:\n' + changes.join('\n');

          if (
            oldStudent.tcNumber !== tcNumber ||
            oldStudent.studentNumber !== studentNumber
          ) {
            message += '\n\nğŸ” GiriÅŸ bilgileri deÄŸiÅŸti:\n';
            message += `â€¢ KullanÄ±cÄ± adÄ±: ${tcNumber}\n`;
            message += `â€¢ Åifre: ${studentNumber}`;
          }
        }

        alert(message);
      }

      function closeEditStudentModal() {
        if (window.currentEditStudentModal) {
          document.body.removeChild(window.currentEditStudentModal);
          window.currentEditStudentModal = null;
        }
      }

      function removeStudent(index) {
        const student = students[index];
        if (
          confirm(
            `${student.name} adlÄ± Ã¶ÄŸrenciyi silmek istediÄŸinizden emin misiniz?\n\nBu iÅŸlem geri alÄ±namaz ve Ã¶ÄŸrencinin tÃ¼m test sonuÃ§larÄ± silinecektir.`
          )
        ) {
          // Remove from students array
          students.splice(index, 1);

          // Remove test results
          delete testResults[student.name];

          populateStudentList();
          populateStudentSelects();
          alert('Ã–ÄŸrenci baÅŸarÄ±yla silindi! ğŸ—‘ï¸');
        }
      }

      function updateStats() {
        document.getElementById('totalStudents').textContent = students.length;
        document.getElementById('totalTests').textContent = tests.length;

        let activeAssignments = 0;
        Object.values(testResults).forEach((results) => {
          activeAssignments += results.filter((r) => !r.completed).length;
        });
        document.getElementById('activeAssignments').textContent =
          activeAssignments;
      }

      function showBulkImport() {
        const modal = document.createElement('div');
        modal.className =
          'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
        modal.innerHTML = `
                <div class="bg-white rounded-lg p-6 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                    <h3 class="text-xl font-bold mb-4">ğŸ“¤ Toplu Ã–ÄŸrenci Ekleme</h3>
                    
                    <div class="space-y-4">
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <h4 class="font-bold text-blue-800 mb-2">ğŸ“‹ Excel Åablonu FormatÄ±</h4>
                            <div class="text-sm text-blue-700">
                                <p class="mb-2">Excel dosyanÄ±zda aÅŸaÄŸÄ±daki sÃ¼tunlar bulunmalÄ±dÄ±r:</p>
                                <ol class="list-decimal list-inside space-y-1">
                                    <li><strong>Ad Soyad</strong> (Ä°lk sÃ¼tun)</li>
                                    <li><strong>Ã–ÄŸrenci NumarasÄ±</strong> (Ä°kinci sÃ¼tun)</li>
                                    <li><strong>TC Kimlik NumarasÄ±</strong> (ÃœÃ§Ã¼ncÃ¼ sÃ¼tun)</li>
                                </ol>
                            </div>
                        </div>
                        
                        <button onclick="downloadStudentTemplate()" class="w-full bg-green-500 hover:bg-green-600 text-white px-4 py-3 rounded-lg font-medium">
                            ğŸ“„ Excel Åablonu Ä°ndir
                        </button>
                        
                        <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center">
                            <input type="file" id="studentFile" accept=".xlsx,.xls,.csv" class="hidden" onchange="importStudents(event)">
                            <div class="mb-4">
                                <div class="text-4xl mb-2">ğŸ“</div>
                                <p class="text-gray-600 mb-2">Excel veya CSV dosyasÄ±nÄ± yÃ¼kleyin</p>
                                <p class="text-sm text-gray-500">Desteklenen formatlar: .xlsx, .xls, .csv</p>
                            </div>
                            <button onclick="document.getElementById('studentFile').click()" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-lg font-medium">
                                ğŸ“¤ Dosya SeÃ§
                            </button>
                        </div>
                        
                        <div class="bg-yellow-50 p-4 rounded-lg">
                            <h4 class="font-bold text-yellow-800 mb-2">âš ï¸ Ã–nemli Notlar</h4>
                            <ul class="text-sm text-yellow-700 space-y-1">
                                <li>â€¢ TC kimlik numaralarÄ± 11 haneli olmalÄ±dÄ±r</li>
                                <li>â€¢ Ã–ÄŸrenci numaralarÄ± benzersiz olmalÄ±dÄ±r</li>
                                <li>â€¢ Mevcut Ã¶ÄŸrencilerle aynÄ± TC veya Ã¶ÄŸrenci numarasÄ± olamaz</li>
                                <li>â€¢ Ä°lk satÄ±r baÅŸlÄ±k satÄ±rÄ± olarak atlanacaktÄ±r</li>
                            </ul>
                        </div>
                    </div>
                    
                    <div class="flex gap-3 mt-6">
                        <button onclick="closeBulkImportModal()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg flex-1">
                            Ä°ptal
                        </button>
                    </div>
                </div>
            `;
        document.body.appendChild(modal);
        window.currentBulkImportModal = modal;
      }

      function downloadStudentTemplate() {
        // Create CSV template with UTF-8 BOM for proper Turkish character support
        const csvContent =
          '\uFEFF' + // UTF-8 BOM
          'Ad Soyad,Ã–ÄŸrenci NumarasÄ±,TC Kimlik NumarasÄ±\n' +
          'Ahmet YÄ±lmaz,2024001,12345678901\n' +
          'AyÅŸe Kaya,2024002,12345678902\n' +
          'Mehmet Ã–zkan,2024003,12345678903\n' +
          'Fatma Åahin,2024004,12345678904\n' +
          'Mustafa Ã‡elik,2024005,12345678905\n' +
          'Zeynep GÃ¼neÅŸ,2024006,12345678906\n' +
          'Emre DoÄŸan,2024007,12345678907\n' +
          'Selin Arslan,2024008,12345678908\n';

        // Create blob with UTF-8 encoding
        const blob = new Blob([csvContent], {
          type: 'text/csv;charset=utf-8;',
        });

        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = 'ogrenci_listesi_sablonu.csv';
        link.click();

        // Show detailed instructions
        const instructions = `
ğŸ“„ Excel ÅŸablonu indirildi!

ğŸ”§ KullanÄ±m TalimatlarÄ±:

1ï¸âƒ£ DOSYAYI AÃ‡MA:
   â€¢ CSV dosyasÄ±nÄ± Excel ile aÃ§Ä±n
   â€¢ TÃ¼rkÃ§e karakterler bozuksa: Veri > Metin SÃ¼tunlara DÃ¶nÃ¼ÅŸtÃ¼r > UTF-8 seÃ§in

2ï¸âƒ£ VERÄ° GÄ°RÄ°ÅÄ°:
   â€¢ Ä°lk satÄ±rÄ± (baÅŸlÄ±klarÄ±) deÄŸiÅŸtirmeyin
   â€¢ Ã–ÄŸrenci bilgilerini Ã¶rnek formatta girin
   â€¢ TC kimlik numaralarÄ± 11 haneli olmalÄ±dÄ±r

3ï¸âƒ£ KAYDETME:
   â€¢ Dosya > FarklÄ± Kaydet > CSV (UTF-8) formatÄ±nÄ± seÃ§in
   â€¢ Veya Excel formatÄ±nda (.xlsx) kaydedin

4ï¸âƒ£ YÃœKLEME:
   â€¢ Sisteme geri yÃ¼kleyin
   â€¢ TÃ¼rkÃ§e karakterler otomatik dÃ¼zeltilecektir

ğŸ’¡ Ä°pucu: TÃ¼rkÃ§e karakter sorunu yaÅŸarsanÄ±z dosyayÄ± Excel formatÄ±nda (.xlsx) kaydetmeyi deneyin.
            `;

        alert(instructions);
      }

      function importStudents(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function (e) {
          try {
            let text = e.target.result;

            // Handle different encodings and BOM
            if (text.charCodeAt(0) === 0xfeff) {
              text = text.substr(1); // Remove BOM
            }

            // Try to detect and fix encoding issues
            if (
              text.includes('ÃƒÂ¼') ||
              text.includes('ÃƒÂ§') ||
              text.includes('Ã„Â±')
            ) {
              // Common UTF-8 to Latin-1 encoding issues
              text = text
                .replace(/ÃƒÂ¼/g, 'Ã¼')
                .replace(/ÃƒÂ§/g, 'Ã§')
                .replace(/Ã„Â±/g, 'Ä±')
                .replace(/Ã„Â°/g, 'Ä°')
                .replace(/ÃƒÂ¶/g, 'Ã¶')
                .replace(/Ãƒâ€“/g, 'Ã–')
                .replace(/ÃƒÂ¤/g, 'Ã¤')
                .replace(/Ãƒâ€/g, 'Ã„')
                .replace(/Ã…Å¾/g, 'ÅŸ')
                .replace(/Ã…/g, 'Å')
                .replace(/Ã„Å¸/g, 'ÄŸ')
                .replace(/Ã„Å¾/g, 'Ä');
            }

            const lines = text.split(/\r?\n/).filter((line) => line.trim());

            if (lines.length < 2) {
              throw new Error(
                'Dosyada yeterli veri bulunamadÄ±!\n\nEn az 2 satÄ±r (baÅŸlÄ±k + 1 Ã¶ÄŸrenci) olmalÄ±dÄ±r.'
              );
            }

            const importedStudents = [];
            const errors = [];

            // Skip header row (index 0)
            for (let i = 1; i < lines.length; i++) {
              const line = lines[i].trim();
              if (!line) continue;

              // Handle different separators and quoted values
              let columns;
              if (line.includes('\t')) {
                // Tab separated
                columns = line.split('\t');
              } else if (line.includes(';')) {
                // Semicolon separated (common in European Excel)
                columns = line.split(';');
              } else {
                // Comma separated
                columns = line.split(',');
              }

              // Clean up columns
              columns = columns.map((col) => {
                return col
                  .trim()
                  .replace(/^["']|["']$/g, '') // Remove quotes
                  .replace(/\s+/g, ' ') // Normalize spaces
                  .trim();
              });

              if (columns.length < 3) {
                errors.push(
                  `SatÄ±r ${i + 1}: Eksik sÃ¼tun (3 sÃ¼tun gerekli, ${
                    columns.length
                  } bulundu)`
                );
                continue;
              }

              let [name, studentNumber, tcNumber] = columns;

              // Additional Turkish character fixes
              name = fixTurkishChars(name);
              studentNumber = studentNumber.toString().trim();
              tcNumber = tcNumber.toString().replace(/\D/g, ''); // Keep only digits

              // Validation
              if (!name || !studentNumber || !tcNumber) {
                errors.push(
                  `SatÄ±r ${
                    i + 1
                  }: BoÅŸ alan var (Ad: "${name}", Ã–ÄŸrenci No: "${studentNumber}", TC: "${tcNumber}")`
                );
                continue;
              }

              if (tcNumber.length !== 11) {
                errors.push(
                  `SatÄ±r ${
                    i + 1
                  }: TC kimlik numarasÄ± 11 haneli olmalÄ±dÄ±r (${tcNumber} - ${
                    tcNumber.length
                  } hane)`
                );
                continue;
              }

              // Check for duplicates in existing students
              const existingTC = students.find((s) => s.tcNumber === tcNumber);
              const existingStudentNumber = students.find(
                (s) => s.studentNumber === studentNumber
              );

              if (existingTC) {
                errors.push(
                  `SatÄ±r ${
                    i + 1
                  }: TC kimlik numarasÄ± zaten kayÄ±tlÄ± (${tcNumber} - ${
                    existingTC.name
                  })`
                );
                continue;
              }

              if (existingStudentNumber) {
                errors.push(
                  `SatÄ±r ${
                    i + 1
                  }: Ã–ÄŸrenci numarasÄ± zaten kayÄ±tlÄ± (${studentNumber} - ${
                    existingStudentNumber.name
                  })`
                );
                continue;
              }

              // Check for duplicates in imported data
              const duplicateTC = importedStudents.find(
                (s) => s.tcNumber === tcNumber
              );
              const duplicateStudentNumber = importedStudents.find(
                (s) => s.studentNumber === studentNumber
              );

              if (duplicateTC) {
                errors.push(
                  `SatÄ±r ${
                    i + 1
                  }: Dosyada tekrarlanan TC kimlik numarasÄ± (${tcNumber})`
                );
                continue;
              }

              if (duplicateStudentNumber) {
                errors.push(
                  `SatÄ±r ${
                    i + 1
                  }: Dosyada tekrarlanan Ã¶ÄŸrenci numarasÄ± (${studentNumber})`
                );
                continue;
              }

              importedStudents.push({
                name: name,
                studentNumber: studentNumber,
                tcNumber: tcNumber,
              });
            }

            if (importedStudents.length === 0) {
              throw new Error(
                'Ä°Ã§e aktarÄ±lacak geÃ§erli Ã¶ÄŸrenci bulunamadÄ±!\n\nLÃ¼tfen dosya formatÄ±nÄ± ve iÃ§eriÄŸini kontrol edin.'
              );
            }

            // Add imported students
            students.push(...importedStudents);

            populateStudentList();
            populateStudentSelects();
            closeBulkImportModal();

            let message = `âœ… ${importedStudents.length} Ã¶ÄŸrenci baÅŸarÄ±yla iÃ§e aktarÄ±ldÄ±!\n\n`;

            // Show first few imported students
            const sampleStudents = importedStudents.slice(0, 3);
            message += 'ğŸ“‹ Ä°Ã§e aktarÄ±lan Ã¶ÄŸrenciler:\n';
            sampleStudents.forEach((student) => {
              message += `â€¢ ${student.name} (${student.studentNumber})\n`;
            });

            if (importedStudents.length > 3) {
              message += `... ve ${importedStudents.length - 3} Ã¶ÄŸrenci daha\n`;
            }

            if (errors.length > 0) {
              message += `\nâš ï¸ ${
                errors.length
              } satÄ±rda hata tespit edildi:\n${errors.slice(0, 3).join('\n')}`;
              if (errors.length > 3) {
                message += `\n... ve ${errors.length - 3} hata daha`;
              }
              message +=
                '\n\nğŸ’¡ HatalÄ± satÄ±rlarÄ± dÃ¼zeltip tekrar yÃ¼kleyebilirsiniz.';
            }

            alert(message);
          } catch (error) {
            alert(
              'Dosya okuma hatasÄ±: ' +
                error.message +
                "\n\nğŸ’¡ Ä°puÃ§larÄ±:\nâ€¢ DosyayÄ± UTF-8 kodlamasÄ±nda kaydedin\nâ€¢ Excel'den CSV olarak kaydetmeyi deneyin\nâ€¢ TÃ¼rkÃ§e karakterlerin doÄŸru gÃ¶rÃ¼ntÃ¼lendiÄŸinden emin olun"
            );
          }
        };

        // Try reading with UTF-8 first, then fallback to other encodings
        reader.readAsText(file, 'UTF-8');
      }

      // Helper function to fix Turkish character encoding issues
      function fixTurkishChars(text) {
        if (!text) return text;

        return (
          text
            // Fix common encoding issues
            .replace(/ÃƒÂ¼/g, 'Ã¼')
            .replace(/Ãƒâ€¡/g, 'Ã‡')
            .replace(/ÃƒÂ§/g, 'Ã§')
            .replace(/Ã„Â±/g, 'Ä±')
            .replace(/Ã„Â°/g, 'Ä°')
            .replace(/ÃƒÂ¶/g, 'Ã¶')
            .replace(/Ãƒâ€“/g, 'Ã–')
            .replace(/Ã…Å¾/g, 'ÅŸ')
            .replace(/Ã…/g, 'Å')
            .replace(/Ã„Å¸/g, 'ÄŸ')
            .replace(/Ã„Å¾/g, 'Ä')
            .replace(/ÃƒÂ¼/g, 'Ã¼')
            // Additional fixes for double-encoded characters
            .replace(/ÃƒÂ¢Ã¢â€šÂ¬Ã…Â¾/g, 'ÅŸ')
            .replace(/ÃƒÂ¢Ã¢â€šÂ¬Ã…/g, 'Å')
            .replace(/ÃƒÂ¢Ã¢â€šÂ¬Ã…Â¸/g, 'ÄŸ')
            .replace(/ÃƒÂ¢Ã¢â€šÂ¬Ã…Â¾/g, 'Ä')
            // Normalize whitespace
            .replace(/\s+/g, ' ')
            .trim()
        );
      }

      function exportStudents() {
        if (students.length === 0) {
          alert('DÄ±ÅŸa aktarÄ±lacak Ã¶ÄŸrenci bulunamadÄ±!');
          return;
        }

        let csvContent = 'Ad Soyad,Ã–ÄŸrenci NumarasÄ±,TC Kimlik NumarasÄ±\n';
        students.forEach((student) => {
          csvContent += `"${student.name}","${student.studentNumber}","${student.tcNumber}"\n`;
        });

        const blob = new Blob([csvContent], {
          type: 'text/csv;charset=utf-8;',
        });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `ogrenci_listesi_${
          new Date().toISOString().split('T')[0]
        }.csv`;
        link.click();

        alert(`${students.length} Ã¶ÄŸrenci CSV formatÄ±nda dÄ±ÅŸa aktarÄ±ldÄ±! ğŸ“„`);
      }

      function closeBulkImportModal() {
        if (window.currentBulkImportModal) {
          document.body.removeChild(window.currentBulkImportModal);
          window.currentBulkImportModal = null;
        }
      }

      async function assignTest() {
        const testId = document.getElementById('testSelect').value;
        const studentIndex = document.getElementById('studentSelect').value;

        if (!testId || studentIndex === '') {
          alert('LÃ¼tfen test ve Ã¶ÄŸrenci seÃ§in!');
          return;
        }

        const test = tests.find((t) => t.id == testId);
        const student = students[parseInt(studentIndex)];

        if (!student) {
          alert('SeÃ§ilen Ã¶ÄŸrenci bulunamadÄ±!');
          return;
        }

        if (!testResults[student.name]) {
          testResults[student.name] = [];
        }

        // Check if test is already assigned
        const existingAssignment = testResults[student.name].find(
          (r) => r.testId == testId
        );
        if (existingAssignment) {
          alert(
            `${test.title} testi ${student.name} adlÄ± Ã¶ÄŸrenciye zaten atanmÄ±ÅŸ!`
          );
          return;
        }

        const newAssignment = {
          testId: testId,
          testTitle: test.title,
          assigned: true,
          completed: false,
          score: null,
        };

        try {
          if (useSupabase && isSupabaseConfigured && student.id) {
            // Save to Supabase
            const supabaseResult = await SupabaseHelper.testResults.assignTest(
              student.id,
              testId
            );
            
            // Add Supabase ID to local assignment
            newAssignment.supabaseId = supabaseResult.id;
          } else {
            // Auto-save data to localStorage
            saveDataToStorage();
          }

          // Add to local array
          testResults[student.name].push(newAssignment);

          alert(`${test.title} testi ${student.name} adlÄ± Ã¶ÄŸrenciye atandÄ±! âœ…`);
          updateStats();
          
        } catch (error) {
          console.error('Test atama hatasÄ±:', error);
          alert('Test atanÄ±rken bir hata oluÅŸtu: ' + error.message);
        }
      }

      // Student functions
      function populateStudentLogin() {
        populateStudentSelects();
      }

      function studentLogin() {
        const tcNumber = document.getElementById('studentTCInput').value.trim();
        const studentNumber = document
          .getElementById('studentNumberInput')
          .value.trim();

        if (!tcNumber || !studentNumber) {
          alert('LÃ¼tfen TC kimlik numaranÄ±zÄ± ve Ã¶ÄŸrenci numaranÄ±zÄ± girin!');
          return;
        }

        if (tcNumber.length !== 11 || !/^\d+$/.test(tcNumber)) {
          alert('TC kimlik numarasÄ± 11 haneli olmalÄ±dÄ±r!');
          return;
        }

        // Find student with matching credentials
        const student = students.find(
          (s) => s.tcNumber === tcNumber && s.studentNumber === studentNumber
        );

        if (!student) {
          alert(
            'GiriÅŸ bilgileri hatalÄ±! LÃ¼tfen TC kimlik numaranÄ±zÄ± ve Ã¶ÄŸrenci numaranÄ±zÄ± kontrol edin.'
          );
          return;
        }

        currentUser = student.name;
        document.getElementById('currentStudentName').textContent =
          student.name;
        document.getElementById('studentLogin').classList.add('hidden');
        document.getElementById('studentDashboard').classList.remove('hidden');

        // Clear login form
        document.getElementById('studentTCInput').value = '';
        document.getElementById('studentNumberInput').value = '';

        displayStudentProfile();
        displayAssignedTests();
        alert(`HoÅŸ geldiniz, ${student.name}! ğŸ‰`);
      }

      function displayStudentProfile() {
        // Ensure profile exists
        if (!studentProfiles[currentUser]) {
          studentProfiles[currentUser] = {
            totalPoints: 0,
            badges: [],
            testsCompleted: 0,
            testsWithHighScore: 0,
            fastCompletions: 0,
            retakeSuccesses: 0,
            averageStars: 0,
            totalStars: 0,
          };
        }

        const profile = studentProfiles[currentUser];
        if (!profile) return;

        // Display stats
        const statsContainer = document.getElementById('studentStats');
        statsContainer.innerHTML = `
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                    <div class="text-center">
                        <div class="text-2xl font-bold">${
                          profile.totalPoints
                        }</div>
                        <div class="text-blue-200">Toplam Puan</div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold">${
                          profile.testsCompleted
                        }</div>
                        <div class="text-blue-200">Test SayÄ±sÄ±</div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold">${profile.averageStars.toFixed(
                          1
                        )}</div>
                        <div class="text-blue-200">Ortalama â­</div>
                    </div>
                    <div class="text-center">
                        <div class="text-2xl font-bold">${
                          profile.badges.length
                        }</div>
                        <div class="text-blue-200">Rozet SayÄ±sÄ±</div>
                    </div>
                </div>
            `;

        // Display badges
        const badgesContainer = document.getElementById('studentBadges');
        if (profile.badges.length > 0) {
          const badgeElements = profile.badges
            .map((badgeId) => {
              const badge = Object.values(BADGES).find((b) => b.id === badgeId);
              return badge
                ? `
                        <div class="inline-flex items-center gap-2 bg-white bg-opacity-20 rounded-full px-3 py-1 text-sm">
                            <span class="text-lg">${badge.icon}</span>
                            <span>${badge.name}</span>
                        </div>
                    `
                : '';
            })
            .join('');

          badgesContainer.innerHTML = `
                    <div class="mb-2 text-sm font-medium">ğŸ† Rozetlerim:</div>
                    <div class="flex flex-wrap gap-2">
                        ${badgeElements}
                    </div>
                `;
        } else {
          badgesContainer.innerHTML = `
                    <div class="text-sm text-blue-200">
                        ğŸ† HenÃ¼z rozet kazanmadÄ±nÄ±z. Ä°lk testinizi Ã§Ã¶zerek baÅŸlayÄ±n!
                    </div>
                `;
        }
      }

      function displayAssignedTests() {
        const container = document.getElementById('assignedTests');
        const studentTests = testResults[currentUser] || [];

        if (studentTests.length === 0) {
          container.innerHTML =
            '<p class="text-gray-500 text-center py-8">HenÃ¼z size atanmÄ±ÅŸ test bulunmuyor.</p>';
          return;
        }

        container.innerHTML = studentTests
          .map((result) => {
            const test = tests.find((t) => t.id == result.testId);
            if (!test) return '';

            let statusBadge = '';
            let actionButton = '';
            let starsDisplay = '';
            let pointsDisplay = '';
            let testModeInfo = '';

            // Add test mode information
            if (test.textDisplayMode) {
              let modeIcon = 'ğŸ“„';
              let modeText = 'Metin her soruda gÃ¶sterilir';

              switch (test.textDisplayMode) {
                case 'firstPageOnly':
                  modeIcon = 'ğŸ“‹';
                  modeText = 'Ã–nce metin okunur, sonra sorular';
                  break;
                case 'noText':
                  modeIcon = 'ğŸš«';
                  modeText = 'Sadece sorular (metin yok)';
                  break;
              }

              testModeInfo = `<div class="text-xs text-gray-500 mt-1 flex items-center gap-1">
                        <span>${modeIcon}</span>
                        <span>${modeText}</span>
                    </div>`;
            }

            if (result.completed) {
              const passed = result.score >= 70;
              const stars = result.stars || 0;
              const points = result.points || 0;

              starsDisplay = stars > 0 ? getStarsDisplay(stars) : 'â­ Yok';
              pointsDisplay = `${points}/100 puan`;

              statusBadge = `<div class="flex items-center gap-2">
                        <span class="px-2 py-1 rounded text-sm ${
                          passed
                            ? 'bg-green-100 text-green-800'
                            : 'bg-red-100 text-red-800'
                        }">
                            ${passed ? 'âœ… BaÅŸarÄ±lÄ±' : 'âŒ BaÅŸarÄ±sÄ±z'} (%${
                result.score
              })
                        </span>
                        <span class="text-sm text-gray-600">${starsDisplay}</span>
                    </div>`;

              if (!passed) {
                actionButton = `<div class="text-center">
                            <div class="text-sm text-gray-600 italic mb-2">
                                Ã–ÄŸretmeninizin tekrar atamasÄ±nÄ± bekleyin
                            </div>
                            <div class="text-xs text-gray-500">${pointsDisplay}</div>
                        </div>`;
              } else {
                actionButton = `<div class="text-center">
                            <div class="text-sm text-green-600 font-medium mb-1">TamamlandÄ±! ğŸ‰</div>
                            <div class="text-xs text-gray-500">${pointsDisplay}</div>
                        </div>`;
              }
            } else {
              statusBadge =
                '<span class="px-2 py-1 rounded text-sm bg-blue-100 text-blue-800">ğŸ“‹ Bekliyor</span>';
              actionButton = `<button onclick="startTest(${test.id})" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg font-medium transition-colors">
                        ğŸš€ Teste BaÅŸla
                    </button>`;
            }

            return `<div class="border rounded-lg p-4 hover:shadow-md transition-shadow">
                    <div class="flex justify-between items-center">
                        <div class="flex-1">
                            <h4 class="font-bold text-lg">${test.title}</h4>
                            <p class="text-sm text-gray-600 mb-2">
                                ${test.questions.length} soru â€¢ BaÅŸarÄ± kriteri: %70 â€¢ 
                                <span class="text-blue-600">Maksimum 100 puan</span>
                            </p>
                            ${testModeInfo}
                            ${statusBadge}
                        </div>
                        <div class="ml-4">
                            ${actionButton}
                        </div>
                    </div>
                </div>`;
          })
          .join('');
      }

      function startTest(testId) {
        const test = tests.find((t) => t.id == testId);
        if (!test) return;

        currentTest = test;
        currentQuestionIndex = 0;
        studentAnswers = {};
        testStartTime = new Date(); // Record start time for gamification
        questionFontSizes = {}; // Reset font sizes for new test
        currentFontSize = 16; // Reset to default
        currentTextFontSize = 16; // Reset text font size to default

        // Clear any existing timer
        if (questionTimer) {
          clearInterval(questionTimer);
          questionTimer = null;
        }

        document.getElementById('studentDashboard').classList.add('hidden');

        // Handle different text display modes
        if (test.textDisplayMode === 'firstPageOnly') {
          // Show text first, then questions
          showTextFirstPage(test);
        } else {
          // Go directly to test interface
          document.getElementById('testInterface').classList.remove('hidden');

          document.getElementById('testTitle').textContent = test.title;

          // Handle text display based on mode
          const textDisplay = document.getElementById('textDisplay');
          const textContent = document.getElementById('textContent');
          if (test.textDisplayMode === 'noText') {
            textDisplay.style.display = 'none';
          } else {
            textDisplay.style.display = 'block';
            textContent.textContent = test.text;
            // Apply current text font size
            applyTextFontSize();
            updateTextFontSizeDisplay();
          }

          document.getElementById('totalQuestions').textContent =
            test.questions.length;

          displayQuestion();
        }
      }

      // Timer functions
      function startQuestionTimer() {
        // Clear any existing timer
        if (questionTimer) {
          clearInterval(questionTimer);
        }

        questionTimeLeft = 120; // Reset to 120 seconds
        questionStartTime = new Date();
        updateTimerDisplay();

        questionTimer = setInterval(() => {
          questionTimeLeft--;
          updateTimerDisplay();

          if (questionTimeLeft <= 0) {
            // Time's up - auto advance to next question
            clearInterval(questionTimer);
            questionTimer = null;

            // Show time up notification
            showTimeUpNotification();

            // Auto advance after a brief delay
            setTimeout(() => {
              autoAdvanceQuestion();
            }, 1500);
          }
        }, 1000);
      }

      function updateTimerDisplay() {
        const minutes = Math.floor(questionTimeLeft / 60);
        const seconds = questionTimeLeft % 60;
        const timeText = `${minutes}:${seconds.toString().padStart(2, '0')}`;

        const timerElement = document.getElementById('timerText');
        const timerContainer = document.getElementById('questionTimerDisplay');

        if (timerElement) {
          timerElement.textContent = timeText;

          // Change colors based on remaining time
          if (questionTimeLeft <= 10) {
            // Critical time - red and blinking
            timerContainer.className =
              'flex items-center gap-2 bg-red-100 border-2 border-red-500 rounded-lg px-4 py-2 animate-pulse';
            timerElement.className = 'text-lg font-bold text-red-800';
          } else if (questionTimeLeft <= 30) {
            // Warning time - orange
            timerContainer.className =
              'flex items-center gap-2 bg-orange-50 border-2 border-orange-400 rounded-lg px-4 py-2';
            timerElement.className = 'text-lg font-bold text-orange-700';
          } else {
            // Normal time - red
            timerContainer.className =
              'flex items-center gap-2 bg-red-50 border-2 border-red-200 rounded-lg px-4 py-2';
            timerElement.className = 'text-lg font-bold text-red-700';
          }
        }
      }

      function showTimeUpNotification() {
        // Create and show time up notification
        const notification = document.createElement('div');
        notification.className =
          'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
        notification.innerHTML = `
                <div class="bg-white rounded-lg p-6 max-w-md mx-4 text-center animate-pulse">
                    <div class="text-6xl mb-4">â°</div>
                    <h3 class="text-2xl font-bold text-red-600 mb-2">SÃ¼re Doldu!</h3>
                    <p class="text-gray-600">Sonraki soruya geÃ§iliyor...</p>
                </div>
            `;

        document.body.appendChild(notification);

        // Remove notification after 1.5 seconds
        setTimeout(() => {
          if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
          }
        }, 1500);
      }

      function autoAdvanceQuestion() {
        if (currentQuestionIndex < currentTest.questions.length - 1) {
          currentQuestionIndex++;
          displayQuestion();
        } else {
          // Last question - submit test
          submitTest();
        }
      }

      function stopQuestionTimer() {
        if (questionTimer) {
          clearInterval(questionTimer);
          questionTimer = null;
        }
      }

      function showTextFirstPage(test) {
        document.getElementById('textFirstPage').classList.remove('hidden');
        document.getElementById('textFirstPageTitle').textContent = test.title;
        document.getElementById('textFirstPageContent').textContent = test.text;

        // Apply current text font size and update display
        applyTextFontSizeToFirstPage();
        updateTextFontSizeDisplayForFirstPage();
      }

      function proceedToQuestions() {
        document.getElementById('textFirstPage').classList.add('hidden');
        document.getElementById('testInterface').classList.remove('hidden');

        document.getElementById('testTitle').textContent = currentTest.title;
        document.getElementById('totalQuestions').textContent =
          currentTest.questions.length;

        // Hide text display since it was shown on first page
        document.getElementById('textDisplay').style.display = 'none';

        displayQuestion();
      }

      function displayQuestion() {
        const question = currentTest.questions[currentQuestionIndex];
        const display = document.getElementById('questionDisplay');

        document.getElementById('currentQuestion').textContent =
          currentQuestionIndex + 1;
        updateProgressBar();

        // Start timer for this question
        startQuestionTimer();

        // Get or set font size for current question - preserve last used size
        if (!questionFontSizes[currentQuestionIndex]) {
          questionFontSizes[currentQuestionIndex] = currentFontSize; // Use current size instead of default
        }
        currentFontSize = questionFontSizes[currentQuestionIndex];
        updateFontSizeDisplay();

        // Apply text font size to text content
        applyTextFontSize();
        updateTextFontSizeDisplay();

        let html = `<h4 class="text-lg font-bold mb-4">Soru ${
          currentQuestionIndex + 1
        }</h4>`;
        html += `<p id="questionText" class="mb-4" style="font-size: ${currentFontSize}px; line-height: 1.6;">${question.question}</p>`;

        if (question.type === 'multiple') {
          html += '<div class="space-y-2">';
          question.options.forEach((option, index) => {
            const checked =
              studentAnswers[currentQuestionIndex] === index ? 'checked' : '';
            html += `<label class="option flex items-center p-2 border rounded hover:bg-gray-50 cursor-pointer" style="font-size: ${currentFontSize}px; line-height: 1.6;">
                        <input type="radio" name="answer" value="${index}" ${checked} onchange="saveAnswer(${index})" class="mr-3">
                        ${option}
                    </label>`;
          });
          html += '</div>';
        } else if (question.type === 'fillblank') {
          // Display the sentence with the selected word or blank
          const selectedWord = studentAnswers[currentQuestionIndex] || '______';
          const questionWithAnswer = question.question.replace(
            '_____',
            `<span class="bg-yellow-200 px-2 py-1 rounded font-bold">${selectedWord}</span>`
          );
          html += `<div class="bg-blue-50 p-3 rounded-lg mb-4">
                    <p class="text-lg" style="font-size: ${currentFontSize}px; line-height: 1.6;">${questionWithAnswer}</p>
                </div>`;

          html += `<p class="mb-2 text-sm text-gray-600" style="font-size: ${Math.max(
            12,
            currentFontSize - 2
          )}px;">Kelime bankasÄ±ndan uygun kelimeyi seÃ§in:</p>`;
          html += '<div class="flex flex-wrap gap-2 mb-4">';
          question.wordBank.forEach((word, index) => {
            const selected =
              studentAnswers[currentQuestionIndex] === word
                ? 'bg-blue-500 text-white'
                : 'bg-gray-200';
            html += `<button onclick="saveAnswer('${word}'); displayQuestion();" class="px-3 py-1 rounded ${selected} hover:bg-blue-400 hover:text-white transition-colors" style="font-size: ${currentFontSize}px;">
                        ${word}
                    </button>`;
          });
          html += '</div>';
        } else if (question.type === 'truefalse') {
          const trueChecked =
            studentAnswers[currentQuestionIndex] === true ? 'checked' : '';
          const falseChecked =
            studentAnswers[currentQuestionIndex] === false ? 'checked' : '';
          html += `<div class="space-y-2">
                    <label class="option flex items-center p-2 border rounded hover:bg-gray-50 cursor-pointer" style="font-size: ${currentFontSize}px; line-height: 1.6;">
                        <input type="radio" name="answer" value="true" ${trueChecked} onchange="saveAnswer(true)" class="mr-3">
                        DoÄŸru
                    </label>
                    <label class="option flex items-center p-2 border rounded hover:bg-gray-50 cursor-pointer" style="font-size: ${currentFontSize}px; line-height: 1.6;">
                        <input type="radio" name="answer" value="false" ${falseChecked} onchange="saveAnswer(false)" class="mr-3">
                        YanlÄ±ÅŸ
                    </label>
                </div>`;
        }

        display.innerHTML = html;
        updateNavigationButtons();
      }

      function saveAnswer(answer) {
        studentAnswers[currentQuestionIndex] = answer;
      }

      function updateProgressBar() {
        const progress =
          ((currentQuestionIndex + 1) / currentTest.questions.length) * 100;
        document.getElementById('progressBar').style.width = progress + '%';
      }

      function updateNavigationButtons() {
        const nextBtn = document.getElementById('nextBtn');
        const submitBtn = document.getElementById('submitBtn');

        if (!nextBtn || !submitBtn) {
          console.error('Navigation buttons not found:', {
            nextBtn,
            submitBtn,
          });
          return;
        }

        if (currentQuestionIndex === currentTest.questions.length - 1) {
          nextBtn.classList.add('hidden');
          submitBtn.classList.remove('hidden');
          console.log('Last question - showing submit button');
        } else {
          nextBtn.classList.remove('hidden');
          submitBtn.classList.add('hidden');
          console.log('Not last question - showing next button');
        }
      }

      // Font size control functions
      function increaseFontSize() {
        if (currentFontSize < 32) {
          // Maximum font size limit
          currentFontSize += 2;
          questionFontSizes[currentQuestionIndex] = currentFontSize;
          applyFontSize();
          updateFontSizeDisplay();

          // Show feedback
          showFontSizeFeedback('YazÄ± boyutu artÄ±rÄ±ldÄ±', 'green');
        } else {
          showFontSizeFeedback('Maksimum yazÄ± boyutuna ulaÅŸÄ±ldÄ±', 'orange');
        }
      }

      function decreaseFontSize() {
        if (currentFontSize > 10) {
          // Minimum font size limit
          currentFontSize -= 2;
          questionFontSizes[currentQuestionIndex] = currentFontSize;
          applyFontSize();
          updateFontSizeDisplay();

          // Show feedback
          showFontSizeFeedback('YazÄ± boyutu azaltÄ±ldÄ±', 'red');
        } else {
          showFontSizeFeedback('Minimum yazÄ± boyutuna ulaÅŸÄ±ldÄ±', 'orange');
        }
      }

      function resetFontSize() {
        currentFontSize = 16; // Reset to default
        questionFontSizes[currentQuestionIndex] = currentFontSize;
        applyFontSize();
        updateFontSizeDisplay();

        // Show feedback
        showFontSizeFeedback('YazÄ± boyutu sÄ±fÄ±rlandÄ±', 'blue');
      }

      function applyFontSize() {
        const questionText = document.getElementById('questionText');
        if (questionText) {
          questionText.style.fontSize = currentFontSize + 'px';
          questionText.style.lineHeight = '1.6';
        }

        // Also apply to options if they exist
        const options = document.querySelectorAll(
          '#questionDisplay .option, #questionDisplay label'
        );
        options.forEach((option) => {
          option.style.fontSize = currentFontSize + 'px';
          option.style.lineHeight = '1.6';
        });
      }

      function updateFontSizeDisplay() {
        const display = document.getElementById('fontSizeDisplay');
        if (display) {
          display.textContent = currentFontSize + 'px';

          // Update color based on size
          if (currentFontSize === 16) {
            display.className =
              'text-sm font-medium text-gray-700 min-w-[3rem] text-center';
          } else if (currentFontSize > 16) {
            display.className =
              'text-sm font-medium text-green-700 min-w-[3rem] text-center';
          } else {
            display.className =
              'text-sm font-medium text-red-700 min-w-[3rem] text-center';
          }
        }
      }

      function showFontSizeFeedback(message, color) {
        // Create temporary feedback element
        const feedback = document.createElement('div');
        feedback.className = `fixed top-20 right-4 bg-${color}-500 text-white px-4 py-2 rounded-lg shadow-lg z-50 transition-all duration-300`;
        feedback.textContent = message;
        feedback.style.transform = 'translateX(100%)';

        document.body.appendChild(feedback);

        // Animate in
        setTimeout(() => {
          feedback.style.transform = 'translateX(0)';
        }, 10);

        // Animate out and remove
        setTimeout(() => {
          feedback.style.transform = 'translateX(100%)';
          setTimeout(() => {
            if (feedback.parentNode) {
              feedback.parentNode.removeChild(feedback);
            }
          }, 300);
        }, 2000);
      }

      // Text font size control functions
      function increaseTextFontSize() {
        if (currentTextFontSize < 32) {
          // Maximum font size limit
          currentTextFontSize += 2;
          applyTextFontSize();
          updateTextFontSizeDisplay();
          applyTextFontSizeToFirstPage();
          updateTextFontSizeDisplayForFirstPage();

          // Show feedback
          showFontSizeFeedback('Metin boyutu artÄ±rÄ±ldÄ±', 'green');
        } else {
          showFontSizeFeedback('Maksimum metin boyutuna ulaÅŸÄ±ldÄ±', 'orange');
        }
      }

      function decreaseTextFontSize() {
        if (currentTextFontSize > 10) {
          // Minimum font size limit
          currentTextFontSize -= 2;
          applyTextFontSize();
          updateTextFontSizeDisplay();
          applyTextFontSizeToFirstPage();
          updateTextFontSizeDisplayForFirstPage();

          // Show feedback
          showFontSizeFeedback('Metin boyutu azaltÄ±ldÄ±', 'red');
        } else {
          showFontSizeFeedback('Minimum metin boyutuna ulaÅŸÄ±ldÄ±', 'orange');
        }
      }

      function resetTextFontSize() {
        currentTextFontSize = 16; // Reset to default
        applyTextFontSize();
        updateTextFontSizeDisplay();
        applyTextFontSizeToFirstPage();
        updateTextFontSizeDisplayForFirstPage();

        // Show feedback
        showFontSizeFeedback('Metin boyutu sÄ±fÄ±rlandÄ±', 'blue');
      }

      function applyTextFontSize() {
        const textContent = document.getElementById('textContent');
        if (textContent) {
          textContent.style.fontSize = currentTextFontSize + 'px';
          textContent.style.lineHeight = '1.6';
        }
      }

      function updateTextFontSizeDisplay() {
        const display = document.getElementById('textFontSizeDisplay');
        if (display) {
          display.textContent = currentTextFontSize + 'px';

          // Update color based on size
          if (currentTextFontSize === 16) {
            display.className =
              'text-sm font-medium text-gray-700 min-w-[3rem] text-center';
          } else if (currentTextFontSize > 16) {
            display.className =
              'text-sm font-medium text-green-700 min-w-[3rem] text-center';
          } else {
            display.className =
              'text-sm font-medium text-red-700 min-w-[3rem] text-center';
          }
        }
      }

      function applyTextFontSizeToFirstPage() {
        const textContent = document.getElementById('textFirstPageContent');
        if (textContent) {
          textContent.style.fontSize = currentTextFontSize + 'px';
          textContent.style.lineHeight = '1.6';
        }
      }

      function updateTextFontSizeDisplayForFirstPage() {
        const display = document.getElementById('textFirstPageFontSizeDisplay');
        if (display) {
          display.textContent = currentTextFontSize + 'px';

          // Update color based on size
          if (currentTextFontSize === 16) {
            display.className =
              'text-sm font-medium text-gray-700 min-w-[3rem] text-center';
          } else if (currentTextFontSize > 16) {
            display.className =
              'text-sm font-medium text-green-700 min-w-[3rem] text-center';
          } else {
            display.className =
              'text-sm font-medium text-red-700 min-w-[3rem] text-center';
          }
        }
      }

      function nextQuestion() {
        // Stop current timer before moving to next question
        stopQuestionTimer();

        if (currentQuestionIndex < currentTest.questions.length - 1) {
          currentQuestionIndex++;
          displayQuestion();
        }
      }

      async function submitTest() {
        console.log('submitTest called');
        console.log('studentAnswers:', studentAnswers);
        console.log('currentTest:', currentTest);
        console.log('currentUser:', currentUser);
        console.log('testResults:', testResults);

        // Stop the timer when submitting
        stopQuestionTimer();

        if (!currentTest || !currentTest.questions) {
          console.error('Test validation failed - missing test or questions');
          alert('Test bilgileri bulunamadÄ±!');
          return;
        }

        if (!currentUser) {
          console.error('No current user found');
          alert('KullanÄ±cÄ± bilgisi bulunamadÄ±!');
          return;
        }

        if (Object.keys(studentAnswers).length < currentTest.questions.length) {
          console.log('Some questions unanswered, asking for confirmation');
          if (
            !confirm(
              'BazÄ± sorularÄ± boÅŸ bÄ±raktÄ±nÄ±z. Testi bitirmek istediÄŸinizden emin misiniz?'
            )
          ) {
            return;
          }
        }

        try {
          // Calculate test duration
          const testEndTime = new Date();
          const testDuration = testEndTime - testStartTime;

          // Calculate detailed score with new gamification system
          const detailedResult = calculateDetailedScore(
            studentAnswers,
            currentTest.questions
          );
          const passed = detailedResult.percentage >= 70;

          // Check if this is a retake
          const studentTestResults = testResults[currentUser] || [];
          const existingResult = studentTestResults.find(
            (r) => r.testId == currentTest.id
          );
          const isRetake = existingResult && existingResult.completed;

          // Update test results
          const testResultIndex = studentTestResults.findIndex(
            (r) => r.testId == currentTest.id
          );
          console.log('Test result index:', testResultIndex);
          console.log('Student test results:', studentTestResults);

          if (testResultIndex !== -1) {
            console.log('Updating existing test result');
            const updatedResult = {
              completed: true,
              score: detailedResult.percentage,
              points: detailedResult.totalPoints,
              stars: getStarsForScore(detailedResult.percentage),
              answers: { ...studentAnswers },
              details: detailedResult,
              duration: testDuration,
              isRetake: isRetake,
              completedAt: Date.now()
            };

            // Update local array
            Object.assign(studentTestResults[testResultIndex], updatedResult);

            // Update in Supabase if configured
            if (useSupabase && isSupabaseConfigured) {
              try {
                // Find student ID
                const student = students.find(s => s.name === currentUser);
                if (student && student.id) {
                  // Update test result in Supabase
                  await SupabaseHelper.testResults.update(
                    studentTestResults[testResultIndex].supabaseId, // We'll need to store this
                    {
                      completed: true,
                      score: detailedResult.percentage,
                      answers: studentAnswers,
                      stars: getStarsForScore(detailedResult.percentage),
                      points: detailedResult.totalPoints,
                      test_duration: testDuration
                    }
                  );

                  // Update student profile in Supabase
                  const newBadges = updateStudentProfile(
                    currentUser,
                    detailedResult,
                    testDuration,
                    isRetake
                  );

                  // Update profile in Supabase
                  const profile = studentProfiles[currentUser];
                  if (profile) {
                    await SupabaseHelper.studentProfiles.update(student.id, {
                      total_points: profile.totalPoints,
                      badges: profile.badges,
                      tests_completed: profile.testsCompleted,
                      tests_with_high_score: profile.testsWithHighScore,
                      fast_completions: profile.fastCompletions,
                      retake_successes: profile.retakeSuccesses,
                      average_stars: profile.averageStars,
                      total_stars: profile.totalStars
                    });
                  }
                }
              } catch (supabaseError) {
                console.error('Supabase gÃ¼ncelleme hatasÄ±:', supabaseError);
                // Continue with localStorage fallback
              }
            }

            console.log('Test result updated successfully');
          } else {
            console.error('Test result not found for update');
            alert(
              'Test sonucu kaydedilemedi! LÃ¼tfen Ã¶ÄŸretmeninizle iletiÅŸime geÃ§in.'
            );
            return;
          }

          // Update student profile and check for badges (for localStorage)
          if (!useSupabase || !isSupabaseConfigured) {
            const newBadges = updateStudentProfile(
              currentUser,
              detailedResult,
              testDuration,
              isRetake
            );
            
            // Auto-save data to localStorage
            saveDataToStorage();
          }

          // Show test results
          displayTestResults(detailedResult, passed, [], testDuration);
        } catch (error) {
          console.error('Error in submitTest:', error);
          alert(
            'Test sonuÃ§larÄ± hesaplanÄ±rken bir hata oluÅŸtu: ' + error.message
          );
        }
      }

      function calculateScore() {
        let correct = 0;
        const total = currentTest.questions.length;

        currentTest.questions.forEach((question, index) => {
          const userAnswer = studentAnswers[index];
          if (question.type === 'multiple' && userAnswer === question.correct) {
            correct++;
          } else if (
            question.type === 'fillblank' &&
            userAnswer === question.correct
          ) {
            correct++;
          } else if (
            question.type === 'truefalse' &&
            userAnswer === question.correct
          ) {
            correct++;
          }
        });

        return Math.round((correct / total) * 100);
      }

      function calculateDetailedResults() {
        const details = {
          multiple: { correct: 0, total: 0 },
          fillblank: { correct: 0, total: 0 },
          truefalse: { correct: 0, total: 0 },
        };

        currentTest.questions.forEach((question, index) => {
          const userAnswer = studentAnswers[index];
          details[question.type].total++;

          if (
            (question.type === 'multiple' && userAnswer === question.correct) ||
            (question.type === 'fillblank' &&
              userAnswer === question.correct) ||
            (question.type === 'truefalse' && userAnswer === question.correct)
          ) {
            details[question.type].correct++;
          }
        });

        return details;
      }

      function displayTestResults(
        detailedResult,
        passed,
        newBadges,
        testDuration
      ) {
        document.getElementById('testInterface').classList.add('hidden');
        document.getElementById('testResults').classList.remove('hidden');

        const icon = document.getElementById('resultIcon');
        const title = document.getElementById('resultTitle');
        const details = document.getElementById('resultDetails');

        const stars = getStarsForScore(detailedResult.percentage);
        const starsDisplay = getStarsDisplay(stars);

        if (passed) {
          icon.textContent = 'ğŸ‰';
          title.textContent = 'Tebrikler! BaÅŸarÄ±lÄ± oldunuz!';
          title.className = 'text-2xl font-bold mb-4 text-green-600';
        } else {
          icon.textContent = 'ğŸ˜”';
          title.textContent = 'BaÅŸarÄ±sÄ±z oldunuz. Tekrar deneyin!';
          title.className = 'text-2xl font-bold mb-4 text-red-600';
        }

        // Format test duration
        const minutes = Math.floor(testDuration / (1000 * 60));
        const seconds = Math.floor((testDuration % (1000 * 60)) / 1000);
        const durationText = `${minutes}:${seconds
          .toString()
          .padStart(2, '0')}`;

        let badgesHtml = '';
        if (newBadges.length > 0) {
          badgesHtml = `
                    <div class="bg-yellow-50 border-2 border-yellow-200 p-4 rounded-lg mb-4">
                        <h4 class="font-bold text-yellow-800 mb-2">ğŸŠ Yeni Rozet KazandÄ±nÄ±z!</h4>
                        <div class="space-y-2">
                            ${newBadges
                              .map(
                                (badge) => `
                                <div class="flex items-center gap-2 bg-white p-2 rounded">
                                    <span class="text-2xl">${badge.icon}</span>
                                    <div>
                                        <div class="font-bold text-sm">${badge.name}</div>
                                        <div class="text-xs text-gray-600">${badge.description}</div>
                                    </div>
                                </div>
                            `
                              )
                              .join('')}
                        </div>
                    </div>
                `;
        }

        details.innerHTML = `
                ${badgesHtml}
                <div class="bg-gray-50 p-4 rounded-lg mb-4">
                    <div class="text-center mb-3">
                        <div class="text-4xl font-bold ${
                          passed ? 'text-green-600' : 'text-red-600'
                        } mb-1">${detailedResult.totalPoints}/100</div>
                        <div class="text-lg text-gray-600">%${
                          detailedResult.percentage
                        }</div>
                        <div class="text-2xl mb-2">${
                          starsDisplay || 'â­ Yok'
                        }</div>
                        <div class="text-sm text-gray-500">SÃ¼re: ${durationText}</div>
                    </div>
                </div>
                
                <div class="grid grid-cols-3 gap-2 mb-4 text-sm">
                    <div class="bg-blue-50 p-3 rounded text-center">
                        <div class="font-bold text-blue-800">ğŸ“ Ã‡oktan SeÃ§meli</div>
                        <div class="text-blue-600">${
                          detailedResult.multiple.correct
                        }/${detailedResult.multiple.total}</div>
                        <div class="text-xs text-blue-500">${
                          detailedResult.multiple.correct *
                          POINTS.MULTIPLE_CHOICE
                        } puan</div>
                    </div>
                    <div class="bg-green-50 p-3 rounded text-center">
                        <div class="font-bold text-green-800">ğŸ“‹ BoÅŸluk Doldurma</div>
                        <div class="text-green-600">${
                          detailedResult.fillblank.correct
                        }/${detailedResult.fillblank.total}</div>
                        <div class="text-xs text-green-500">${
                          detailedResult.fillblank.correct * POINTS.FILL_BLANK
                        } puan</div>
                    </div>
                    <div class="bg-purple-50 p-3 rounded text-center">
                        <div class="font-bold text-purple-800">â“ DoÄŸru/YanlÄ±ÅŸ</div>
                        <div class="text-purple-600">${
                          detailedResult.truefalse.correct
                        }/${detailedResult.truefalse.total}</div>
                        <div class="text-xs text-purple-500">${
                          detailedResult.truefalse.correct * POINTS.TRUE_FALSE
                        } puan</div>
                    </div>
                </div>
                
                ${
                  !passed
                    ? '<div class="bg-orange-50 p-4 rounded-lg text-orange-800"><strong>ğŸ’¡ Tavsiye:</strong> Metni tekrar okuyun ve testi yeniden deneyin.</div>'
                    : ''
                }
            `;

        // Add success animation
        if (passed) {
          document
            .getElementById('testResults')
            .classList.add('success-animation');
        }
      }

      function backToStudentDashboard() {
        // Stop any running timer
        stopQuestionTimer();

        document.getElementById('testResults').classList.add('hidden');
        document.getElementById('testInterface').classList.add('hidden');
        document.getElementById('textFirstPage').classList.add('hidden');
        document.getElementById('studentDashboard').classList.remove('hidden');
        displayAssignedTests();
      }

      function goToMyPage() {
        if (!currentUser) {
          alert('Ã–nce giriÅŸ yapmalÄ±sÄ±nÄ±z!');
          return;
        }

        // Hide all test interfaces and show student dashboard
        document.getElementById('testResults').classList.add('hidden');
        document.getElementById('testInterface').classList.add('hidden');
        document.getElementById('textFirstPage').classList.add('hidden');
        document.getElementById('studentLogin').classList.add('hidden');
        document.getElementById('studentDashboard').classList.remove('hidden');

        // Refresh the dashboard
        displayStudentProfile();
        displayAssignedTests();

        alert(`${currentUser} sayfanÄ±za yÃ¶nlendirildiniz! ğŸ‘¤`);
      }

      function studentLogout() {
        if (confirm('Ã‡Ä±kÄ±ÅŸ yapmak istediÄŸinizden emin misiniz?')) {
          currentUser = null;
          document.getElementById('studentDashboard').classList.add('hidden');
          document.getElementById('studentLogin').classList.remove('hidden');
          document.getElementById('studentLoginSelect').value = '';
          alert('BaÅŸarÄ±yla Ã§Ä±kÄ±ÅŸ yaptÄ±nÄ±z! ğŸ‘‹');
        }
      }

      // Results display for teachers
      function displayResults() {
        const container = document.getElementById('resultsContent');
        const selectedStudent = document.getElementById('studentFilter').value;

        if (Object.keys(testResults).length === 0) {
          container.innerHTML =
            '<p class="text-gray-500 text-center py-8">HenÃ¼z test sonucu bulunmuyor.</p>';
          return;
        }

        let html = '<div class="space-y-6">';
        let studentsToShow = [];

        if (selectedStudent) {
          // Show only selected student's results
          if (testResults[selectedStudent]) {
            studentsToShow = [[selectedStudent, testResults[selectedStudent]]];
          }
        } else {
          // Show last 10 students with results
          const allStudents = Object.entries(testResults);
          // Sort by most recent activity (students with completed tests first, then by latest completion)
          allStudents.sort((a, b) => {
            const aLatest = Math.max(
              ...a[1].filter((r) => r.completed).map((r) => r.completedAt || 0),
              0
            );
            const bLatest = Math.max(
              ...b[1].filter((r) => r.completed).map((r) => r.completedAt || 0),
              0
            );
            return bLatest - aLatest;
          });
          studentsToShow = allStudents.slice(0, 10);
        }

        if (studentsToShow.length === 0) {
          container.innerHTML = selectedStudent
            ? `<p class="text-gray-500 text-center py-8">${selectedStudent} adlÄ± Ã¶ÄŸrencinin test sonucu bulunmuyor.</p>`
            : '<p class="text-gray-500 text-center py-8">HenÃ¼z test sonucu bulunmuyor.</p>';
          return;
        }

        studentsToShow.forEach(([studentName, results]) => {
          const profile = studentProfiles[studentName] || {};

          html += `<div class="border rounded-lg p-4">
                    <div class="flex justify-between items-center mb-3">
                        <div>
                            <h4 class="text-lg font-bold">ğŸ‘¨â€ğŸ“ğŸ‘©â€ğŸ“ ${studentName}</h4>
                            <div class="text-sm text-gray-600 flex gap-4 mt-1">
                                <span>ğŸ“Š ${profile.totalPoints || 0} puan</span>
                                <span>â­ ${(profile.averageStars || 0).toFixed(
                                  1
                                )} ortalama</span>
                                <span>ğŸ† ${
                                  (profile.badges || []).length
                                } rozet</span>
                                <span>ğŸ“ ${
                                  profile.testsCompleted || 0
                                } test</span>
                            </div>
                        </div>
                        ${
                          (profile.badges || []).length > 0
                            ? `
                            <div class="flex gap-1">
                                ${(profile.badges || [])
                                  .slice(0, 3)
                                  .map((badgeId) => {
                                    const badge = Object.values(BADGES).find(
                                      (b) => b.id === badgeId
                                    );
                                    return badge
                                      ? `<span class="text-lg" title="${badge.name}">${badge.icon}</span>`
                                      : '';
                                  })
                                  .join('')}
                                ${
                                  (profile.badges || []).length > 3
                                    ? `<span class="text-sm text-gray-500">+${
                                        (profile.badges || []).length - 3
                                      }</span>`
                                    : ''
                                }
                            </div>
                        `
                            : ''
                        }
                    </div>
                    <div class="space-y-2">`;

          // Sort results by completion date (most recent first)
          const sortedResults = [...results].sort((a, b) => {
            if (a.completed && b.completed) {
              return (b.completedAt || 0) - (a.completedAt || 0);
            }
            if (a.completed && !b.completed) return -1;
            if (!a.completed && b.completed) return 1;
            return 0;
          });

          sortedResults.forEach((result) => {
            const test = tests.find((t) => t.id == result.testId);
            if (!test) return;

            if (result.completed) {
              const passed = result.score >= 70;
              const details = result.details;
              const stars = result.stars || 0;
              const points = result.points || 0;
              const starsDisplay =
                stars > 0 ? getStarsDisplay(stars) : 'â­ Yok';

              // Format duration
              let durationText = '';
              if (result.duration) {
                const minutes = Math.floor(result.duration / (1000 * 60));
                const seconds = Math.floor(
                  (result.duration % (1000 * 60)) / 1000
                );
                durationText = `${minutes}:${seconds
                  .toString()
                  .padStart(2, '0')}`;
              }

              // Format completion date
              let completionDate = '';
              if (result.completedAt) {
                completionDate = new Date(result.completedAt).toLocaleString(
                  'tr-TR'
                );
              }

              html += `<div class="bg-gray-50 p-3 rounded">
                            <div class="flex justify-between items-center mb-2">
                                <div class="flex items-center gap-2">
                                    <strong>${test.title}</strong>
                                    ${
                                      result.isRetake
                                        ? '<span class="px-1 py-0.5 bg-blue-100 text-blue-800 text-xs rounded">Tekrar</span>'
                                        : ''
                                    }
                                    ${
                                      completionDate
                                        ? `<span class="text-xs text-gray-500">${completionDate}</span>`
                                        : ''
                                    }
                                </div>
                                <div class="flex items-center gap-2">
                                    <span class="text-sm text-gray-600">${starsDisplay}</span>
                                    <span class="px-2 py-1 rounded text-sm ${
                                      passed
                                        ? 'bg-green-100 text-green-800'
                                        : 'bg-red-100 text-red-800'
                                    }">
                                        ${points}/100 puan (%${result.score}) ${
                passed ? 'âœ…' : 'âŒ'
              }
                                    </span>
                                    <div class="flex gap-1">
                                        ${
                                          !passed
                                            ? `<button onclick="reassignTest('${studentName}', ${result.testId})" class="bg-orange-500 hover:bg-orange-600 text-white px-3 py-1 rounded text-sm font-medium transition-colors">
                                            ğŸ”„ Tekrar Ata
                                        </button>`
                                            : ''
                                        }
                                        <button onclick="deleteTestResult('${studentName}', ${
                result.testId
              })" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-sm font-medium transition-colors" title="Test sonucunu sil">
                                            ğŸ—‘ï¸ Sil
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="text-sm text-gray-600 grid grid-cols-4 gap-2">
                                <div>ğŸ“ Ã‡oktan SeÃ§meli: ${
                                  details.multiple.correct
                                }/${details.multiple.total} (${
                details.multiple.correct * POINTS.MULTIPLE_CHOICE
              }p)</div>
                                <div>ğŸ“‹ BoÅŸluk Doldurma: ${
                                  details.fillblank.correct
                                }/${details.fillblank.total} (${
                details.fillblank.correct * POINTS.FILL_BLANK
              }p)</div>
                                <div>â“ DoÄŸru/YanlÄ±ÅŸ: ${
                                  details.truefalse.correct
                                }/${details.truefalse.total} (${
                details.truefalse.correct * POINTS.TRUE_FALSE
              }p)</div>
                                ${
                                  durationText
                                    ? `<div>â±ï¸ SÃ¼re: ${durationText}</div>`
                                    : '<div></div>'
                                }
                            </div>
                        </div>`;
            } else {
              html += `<div class="bg-yellow-50 p-3 rounded">
                            <div class="flex justify-between items-center">
                                <strong>${test.title}</strong>
                                <div class="flex items-center gap-2">
                                    <span class="px-2 py-1 rounded text-sm bg-yellow-100 text-yellow-800">ğŸ“‹ Bekliyor</span>
                                    <button onclick="deleteTestResult('${studentName}', ${result.testId})" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-sm font-medium transition-colors" title="Test atamasÄ±nÄ± sil">
                                        ğŸ—‘ï¸ Sil
                                    </button>
                                </div>
                            </div>
                        </div>`;
            }
          });

          html += '</div></div>';
        });

        html += '</div>';
        container.innerHTML = html;
      }

      // Teacher login functions
      function showTeacherLogin() {
        document.getElementById('teacherLoginModal').classList.remove('hidden');
        document.getElementById('teacherUsername').focus();
        updateRemainingAttempts();
        hideLoginError();
      }

      function hideTeacherLogin() {
        document.getElementById('teacherLoginModal').classList.add('hidden');
        clearTeacherLoginForm();
        hideLoginError();
      }

      async function teacherLogin() {
        const username = document
          .getElementById('teacherUsername')
          .value.trim();
        const password = document.getElementById('teacherPassword').value;

        // Input validation
        if (!username || !password) {
          showLoginError('LÃ¼tfen kullanÄ±cÄ± adÄ± ve ÅŸifrenizi girin!');
          return;
        }

        // Check login attempts
        if (loginAttempts >= maxLoginAttempts) {
          showLoginError(
            'Maksimum giriÅŸ denemesi aÅŸÄ±ldÄ±! LÃ¼tfen daha sonra tekrar deneyin.'
          );
          return;
        }

        try {
          let loginSuccess = false;
          let sessionToken = null;

          if (useSupabase && isSupabaseConfigured) {
            // Try Supabase login first
            try {
              const loginResult = await SupabaseHelper.teachers.login(username, password);
              if (loginResult && loginResult.session) {
                sessionToken = loginResult.session.session_token;
                loginSuccess = true;
                console.log('âœ… Supabase Ã¶ÄŸretmen giriÅŸi baÅŸarÄ±lÄ±');
              }
            } catch (supabaseError) {
              console.log('âŒ Supabase giriÅŸ hatasÄ±, yerel kimlik doÄŸrulamaya geÃ§iliyor:', supabaseError.message);
              // Fall back to local authentication
            }
          }

          // Local authentication fallback
          if (!loginSuccess) {
            if (
              username === teacherCredentials.username &&
              password === teacherCredentials.password
            ) {
              loginSuccess = true;
              console.log('âœ… Yerel Ã¶ÄŸretmen giriÅŸi baÅŸarÄ±lÄ±');
            }
          }

          if (loginSuccess) {
            // Successful login
            loginAttempts = 0; // Reset attempts on successful login

            // Save session
            saveTeacherSession(username, sessionToken);

            hideTeacherLogin();
            showTeacherPanel();

            // Success message
            alert(
              `âœ… GiriÅŸ baÅŸarÄ±lÄ±!\n\nHoÅŸ geldiniz, ${username}!\n\nÃ–ÄŸretmen paneline yÃ¶nlendiriliyorsunuz...`
            );
          } else {
            // Failed login
            loginAttempts++;
            const remainingAttempts = maxLoginAttempts - loginAttempts;

            if (remainingAttempts > 0) {
              showLoginError(
                `âŒ HatalÄ± kullanÄ±cÄ± adÄ± veya ÅŸifre!\n\nKalan deneme hakkÄ±: ${remainingAttempts}`
              );
              updateRemainingAttempts();

              // Clear password field for security
              document.getElementById('teacherPassword').value = '';
              document.getElementById('teacherPassword').focus();
            } else {
              showLoginError(
                'âŒ Maksimum giriÅŸ denemesi aÅŸÄ±ldÄ±!\n\nGÃ¼venlik nedeniyle giriÅŸ engellenmiÅŸtir.'
              );

              // Disable login form
              document.getElementById('teacherUsername').disabled = true;
              document.getElementById('teacherPassword').disabled = true;

              // Auto close after 3 seconds
              setTimeout(() => {
                hideTeacherLogin();
                // Reset for next session
                document.getElementById('teacherUsername').disabled = false;
                document.getElementById('teacherPassword').disabled = false;
                loginAttempts = 0;
                updateRemainingAttempts();
              }, 3000);
            }
          }
        } catch (error) {
          console.error('GiriÅŸ hatasÄ±:', error);
          showLoginError('GiriÅŸ sÄ±rasÄ±nda bir hata oluÅŸtu: ' + error.message);
        }
      }

      async function teacherLogout() {
        if (confirm('Ã‡Ä±kÄ±ÅŸ yapmak istediÄŸinizden emin misiniz?')) {
          try {
            // Logout from Supabase if using it
            if (useSupabase && isSupabaseConfigured && teacherSessionToken) {
              try {
                await SupabaseHelper.teachers.logout(teacherSessionToken);
                console.log('âœ… Supabase oturumu sonlandÄ±rÄ±ldÄ±');
              } catch (supabaseError) {
                console.error('Supabase Ã§Ä±kÄ±ÅŸ hatasÄ±:', supabaseError);
                // Continue with local logout
              }
            }

            // Clear local session
            clearTeacherSession();
            loginAttempts = 0;

            // Clear any cached data
            clearTeacherLoginForm();

            // Hide teacher panel and show user selection
            hideAllSections();
            showUserSelection();

            alert(
              'âœ… BaÅŸarÄ±yla Ã§Ä±kÄ±ÅŸ yaptÄ±nÄ±z!\n\nAna sayfaya yÃ¶nlendiriliyorsunuz...'
            );
          } catch (error) {
            console.error('Ã‡Ä±kÄ±ÅŸ hatasÄ±:', error);
            alert('Ã‡Ä±kÄ±ÅŸ sÄ±rasÄ±nda bir hata oluÅŸtu: ' + error.message);
          }
        }
      }

      function showLoginError(message) {
        const errorDiv = document.getElementById('loginError');
        const errorMessage = document.getElementById('loginErrorMessage');

        errorMessage.textContent = message;
        errorDiv.classList.remove('hidden');

        // Add shake animation
        errorDiv.style.animation = 'shake 0.5s ease-in-out';
        setTimeout(() => {
          errorDiv.style.animation = '';
        }, 500);
      }

      function hideLoginError() {
        document.getElementById('loginError').classList.add('hidden');
      }

      function updateRemainingAttempts() {
        const remaining = maxLoginAttempts - loginAttempts;
        document.getElementById('remainingAttempts').textContent = remaining;

        // Change color based on remaining attempts
        const attemptsSpan = document.getElementById('remainingAttempts');
        if (remaining <= 1) {
          attemptsSpan.className = 'text-red-600 font-bold';
        } else if (remaining <= 2) {
          attemptsSpan.className = 'text-orange-600 font-bold';
        } else {
          attemptsSpan.className = 'text-blue-600';
        }
      }

      function clearTeacherLoginForm() {
        document.getElementById('teacherUsername').value = '';
        document.getElementById('teacherPassword').value = '';
      }

      // Add Enter key support for login
      document.addEventListener('DOMContentLoaded', function () {
        const teacherUsernameInput = document.getElementById('teacherUsername');
        const teacherPasswordInput = document.getElementById('teacherPassword');

        if (teacherUsernameInput) {
          teacherUsernameInput.addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
              teacherPasswordInput.focus();
            }
          });
        }

        if (teacherPasswordInput) {
          teacherPasswordInput.addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
              teacherLogin();
            }
          });
        }
      });

      // Utility functions
      function showLogin() {
        document.getElementById('loginModal').classList.remove('hidden');
      }

      function hideLogin() {
        document.getElementById('loginModal').classList.add('hidden');
      }

      function login() {
        // Simple demo login
        hideLogin();
        alert('GiriÅŸ baÅŸarÄ±lÄ±! (Demo)');
      }

      function showImportOptions() {
        const modal = document.createElement('div');
        modal.className =
          'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
        modal.innerHTML = `
                <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
                    <h3 class="text-xl font-bold mb-4">ğŸ“ Ä°Ã§e Aktarma SeÃ§enekleri</h3>
                    
                    <div class="space-y-4">
                        <button onclick="downloadWordTemplate()" class="w-full bg-blue-500 hover:bg-blue-600 text-white px-4 py-3 rounded-lg font-medium">
                            ğŸ“„ Word Åablonu Ä°ndir
                        </button>
                        
                        <div class="border-2 border-dashed border-gray-300 rounded-lg p-4 text-center">
                            <input type="file" id="wordFile" accept=".doc,.docx" class="hidden" onchange="importFromWord(event)">
                            <button onclick="document.getElementById('wordFile').click()" class="w-full bg-green-500 hover:bg-green-600 text-white px-4 py-3 rounded-lg font-medium">
                                ğŸ“¤ Word DosyasÄ± YÃ¼kle
                            </button>
                            <p class="text-sm text-gray-500 mt-2">Sadece .doc ve .docx dosyalarÄ± desteklenir</p>
                        </div>
                        
                        <div class="border-2 border-dashed border-gray-300 rounded-lg p-4 text-center">
                            <input type="file" id="jsonFile" accept=".json" class="hidden" onchange="importFromJSON(event)">
                            <button onclick="document.getElementById('jsonFile').click()" class="w-full bg-purple-500 hover:bg-purple-600 text-white px-4 py-3 rounded-lg font-medium">
                                ğŸ“„ JSON DosyasÄ± YÃ¼kle
                            </button>
                            <p class="text-sm text-gray-500 mt-2">Daha Ã¶nce dÄ±ÅŸa aktarÄ±lan test dosyalarÄ±</p>
                        </div>
                    </div>
                    
                    <div class="flex gap-3 mt-6">
                        <button onclick="closeImportModal()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg flex-1">
                            Ä°ptal
                        </button>
                    </div>
                </div>
            `;
        document.body.appendChild(modal);
        window.currentImportModal = modal;
      }

      function downloadWordTemplate() {
        // Create Word template content
        const templateContent = `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>Test Åablonu</title>
                    <style>
                        body { 
                            font-family: 'Times New Roman', serif; 
                            margin: 2cm; 
                            line-height: 1.6;
                            font-size: 12pt;
                        }
                        .header { 
                            text-align: center; 
                            margin-bottom: 30px; 
                            border-bottom: 2px solid #333;
                            padding-bottom: 15px;
                        }
                        .title { 
                            font-size: 18pt; 
                            font-weight: bold; 
                            margin-bottom: 10px;
                        }
                        .section { 
                            margin: 25px 0; 
                            padding: 15px; 
                            border: 1px solid #ddd; 
                            border-radius: 8px;
                        }
                        .section-title {
                            font-weight: bold;
                            font-size: 14pt;
                            margin-bottom: 10px;
                            color: #333;
                            border-bottom: 1px solid #eee;
                            padding-bottom: 5px;
                        }
                        .example {
                            background-color: #f9f9f9;
                            padding: 10px;
                            margin: 10px 0;
                            border-left: 4px solid #007bff;
                        }
                        .instruction {
                            background-color: #fff3cd;
                            padding: 10px;
                            margin: 10px 0;
                            border-left: 4px solid #ffc107;
                            font-style: italic;
                        }
                        .template-field {
                            background-color: #e9ecef;
                            padding: 8px;
                            margin: 5px 0;
                            border-radius: 4px;
                            min-height: 20px;
                        }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <div class="title">ğŸ“„ TEST ÅABLONU</div>
                        <div>Dijital Okuma Anlama ve Hikaye Takip Platformu</div>
                    </div>
                    
                    <div class="section">
                        <div class="section-title">ğŸ“ Test Bilgileri</div>
                        <p><strong>Test BaÅŸlÄ±ÄŸÄ±:</strong></p>
                        <div class="template-field">[Buraya test baÅŸlÄ±ÄŸÄ±nÄ± yazÄ±n]</div>
                        
                        <p><strong>Metin Ä°Ã§eriÄŸi:</strong></p>
                        <div class="template-field" style="min-height: 100px;">[Buraya okuma metnini yazÄ±n. Bu metin Ã¶ÄŸrencilere gÃ¶sterilecek ve sorular bu metne dayalÄ± olacaktÄ±r.]</div>
                    </div>
                    
                    <div class="section">
                        <div class="section-title">â“ Sorular</div>
                        <div class="instruction">
                            <strong>KullanÄ±m TalimatlarÄ±:</strong><br>
                            â€¢ Her soru iÃ§in aÅŸaÄŸÄ±daki formatÄ± kullanÄ±n<br>
                            â€¢ Soru tiplerini deÄŸiÅŸtirmeyin: Ã‡OKTAN_SEÃ‡MELÄ°, BOÅLUK_DOLDURMA, DOÄRU_YANLIÅ<br>
                            â€¢ DoÄŸru cevaplarÄ± aÃ§Ä±kÃ§a belirtin
                        </div>
                        
                        <div class="example">
                            <strong>SORU_1</strong><br>
                            <strong>Tip:</strong> Ã‡OKTAN_SEÃ‡MELÄ°<br>
                            <strong>Soru:</strong> Ã‡iftÃ§i nerede yaÅŸÄ±yordu?<br>
                            <strong>A)</strong> BÃ¼yÃ¼k bir ÅŸehirde<br>
                            <strong>B)</strong> KÃ¼Ã§Ã¼k bir kÃ¶yde<br>
                            <strong>C)</strong> DaÄŸlÄ±k bir bÃ¶lgede<br>
                            <strong>DoÄŸru Cevap:</strong> B<br>
                        </div>
                        
                        <div class="example">
                            <strong>SORU_2</strong><br>
                            <strong>Tip:</strong> BOÅLUK_DOLDURMA<br>
                            <strong>Soru:</strong> Ã‡iftÃ§i her gÃ¼n _____ Ã§alÄ±ÅŸÄ±rdÄ±.<br>
                            <strong>Kelime BankasÄ±:</strong> tarlasÄ±nda, evinde, pazarda<br>
                            <strong>DoÄŸru Cevap:</strong> tarlasÄ±nda<br>
                        </div>
                        
                        <div class="example">
                            <strong>SORU_3</strong><br>
                            <strong>Tip:</strong> DOÄRU_YANLIÅ<br>
                            <strong>Soru:</strong> Ã‡iftÃ§i tÃ¼m parasÄ±nÄ± harcardÄ±.<br>
                            <strong>DoÄŸru Cevap:</strong> YANLIÅ<br>
                        </div>
                        
                        <!-- Template fields for user to fill -->
                        <div style="margin-top: 30px;">
                            <strong>SORU_1</strong><br>
                            <strong>Tip:</strong> <div class="template-field">[Ã‡OKTAN_SEÃ‡MELÄ° / BOÅLUK_DOLDURMA / DOÄRU_YANLIÅ]</div>
                            <strong>Soru:</strong> <div class="template-field">[Soru metnini yazÄ±n]</div>
                            <strong>SeÃ§enekler/Kelime BankasÄ±:</strong><br>
                            <div class="template-field">[A) SeÃ§enek 1 veya Kelime BankasÄ±]</div>
                            <div class="template-field">[B) SeÃ§enek 2]</div>
                            <div class="template-field">[C) SeÃ§enek 3]</div>
                            <strong>DoÄŸru Cevap:</strong> <div class="template-field">[A/B/C veya kelime veya DOÄRU/YANLIÅ]</div>
                            <br>
                            
                            <strong>SORU_2</strong><br>
                            <strong>Tip:</strong> <div class="template-field">[Ã‡OKTAN_SEÃ‡MELÄ° / BOÅLUK_DOLDURMA / DOÄRU_YANLIÅ]</div>
                            <strong>Soru:</strong> <div class="template-field">[Soru metnini yazÄ±n]</div>
                            <strong>SeÃ§enekler/Kelime BankasÄ±:</strong><br>
                            <div class="template-field">[A) SeÃ§enek 1 veya Kelime BankasÄ±]</div>
                            <div class="template-field">[B) SeÃ§enek 2]</div>
                            <div class="template-field">[C) SeÃ§enek 3]</div>
                            <strong>DoÄŸru Cevap:</strong> <div class="template-field">[A/B/C veya kelime veya DOÄRU/YANLIÅ]</div>
                            <br>
                            
                            <strong>SORU_3</strong><br>
                            <strong>Tip:</strong> <div class="template-field">[Ã‡OKTAN_SEÃ‡MELÄ° / BOÅLUK_DOLDURMA / DOÄRU_YANLIÅ]</div>
                            <strong>Soru:</strong> <div class="template-field">[Soru metnini yazÄ±n]</div>
                            <strong>SeÃ§enekler/Kelime BankasÄ±:</strong><br>
                            <div class="template-field">[A) SeÃ§enek 1 veya Kelime BankasÄ±]</div>
                            <div class="template-field">[B) SeÃ§enek 2]</div>
                            <div class="template-field">[C) SeÃ§enek 3]</div>
                            <strong>DoÄŸru Cevap:</strong> <div class="template-field">[A/B/C veya kelime veya DOÄRU/YANLIÅ]</div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 40px; text-align: center; border-top: 2px solid #333; padding-top: 20px;">
                        <p><strong>ğŸ“‹ Åablon KullanÄ±m KÄ±lavuzu</strong></p>
                        <div style="text-align: left; font-size: 10pt; color: #666;">
                            <p><strong>1.</strong> Test baÅŸlÄ±ÄŸÄ± ve metin iÃ§eriÄŸini doldurun</p>
                            <p><strong>2.</strong> Her soru iÃ§in tip, soru metni ve seÃ§enekleri yazÄ±n</p>
                            <p><strong>3.</strong> DoÄŸru cevaplarÄ± net bir ÅŸekilde belirtin</p>
                            <p><strong>4.</strong> DosyayÄ± kaydedin ve sisteme yÃ¼kleyin</p>
                        </div>
                    </div>
                </body>
                </html>
            `;

        // Create blob and download
        const blob = new Blob([templateContent], {
          type: 'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
        });

        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = 'test_sablonu.doc';
        link.click();

        alert(
          'Word ÅŸablonu indirildi! ğŸ“„\n\nÅablonu doldurup tekrar yÃ¼kleyebilirsiniz.'
        );
      }

      function importFromWord(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function (e) {
          try {
            const text = e.target.result;

            let testTitle = '';
            let testText = '';
            const questions = [];

            // Extract test title
            const titleMatch =
              text.match(
                /Test BaÅŸlÄ±ÄŸÄ±:\s*<\/strong><\/p>\s*<div[^>]*>\[([^\]]+)\]/i
              ) || text.match(/Test BaÅŸlÄ±ÄŸÄ±:\s*([^\n\r<]+)/i);
            if (titleMatch) {
              testTitle = titleMatch[1].trim().replace(/[\[\]]/g, '');
            }

            // Extract test text
            const textMatch =
              text.match(
                /Metin Ä°Ã§eriÄŸi:\s*<\/strong><\/p>\s*<div[^>]*>\[([^\]]+)\]/i
              ) || text.match(/Metin Ä°Ã§eriÄŸi:\s*([^\n\r<]+)/i);
            if (textMatch) {
              testText = textMatch[1].trim().replace(/[\[\]]/g, '');
            }

            // Extract questions using regex patterns
            const questionPattern = /SORU_\d+[\s\S]*?(?=SORU_\d+|$)/gi;
            const questionMatches = text.match(questionPattern);

            if (questionMatches) {
              questionMatches.forEach((questionBlock, index) => {
                try {
                  // Extract question type
                  const typeMatch =
                    questionBlock.match(
                      /Tip:\s*<\/strong>\s*<div[^>]*>\[([^\]]+)\]/i
                    ) || questionBlock.match(/Tip:\s*([^\n\r<]+)/i);
                  if (!typeMatch) return;

                  let questionType = typeMatch[1]
                    .trim()
                    .replace(/[\[\]]/g, '')
                    .toLowerCase();

                  // Map Turkish types to English
                  if (
                    questionType.includes('Ã§oktan') ||
                    questionType.includes('seÃ§meli')
                  ) {
                    questionType = 'multiple';
                  } else if (
                    questionType.includes('boÅŸluk') ||
                    questionType.includes('doldurma')
                  ) {
                    questionType = 'fillblank';
                  } else if (
                    questionType.includes('doÄŸru') ||
                    questionType.includes('yanlÄ±ÅŸ')
                  ) {
                    questionType = 'truefalse';
                  } else {
                    return; // Skip unknown types
                  }

                  // Extract question text
                  const questionMatch =
                    questionBlock.match(
                      /Soru:\s*<\/strong>\s*<div[^>]*>\[([^\]]+)\]/i
                    ) || questionBlock.match(/Soru:\s*([^\n\r<]+)/i);
                  if (!questionMatch) return;

                  const questionText = questionMatch[1]
                    .trim()
                    .replace(/[\[\]]/g, '');

                  // Extract correct answer
                  const correctMatch =
                    questionBlock.match(
                      /DoÄŸru Cevap:\s*<\/strong>\s*<div[^>]*>\[([^\]]+)\]/i
                    ) || questionBlock.match(/DoÄŸru Cevap:\s*([^\n\r<]+)/i);
                  if (!correctMatch) return;

                  const correctAnswer = correctMatch[1]
                    .trim()
                    .replace(/[\[\]]/g, '');

                  let question = {
                    type: questionType,
                    question: questionText,
                  };

                  if (questionType === 'multiple') {
                    // Extract options A, B, C
                    const optionMatches = questionBlock.match(
                      /<div[^>]*>\[([^\]]*)\]/gi
                    );
                    const options = [];

                    if (optionMatches && optionMatches.length >= 3) {
                      // Skip first two matches (type and question), get next 3 for options
                      for (
                        let i = 2;
                        i < Math.min(5, optionMatches.length - 1);
                        i++
                      ) {
                        const optionText = optionMatches[i]
                          .replace(/<[^>]*>/g, '')
                          .replace(/[\[\]]/g, '')
                          .trim();
                        if (
                          optionText &&
                          !optionText.toLowerCase().includes('doÄŸru cevap')
                        ) {
                          options.push(optionText);
                        }
                      }
                    }

                    if (options.length < 2) return;

                    question.options = options;

                    // Find correct answer index
                    let correctIndex = -1;
                    if (correctAnswer.match(/^[ABC]$/i)) {
                      correctIndex =
                        correctAnswer.toUpperCase().charCodeAt(0) - 65;
                    } else {
                      correctIndex = options.findIndex(
                        (opt) =>
                          opt
                            .toLowerCase()
                            .includes(correctAnswer.toLowerCase()) ||
                          correctAnswer
                            .toLowerCase()
                            .includes(opt.toLowerCase())
                      );
                    }

                    if (correctIndex === -1 || correctIndex >= options.length)
                      return;
                    question.correct = correctIndex;
                  } else if (questionType === 'fillblank') {
                    // Extract word bank
                    const wordBankMatch =
                      questionBlock.match(/Kelime BankasÄ±:\s*([^\n\r<]+)/i) ||
                      questionBlock.match(
                        /SeÃ§enekler\/Kelime BankasÄ±:[\s\S]*?<div[^>]*>\[([^\]]+)\]/i
                      );

                    let wordBank = [];
                    if (wordBankMatch) {
                      wordBank = wordBankMatch[1]
                        .split(',')
                        .map((word) => word.trim().replace(/[\[\]]/g, ''));
                    }

                    if (wordBank.length === 0) {
                      // Try to extract from option divs
                      const optionMatches = questionBlock.match(
                        /<div[^>]*>\[([^\]]*)\]/gi
                      );
                      if (optionMatches && optionMatches.length >= 3) {
                        for (
                          let i = 2;
                          i < Math.min(5, optionMatches.length - 1);
                          i++
                        ) {
                          const word = optionMatches[i]
                            .replace(/<[^>]*>/g, '')
                            .replace(/[\[\]]/g, '')
                            .trim();
                          if (
                            word &&
                            !word.toLowerCase().includes('doÄŸru cevap')
                          ) {
                            wordBank.push(word);
                          }
                        }
                      }
                    }

                    if (wordBank.length === 0) return;

                    question.wordBank = wordBank;
                    question.correct = correctAnswer;
                  } else if (questionType === 'truefalse') {
                    const isTrue =
                      correctAnswer.toLowerCase().includes('doÄŸru') ||
                      correctAnswer.toLowerCase().includes('true');
                    question.correct = isTrue;
                  }

                  questions.push(question);
                } catch (questionError) {
                  console.warn(
                    `Soru ${index + 1} iÅŸlenirken hata:`,
                    questionError
                  );
                }
              });
            }

            if (!testTitle || !testText || questions.length === 0) {
              throw new Error(
                'Word dosyasÄ±ndan test bilgileri Ã§Ä±karÄ±lamadÄ±!\n\nLÃ¼tfen ÅŸablon formatÄ±nÄ± kontrol edin.'
              );
            }

            // Create test object
            const importedTest = {
              id: Date.now(),
              title: testTitle,
              text: testText,
              questions: questions,
            };

            // Update form fields
            document.getElementById('textTitle').value = testTitle;
            document.getElementById('textContent').value = testText;

            // Display preview
            displayTestPreview(importedTest);
            closeImportModal();

            alert(
              `Test baÅŸarÄ±yla Word dosyasÄ±ndan iÃ§e aktarÄ±ldÄ±! âœ…\n\nğŸ“‹ ${testTitle}\nğŸ“ ${questions.length} soru yÃ¼klendi`
            );
          } catch (error) {
            alert(
              'Word dosyasÄ± okuma hatasÄ±: ' +
                error.message +
                '\n\nLÃ¼tfen ÅŸablon formatÄ±nÄ± kontrol edin ve dosyayÄ± HTML formatÄ±nda kaydetmeyi deneyin.'
            );
          }
        };

        reader.readAsText(file, 'UTF-8');
      }

      function importFromJSON(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function (e) {
          try {
            const testData = JSON.parse(e.target.result);

            // Validate JSON structure
            if (
              !testData.title ||
              !testData.text ||
              !testData.questions ||
              !Array.isArray(testData.questions)
            ) {
              throw new Error('GeÃ§ersiz test dosyasÄ± formatÄ±!');
            }

            // Create test object
            const importedTest = {
              id: Date.now(),
              title: testData.title,
              text: testData.text,
              questions: testData.questions,
            };

            // Update form fields
            document.getElementById('textTitle').value = testData.title;
            document.getElementById('textContent').value = testData.text;

            // Display preview
            displayTestPreview(importedTest);
            closeImportModal();

            alert(
              `Test baÅŸarÄ±yla iÃ§e aktarÄ±ldÄ±! âœ…\n\nğŸ“‹ ${testData.title}\nğŸ“ ${testData.questions.length} soru yÃ¼klendi`
            );
          } catch (error) {
            alert('JSON dosya okuma hatasÄ±: ' + error.message);
          }
        };

        reader.readAsText(file);
      }

      function closeImportModal() {
        if (window.currentImportModal) {
          document.body.removeChild(window.currentImportModal);
          window.currentImportModal = null;
        }
      }

      function exportTest() {
        if (!currentTest) {
          alert('Ã–nce bir test oluÅŸturun!');
          return;
        }

        const modal = document.createElement('div');
        modal.className =
          'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
        modal.innerHTML = `
                <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
                    <h3 class="text-xl font-bold mb-4">ğŸ’¾ DÄ±ÅŸa Aktarma SeÃ§enekleri</h3>
                    
                    <div class="space-y-4">
                        <button onclick="exportAsJSON()" class="w-full bg-blue-500 hover:bg-blue-600 text-white px-4 py-3 rounded-lg font-medium">
                            ğŸ“„ JSON FormatÄ±nda Ä°ndir
                        </button>
                        
                        <button onclick="exportAsWord()" class="w-full bg-green-500 hover:bg-green-600 text-white px-4 py-3 rounded-lg font-medium">
                            ğŸ“„ Word FormatÄ±nda Ä°ndir
                        </button>
                        
                        <button onclick="exportAsPDF()" class="w-full bg-red-500 hover:bg-red-600 text-white px-4 py-3 rounded-lg font-medium">
                            ğŸ“‘ PDF FormatÄ±nda Ä°ndir
                        </button>
                    </div>
                    
                    <div class="flex gap-3 mt-6">
                        <button onclick="closeExportModal()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg flex-1">
                            Ä°ptal
                        </button>
                    </div>
                </div>
            `;
        document.body.appendChild(modal);
        window.currentExportModal = modal;
      }

      function exportAsJSON() {
        const dataStr = JSON.stringify(currentTest, null, 2);
        const dataBlob = new Blob([dataStr], { type: 'application/json' });

        const link = document.createElement('a');
        link.href = URL.createObjectURL(dataBlob);
        link.download = `${currentTest.title.replace(/[^a-z0-9]/gi, '_')}.json`;
        link.click();

        closeExportModal();
        alert('Test JSON formatÄ±nda dÄ±ÅŸa aktarÄ±ldÄ±! ğŸ“„');
      }

      function exportAsWord() {
        // Create Word document content in HTML format
        const wordContent = `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>${currentTest.title}</title>
                    <style>
                        body { 
                            font-family: 'Times New Roman', serif; 
                            margin: 2cm; 
                            line-height: 1.6;
                            font-size: 12pt;
                        }
                        .header { 
                            text-align: center; 
                            margin-bottom: 30px; 
                            border-bottom: 2px solid #333;
                            padding-bottom: 15px;
                        }
                        .title { 
                            font-size: 18pt; 
                            font-weight: bold; 
                            margin-bottom: 10px;
                        }
                        .text-content { 
                            background: #f9f9f9; 
                            padding: 20px; 
                            margin: 25px 0; 
                            border-left: 4px solid #007bff;
                            border-radius: 5px;
                        }
                        .text-title {
                            font-weight: bold;
                            font-size: 14pt;
                            margin-bottom: 10px;
                            color: #333;
                        }
                        .question { 
                            margin: 25px 0; 
                            padding: 15px; 
                            border: 1px solid #ddd; 
                            border-radius: 8px;
                            page-break-inside: avoid;
                        }
                        .question-header { 
                            font-weight: bold; 
                            color: #333; 
                            font-size: 13pt;
                            margin-bottom: 10px;
                            border-bottom: 1px solid #eee;
                            padding-bottom: 5px;
                        }
                        .question-text {
                            margin: 10px 0;
                            font-size: 12pt;
                        }
                        .options { 
                            margin: 15px 0; 
                            padding-left: 20px;
                        }
                        .option { 
                            margin: 8px 0; 
                            padding: 5px 0;
                        }
                        .correct-answer {
                            background-color: #d4edda;
                            padding: 8px;
                            border-radius: 4px;
                            margin-top: 10px;
                            border-left: 4px solid #28a745;
                        }
                        .word-bank {
                            background-color: #fff3cd;
                            padding: 10px;
                            border-radius: 4px;
                            margin: 10px 0;
                            border-left: 4px solid #ffc107;
                        }
                        .page-break { page-break-before: always; }
                        @media print {
                            body { margin: 1cm; }
                            .question { page-break-inside: avoid; }
                        }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <div class="title">${currentTest.title}</div>
                        <div>Toplam Soru SayÄ±sÄ±: ${
                          currentTest.questions.length
                        }</div>
                        <div>Tarih: ${new Date().toLocaleDateString(
                          'tr-TR'
                        )}</div>
                    </div>
                    
                    <div class="text-content">
                        <div class="text-title">ğŸ“– Okuma Metni:</div>
                        <div>${currentTest.text}</div>
                    </div>
                    
                    <div class="page-break"></div>
                    
                    <h2 style="color: #333; border-bottom: 2px solid #333; padding-bottom: 10px;">ğŸ“ Test SorularÄ±</h2>
                    
                    ${currentTest.questions
                      .map((question, index) => {
                        let questionHtml = `
                            <div class="question">
                                <div class="question-header">
                                    Soru ${index + 1} - ${getQuestionTypeLabel(
                          question.type
                        )}
                                </div>
                                <div class="question-text">${
                                  question.question
                                }</div>
                        `;

                        if (question.type === 'multiple') {
                          questionHtml += '<div class="options">';
                          question.options.forEach((option, optIndex) => {
                            const isCorrect = optIndex === question.correct;
                            const marker = String.fromCharCode(65 + optIndex); // A, B, C
                            questionHtml += `
                                    <div class="option">
                                        <strong>${marker})</strong> ${option}
                                        ${
                                          isCorrect
                                            ? ' <strong style="color: #28a745;">âœ“</strong>'
                                            : ''
                                        }
                                    </div>
                                `;
                          });
                          questionHtml += '</div>';
                          questionHtml += `<div class="correct-answer"><strong>DoÄŸru Cevap:</strong> ${String.fromCharCode(
                            65 + question.correct
                          )}) ${question.options[question.correct]}</div>`;
                        } else if (question.type === 'fillblank') {
                          questionHtml += `<div class="word-bank"><strong>Kelime BankasÄ±:</strong> ${question.wordBank.join(
                            ', '
                          )}</div>`;
                          questionHtml += `<div class="correct-answer"><strong>DoÄŸru Cevap:</strong> ${question.correct}</div>`;
                        } else if (question.type === 'truefalse') {
                          questionHtml += `
                                <div class="options">
                                    <div class="option">
                                        <strong>A)</strong> DoÄŸru ${
                                          question.correct === true
                                            ? ' <strong style="color: #28a745;">âœ“</strong>'
                                            : ''
                                        }
                                    </div>
                                    <div class="option">
                                        <strong>B)</strong> YanlÄ±ÅŸ ${
                                          question.correct === false
                                            ? ' <strong style="color: #28a745;">âœ“</strong>'
                                            : ''
                                        }
                                    </div>
                                </div>
                            `;
                          questionHtml += `<div class="correct-answer"><strong>DoÄŸru Cevap:</strong> ${
                            question.correct ? 'DoÄŸru' : 'YanlÄ±ÅŸ'
                          }</div>`;
                        }

                        questionHtml += '</div>';
                        return questionHtml;
                      })
                      .join('')}
                    
                    <div style="margin-top: 40px; text-align: center; border-top: 2px solid #333; padding-top: 20px;">
                        <p><strong>Test TamamlandÄ±</strong></p>
                        <p style="font-size: 10pt; color: #666;">Bu test Okuma Anlama Test Sistemi ile oluÅŸturulmuÅŸtur.</p>
                    </div>
                </body>
                </html>
            `;

        // Create blob and download
        const blob = new Blob([wordContent], {
          type: 'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
        });

        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `${currentTest.title.replace(/[^a-z0-9]/gi, '_')}.doc`;
        link.click();

        closeExportModal();
        alert(
          'Test Word formatÄ±nda dÄ±ÅŸa aktarÄ±ldÄ±! ğŸ“„\n\nDosyayÄ± Microsoft Word ile aÃ§abilirsiniz.'
        );
      }

      function exportAsPDF() {
        // Create a printable version
        const printWindow = window.open('', '_blank');
        const printContent = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>${currentTest.title}</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        .header { text-align: center; margin-bottom: 30px; }
                        .text-content { background: #f5f5f5; padding: 15px; margin: 20px 0; border-radius: 5px; }
                        .question { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
                        .question-number { font-weight: bold; color: #333; }
                        .options { margin: 10px 0; }
                        .option { margin: 5px 0; }
                        @media print { .no-print { display: none; } }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>${currentTest.title}</h1>
                        <p>Toplam Soru: ${currentTest.questions.length}</p>
                    </div>
                    
                    <div class="text-content">
                        <h3>ğŸ“– Metin:</h3>
                        <p>${currentTest.text}</p>
                    </div>
                    
                    <h3>ğŸ“ Sorular:</h3>
                    ${currentTest.questions
                      .map((question, index) => {
                        let questionHtml = `
                            <div class="question">
                                <div class="question-number">Soru ${
                                  index + 1
                                }: ${question.question}</div>
                        `;

                        if (question.type === 'multiple') {
                          questionHtml += '<div class="options">';
                          question.options.forEach((option, optIndex) => {
                            const isCorrect =
                              optIndex === question.correct ? ' âœ“' : '';
                            questionHtml += `<div class="option">${String.fromCharCode(
                              65 + optIndex
                            )}) ${option}${isCorrect}</div>`;
                          });
                          questionHtml += '</div>';
                        } else if (question.type === 'fillblank') {
                          questionHtml += `<div class="options">Kelime BankasÄ±: ${question.wordBank.join(
                            ', '
                          )}</div>`;
                          questionHtml += `<div><strong>DoÄŸru Cevap:</strong> ${question.correct}</div>`;
                        } else if (question.type === 'truefalse') {
                          questionHtml += `<div><strong>DoÄŸru Cevap:</strong> ${
                            question.correct ? 'DoÄŸru' : 'YanlÄ±ÅŸ'
                          }</div>`;
                        }

                        questionHtml += '</div>';
                        return questionHtml;
                      })
                      .join('')}
                    
                    <div class="no-print" style="margin-top: 30px; text-align: center;">
                        <button onclick="window.print()" style="background: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer;">
                            ğŸ–¨ï¸ YazdÄ±r / PDF Kaydet
                        </button>
                        <button onclick="window.close()" style="background: #6c757d; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; margin-left: 10px;">
                            Kapat
                        </button>
                    </div>
                </body>
                </html>
            `;

        printWindow.document.write(printContent);
        printWindow.document.close();

        closeExportModal();
        alert(
          'Test PDF Ã¶nizlemesi aÃ§Ä±ldÄ±! YazdÄ±r butonuna tÄ±klayarak PDF olarak kaydedebilirsiniz. ğŸ“‘'
        );
      }

      function closeExportModal() {
        if (window.currentExportModal) {
          document.body.removeChild(window.currentExportModal);
          window.currentExportModal = null;
        }
      }

      function editTest() {
        if (!currentTest) {
          alert('DÃ¼zenlenecek test bulunamadÄ±!');
          return;
        }

        // Show edit interface with individual question editing
        const editModal = document.createElement('div');
        editModal.className =
          'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';

        let questionsHtml = '';
        currentTest.questions.forEach((question, index) => {
          questionsHtml += `
                    <div class="border rounded-lg p-4 mb-4 bg-gray-50">
                        <div class="flex justify-between items-center mb-3">
                            <h5 class="font-bold">Soru ${
                              index + 1
                            } - ${getQuestionTypeLabel(question.type)}</h5>
                            <button onclick="deleteQuestion(${index})" class="text-red-500 hover:text-red-700 text-sm">ğŸ—‘ï¸ Sil</button>
                        </div>
                        
                        <div class="mb-3">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Soru Metni</label>
                            <textarea id="question_${index}" class="w-full p-2 border rounded-lg" rows="2">${
            question.question
          }</textarea>
                        </div>
                        
                        ${generateQuestionEditFields(question, index)}
                    </div>
                `;
        });

        editModal.innerHTML = `
                <div class="bg-white rounded-lg p-6 max-w-6xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                    <h3 class="text-xl font-bold mb-4">Test DÃ¼zenle: ${currentTest.title}</h3>
                    
                    <div class="space-y-4">
                        ${questionsHtml}
                    </div>
                    
                    <div class="flex gap-3 mt-6 pt-4 border-t bg-white sticky bottom-0">
                        <button onclick="saveAllQuestionEdits()" class="bg-green-500 hover:bg-green-600 text-white px-6 py-2 rounded-lg font-medium">
                            âœ… TÃ¼m DeÄŸiÅŸiklikleri Kaydet
                        </button>
                        <button onclick="closeEditModal()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg font-medium">
                            âŒ Ä°ptal
                        </button>
                    </div>
                </div>
            `;

        document.body.appendChild(editModal);
        window.currentEditModal = editModal;
      }

      function getQuestionTypeLabel(type) {
        switch (type) {
          case 'multiple':
            return 'ğŸ“ Ã‡oktan SeÃ§meli';
          case 'fillblank':
            return 'ğŸ“‹ BoÅŸluk Doldurma';
          case 'truefalse':
            return 'â“ DoÄŸru/YanlÄ±ÅŸ';
          default:
            return 'Bilinmeyen';
        }
      }

      function generateQuestionEditFields(question, index) {
        if (question.type === 'multiple') {
          let optionsHtml = '';
          question.options.forEach((option, optIndex) => {
            const checked = question.correct === optIndex ? 'checked' : '';
            optionsHtml += `
                        <div class="flex items-center gap-2 mb-2">
                            <input type="radio" name="correct_${index}" value="${optIndex}" ${checked} class="mr-2">
                            <input type="text" id="option_${index}_${optIndex}" value="${option}" class="flex-1 p-2 border rounded-lg" placeholder="SeÃ§enek ${
              optIndex + 1
            }">
                        </div>
                    `;
          });

          return `
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">SeÃ§enekler (DoÄŸru cevabÄ± iÅŸaretleyin)</label>
                        ${optionsHtml}
                    </div>
                `;
        } else if (question.type === 'fillblank') {
          let wordBankHtml = '';
          question.wordBank.forEach((word, wordIndex) => {
            const selected = question.correct === word ? 'selected' : '';
            wordBankHtml += `
                        <div class="flex items-center gap-2 mb-2">
                            <input type="radio" name="correct_${index}" value="${word}" ${
              selected ? 'checked' : ''
            } class="mr-2">
                            <input type="text" id="word_${index}_${wordIndex}" value="${word}" class="flex-1 p-2 border rounded-lg" placeholder="Kelime ${
              wordIndex + 1
            }">
                        </div>
                    `;
          });

          return `
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Kelime BankasÄ± (DoÄŸru cevabÄ± iÅŸaretleyin)</label>
                        ${wordBankHtml}
                    </div>
                `;
        } else if (question.type === 'truefalse') {
          const trueChecked = question.correct === true ? 'checked' : '';
          const falseChecked = question.correct === false ? 'checked' : '';

          return `
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">DoÄŸru Cevap</label>
                        <div class="flex gap-4">
                            <label class="flex items-center">
                                <input type="radio" name="correct_${index}" value="true" ${trueChecked} class="mr-2">
                                DoÄŸru
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="correct_${index}" value="false" ${falseChecked} class="mr-2">
                                YanlÄ±ÅŸ
                            </label>
                        </div>
                    </div>
                `;
        }
      }

      function saveAllQuestionEdits() {
        try {
          currentTest.questions.forEach((question, index) => {
            // Update question text
            const questionText = document.getElementById(
              `question_${index}`
            ).value;
            if (!questionText.trim()) {
              throw new Error(`Soru ${index + 1} metni boÅŸ olamaz!`);
            }
            question.question = questionText;

            // Update based on question type
            if (question.type === 'multiple') {
              // Update options
              question.options = [];
              for (let i = 0; i < 3; i++) {
                const optionElement = document.getElementById(
                  `option_${index}_${i}`
                );
                if (optionElement) {
                  const optionText = optionElement.value.trim();
                  if (!optionText) {
                    throw new Error(
                      `Soru ${index + 1} - SeÃ§enek ${i + 1} boÅŸ olamaz!`
                    );
                  }
                  question.options.push(optionText);
                }
              }

              // Update correct answer
              const correctRadio = document.querySelector(
                `input[name="correct_${index}"]:checked`
              );
              if (!correctRadio) {
                throw new Error(
                  `Soru ${index + 1} iÃ§in doÄŸru cevap seÃ§ilmedi!`
                );
              }
              question.correct = parseInt(correctRadio.value);
            } else if (question.type === 'fillblank') {
              // Update word bank
              question.wordBank = [];
              for (let i = 0; i < 5; i++) {
                const wordElement = document.getElementById(
                  `word_${index}_${i}`
                );
                if (wordElement) {
                  const wordText = wordElement.value.trim();
                  if (wordText) {
                    question.wordBank.push(wordText);
                  }
                }
              }

              if (question.wordBank.length === 0) {
                throw new Error(
                  `Soru ${index + 1} iÃ§in en az bir kelime girilmeli!`
                );
              }

              // Update correct answer
              const correctRadio = document.querySelector(
                `input[name="correct_${index}"]:checked`
              );
              if (!correctRadio) {
                throw new Error(
                  `Soru ${index + 1} iÃ§in doÄŸru cevap seÃ§ilmedi!`
                );
              }
              question.correct = correctRadio.value;
            } else if (question.type === 'truefalse') {
              // Update correct answer
              const correctRadio = document.querySelector(
                `input[name="correct_${index}"]:checked`
              );
              if (!correctRadio) {
                throw new Error(
                  `Soru ${index + 1} iÃ§in doÄŸru cevap seÃ§ilmedi!`
                );
              }
              question.correct = correctRadio.value === 'true';
            }
          });

          // Update preview and close modal
          displayTestPreview(currentTest);
          closeEditModal();
          alert('TÃ¼m sorular baÅŸarÄ±yla gÃ¼ncellendi! âœ…');
        } catch (error) {
          alert(error.message);
        }
      }

      function deleteQuestion(index) {
        if (
          confirm(`Soru ${index + 1}'i silmek istediÄŸinizden emin misiniz?`)
        ) {
          currentTest.questions.splice(index, 1);
          closeEditModal();
          editTest(); // Reopen with updated questions
        }
      }

      function closeEditModal() {
        if (window.currentEditModal) {
          document.body.removeChild(window.currentEditModal);
          window.currentEditModal = null;
        }
      }

      function reassignTest(studentName, testId) {
        if (
          confirm(
            `${studentName} adlÄ± Ã¶ÄŸrenciye testi tekrar atamak istediÄŸinizden emin misiniz?`
          )
        ) {
          const studentTestResults = testResults[studentName] || [];
          const testResultIndex = studentTestResults.findIndex(
            (r) => r.testId == testId
          );

          if (testResultIndex !== -1) {
            // Reset the test result to allow retaking
            studentTestResults[testResultIndex].completed = false;
            studentTestResults[testResultIndex].score = null;
            studentTestResults[testResultIndex].answers = {};
            studentTestResults[testResultIndex].details = null;

            alert(
              'Test baÅŸarÄ±yla tekrar atandÄ±! Ã–ÄŸrenci artÄ±k testi yeniden Ã§Ã¶zebilir. âœ…'
            );
            displayResults(); // Refresh the results display
          }
        }
      }

      function deleteTestResult(studentName, testId) {
        const test = tests.find((t) => t.id == testId);
        const testTitle = test ? test.title : 'Bilinmeyen Test';

        if (
          confirm(
            `âš ï¸ TEST SONUCUNU SÄ°LME ONAYI\n\nÃ–ÄŸrenci: ${studentName}\nTest: ${testTitle}\n\nBu iÅŸlem:\nâ€¢ Test atamasÄ±nÄ± tamamen kaldÄ±racak\nâ€¢ Ã–ÄŸrencinin bu teste ait tÃ¼m verilerini silecek\nâ€¢ Bu iÅŸlem GERÄ° ALINAMAZ!\n\nDevam etmek istediÄŸinizden emin misiniz?`
          )
        ) {
          const studentTestResults = testResults[studentName] || [];
          const testResultIndex = studentTestResults.findIndex(
            (r) => r.testId == testId
          );

          if (testResultIndex !== -1) {
            const deletedResult = studentTestResults[testResultIndex];

            // Remove the test result
            studentTestResults.splice(testResultIndex, 1);

            // If no more tests for this student, remove the student entry
            if (studentTestResults.length === 0) {
              delete testResults[studentName];
            }

            // Update student profile if test was completed
            if (deletedResult.completed && studentProfiles[studentName]) {
              const profile = studentProfiles[studentName];

              // Decrease completed tests count
              if (profile.testsCompleted > 0) {
                profile.testsCompleted--;
              }

              // Decrease total points
              if (
                deletedResult.points &&
                profile.totalPoints >= deletedResult.points
              ) {
                profile.totalPoints -= deletedResult.points;
              }

              // Recalculate average stars
              if (
                deletedResult.stars &&
                profile.totalStars >= deletedResult.stars
              ) {
                profile.totalStars -= deletedResult.stars;
                profile.averageStars =
                  profile.testsCompleted > 0
                    ? profile.totalStars / profile.testsCompleted
                    : 0;
              }

              // Decrease high score count if applicable
              if (deletedResult.score >= 80 && profile.testsWithHighScore > 0) {
                profile.testsWithHighScore--;
              }

              // Decrease fast completion count if applicable
              if (
                deletedResult.duration &&
                deletedResult.duration <= 25 * 60 * 1000 &&
                profile.fastCompletions > 0
              ) {
                profile.fastCompletions--;
              }
            }

            // Auto-save data
            saveDataToStorage();

            // Refresh displays
            displayResults();
            updateStats();

            let message = 'âœ… Test sonucu baÅŸarÄ±yla silindi!\n\n';
            message += `ğŸ‘¤ Ã–ÄŸrenci: ${studentName}\n`;
            message += `ğŸ“ Test: ${testTitle}\n`;

            if (deletedResult.completed) {
              message += `ğŸ“Š Silinen puan: ${deletedResult.points || 0}\n`;
              message += `â­ Silinen yÄ±ldÄ±z: ${deletedResult.stars || 0}`;
            } else {
              message += 'ğŸ“‹ Bekleyen test atamasÄ± kaldÄ±rÄ±ldÄ±';
            }

            alert(message);
          } else {
            alert('âŒ Test sonucu bulunamadÄ±!');
          }
        }
      }

      function refreshResults() {
        populateStudentFilter();
        displayResults();
        alert('SonuÃ§lar yenilendi! ğŸ”„');
      }

      function refreshStudentPanel() {
        if (!currentUser) {
          alert('Ã–nce giriÅŸ yapmalÄ±sÄ±nÄ±z!');
          return;
        }

        // Refresh profile and tests display
        displayStudentProfile();
        displayAssignedTests();

        // Show success message with animation
        const refreshBtn = event.target;
        const originalText = refreshBtn.innerHTML;

        refreshBtn.innerHTML = 'âœ… Yenilendi!';
        refreshBtn.classList.remove(
          'bg-white',
          'bg-opacity-20',
          'hover:bg-opacity-30'
        );
        refreshBtn.classList.add('bg-green-500', 'hover:bg-green-600');

        setTimeout(() => {
          refreshBtn.innerHTML = originalText;
          refreshBtn.classList.remove('bg-green-500', 'hover:bg-green-600');
          refreshBtn.classList.add(
            'bg-white',
            'bg-opacity-20',
            'hover:bg-opacity-30'
          );
        }, 2000);

        // Check for new assignments and show stats
        const studentTests = testResults[currentUser] || [];
        const profile = studentProfiles[currentUser] || {};
        const pendingTests = studentTests.filter(
          (test) => !test.completed
        ).length;
        const completedTests = studentTests.filter(
          (test) => test.completed
        ).length;

        let message = 'ğŸ”„ Panel yenilendi!\n\n';
        message += `ğŸ“Š Toplam puanÄ±nÄ±z: ${profile.totalPoints || 0}\n`;
        message += `â­ Ortalama yÄ±ldÄ±zÄ±nÄ±z: ${(
          profile.averageStars || 0
        ).toFixed(1)}\n`;
        message += `ğŸ† Rozet sayÄ±nÄ±z: ${(profile.badges || []).length}\n`;
        message += `ğŸ“‹ Bekleyen testler: ${pendingTests}\n`;
        message += `âœ… Tamamlanan testler: ${completedTests}`;

        if (pendingTests > 0) {
          message +=
            '\n\nğŸ’¡ Bekleyen testlerinizi tamamlayarak daha fazla puan ve rozet kazanabilirsiniz!';
        }

        alert(message);
      }

      function generateSampleTest() {
        // Generate a sample test for demo purposes
        const sampleTest = {
          id: 1,
          title: 'Ã‡alÄ±ÅŸkan Ã‡iftÃ§i Hikayesi',
          text: sampleText,
          textDisplayMode: 'withQuestions', // Default mode
          questions: generateSampleQuestions(sampleText),
        };
        tests.push(sampleTest);

        // Add sample test results
        testResults['Ahmet YÄ±lmaz'] = [
          {
            testId: 1,
            testTitle: 'Ã‡alÄ±ÅŸkan Ã‡iftÃ§i Hikayesi',
            assigned: true,
            completed: false,
            score: null,
          },
        ];

        // Initialize stats
        updateStats();
      }

      // Data management functions
      function showDataManagement() {
        updateDataStatus();
        document
          .getElementById('dataManagementModal')
          .classList.remove('hidden');
      }

      function hideDataManagement() {
        document.getElementById('dataManagementModal').classList.add('hidden');
      }

      function updateDataStatus() {
        document.getElementById('dataStatusStudents').textContent =
          students.length;
        document.getElementById('dataStatusTests').textContent = tests.length;
        document.getElementById('dataStatusResults').textContent =
          Object.keys(testResults).length;
        document.getElementById('dataStatusProfiles').textContent =
          Object.keys(studentProfiles).length;

        // Get last save time from localStorage
        try {
          const savedData = localStorage.getItem('okumaAnlamaTestSistemi');
          if (savedData) {
            const data = JSON.parse(savedData);
            if (data.lastSaved) {
              document.getElementById('lastSaveTime').textContent = new Date(
                data.lastSaved
              ).toLocaleString('tr-TR');
            }
          }
        } catch (error) {
          document.getElementById('lastSaveTime').textContent = 'Hata';
        }
      }

      function manualSave() {
        saveDataToStorage();
        updateDataStatus();

        // Show success feedback
        const button = event.target;
        const originalText = button.innerHTML;

        button.innerHTML = 'âœ… Kaydedildi!';
        button.classList.remove('bg-blue-500', 'hover:bg-blue-600');
        button.classList.add('bg-green-500', 'hover:bg-green-600');

        setTimeout(() => {
          button.innerHTML = originalText;
          button.classList.remove('bg-green-500', 'hover:bg-green-600');
          button.classList.add('bg-blue-500', 'hover:bg-blue-600');
        }, 2000);

        alert(
          'âœ… Veriler baÅŸarÄ±yla kaydedildi!\n\nTÃ¼m bilgileriniz tarayÄ±cÄ± hafÄ±zasÄ±nda gÃ¼venle saklanÄ±yor.'
        );
      }

      // Supabase yapÄ±landÄ±rmasÄ± - Bu deÄŸerleri kendi Supabase bilgilerinizle deÄŸiÅŸtirin
      const SUPABASE_URL = 'https://klbgkxnwnbxqxtvxfshe.supabase.co'; // Ã–rnek: 'https://your-project.supabase.co'
      const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtsYmdreG53bmJ4cXh0dnhmc2hlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY2MzM1ODAsImV4cCI6MjA3MjIwOTU4MH0.nababKyMKhOxgb-zP8R_Ho1GaCBW3fprc1_BKk7H4oE'; // Supabase projenizden alacaÄŸÄ±nÄ±z anon key

      // Supabase client'Ä±nÄ± baÅŸlat (sadece geÃ§erli URL ve key varsa)
      let supabase = null;
      if (SUPABASE_URL !== 'YOUR_SUPABASE_URL_HERE' && SUPABASE_ANON_KEY !== 'YOUR_SUPABASE_ANON_KEY_HERE') {
          supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      }

      // LocalStorage'dan Supabase'e veri taÅŸÄ±ma fonksiyonu
      async function verileriSupabaseeTasi() {
          try {
              console.log('ğŸ”„ LocalStorage verilerini Supabase\'e taÅŸÄ±ma iÅŸlemi baÅŸlatÄ±lÄ±yor...');
              
              // Supabase client kontrolÃ¼
              if (!supabase) {
                  console.log('âš ï¸ Supabase yapÄ±landÄ±rmasÄ± tamamlanmamÄ±ÅŸ. SUPABASE_URL ve SUPABASE_ANON_KEY deÄŸerlerini gÃ¼ncelleyin.');
                  return;
              }
              
              // LocalStorage'dan veriyi al
              const localStorageData = localStorage.getItem('yapilacaklar');
              
              // EÄŸer veri yoksa iÅŸlemi sonlandÄ±r
              if (!localStorageData) {
                  console.log('â„¹ï¸ LocalStorage\'da taÅŸÄ±nacak veri bulunamadÄ±.');
                  return;
              }
              
              // JSON string'ini JavaScript dizisine Ã§evir
              let yapilacaklarDizisi;
              try {
                  yapilacaklarDizisi = JSON.parse(localStorageData);
              } catch (parseError) {
                  console.error('âŒ LocalStorage verisi JSON formatÄ±nda deÄŸil:', parseError);
                  return;
              }
              
              // Dizi kontrolÃ¼
              if (!Array.isArray(yapilacaklarDizisi)) {
                  console.error('âŒ LocalStorage verisi dizi formatÄ±nda deÄŸil');
                  return;
              }
              
              // EÄŸer dizi boÅŸsa iÅŸlemi sonlandÄ±r
              if (yapilacaklarDizisi.length === 0) {
                  console.log('â„¹ï¸ LocalStorage\'da taÅŸÄ±nacak veri dizisi boÅŸ.');
                  return;
              }
              
              console.log(`ğŸ“Š ${yapilacaklarDizisi.length} adet veri Supabase'e aktarÄ±lacak...`);
              
              // Supabase'e veri ekleme iÅŸlemi
              const { data, error } = await supabase
                  .from('tasks')
                  .insert(yapilacaklarDizisi);
              
              // Hata kontrolÃ¼
              if (error) {
                  console.error('âŒ Supabase\'e veri ekleme hatasÄ±:', error);
                  return;
              }
              
              // BaÅŸarÄ±lÄ± iÅŸlem
              console.log('âœ… Veriler baÅŸarÄ±yla Supabase\'e aktarÄ±ldÄ±!');
              console.log('ğŸ“‹ AktarÄ±lan veri sayÄ±sÄ±:', yapilacaklarDizisi.length);
              
              // LocalStorage'Ä± temizle
              localStorage.removeItem('yapilacaklar');
              console.log('ğŸ§¹ LocalStorage temizlendi.');
              
              // KullanÄ±cÄ±ya bilgi ver (isteÄŸe baÄŸlÄ±)
              if (typeof window !== 'undefined' && window.alert) {
                  alert(`âœ… ${yapilacaklarDizisi.length} adet veri baÅŸarÄ±yla Supabase'e aktarÄ±ldÄ± ve LocalStorage temizlendi!`);
              }
              
          } catch (error) {
              console.error('âŒ Veri taÅŸÄ±ma iÅŸleminde beklenmeyen hata:', error);
          }
      }

      // Initialize the application when page loads
      window.onload = function() {
        init(); // Mevcut init fonksiyonunu Ã§alÄ±ÅŸtÄ±r
        verileriSupabaseeTasi(); // Supabase migration fonksiyonunu Ã§alÄ±ÅŸtÄ±r
      };
    </script>
    <script>
      (function () {
        function c() {
          var b = a.contentDocument || a.contentWindow.document;
          if (b) {
            var d = b.createElement('script');
            d.innerHTML =
              "window.__CF$cv$params={r:'9777e10057d9e325',t:'MTc1NjU5NDU2MC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";
            b.getElementsByTagName('head')[0].appendChild(d);
          }
        }
        if (document.body) {
          var a = document.createElement('iframe');
          a.height = 1;
          a.width = 1;
          a.style.position = 'absolute';
          a.style.top = 0;
          a.style.left = 0;
          a.style.border = 'none';
          a.style.visibility = 'hidden';
          document.body.appendChild(a);
          if ('loading' !== document.readyState) c();
          else if (window.addEventListener)
            document.addEventListener('DOMContentLoaded', c);
          else {
            var e = document.onreadystatechange || function () {};
            document.onreadystatechange = function (b) {
              e(b);
              'loading' !== document.readyState &&
                ((document.onreadystatechange = e), c());
            };
          }
        }
      })();
    </script>
  </body>
</html>
